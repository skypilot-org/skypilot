name: batch-inference-compute-text-vectors

workdir: .

resources:
  cpus: 4
  accelerators: {L4, A10G, L40S, A10, A100, H100}

envs:
  MODEL_NAME: "Alibaba-NLP/gte-Qwen2-7B-instruct"
  DATASET_NAME: "McAuley-Lab/Amazon-Reviews-2023"
  DATASET_CONFIG: "raw_review_Books"
  WORKER_ID: ''
  NUM_WORKERS: 10  # Will be overridden by batch launcher script

run: |
  source .venv/bin/activate

  # Create metrics directory for monitoring service
  mkdir -p /output/metrics
  
  # ================================
  # =    Process Text Documents    =
  # ================================
  echo "Processing documents from $START_IDX to $END_IDX"
  
  # Process text documents and track token metrics
  python scripts/text_vector_processor.py \
    --worker-rank $SKYPILOT_JOB_RANK \
    --total-workers $NUM_WORKERS \
    --global-start-idx $GLOBAL_START_IDX \
    --global-end-idx $GLOBAL_END_IDX \
    --output-path "/output/embeddings_${GLOBAL_START_IDX}_${GLOBAL_END_IDX}.parquet" \
    --chunk-size 512 \
    --chunk-overlap 50 \
    --vllm-endpoint http://localhost:8000 \
    --batch-size 32 \
    --model-name $MODEL_NAME \
    --dataset-name $DATASET_NAME \
    --dataset-config $DATASET_CONFIG

  # Print tokens statistics summary from metrics
  echo "Embedding generation complete. Token statistics saved to metrics."
  