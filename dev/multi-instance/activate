# Activate the multi-instance sky wrapper.
# Source this file: source /path/to/skypilot/dev/multi-instance/activate
#
# Run 'deactivate-sky' to undo.

# Prevent double activation
if [[ -n "${_SKY_WRAPPER_ACTIVE:-}" ]]; then
    echo "Sky wrapper already active. Run 'deactivate-sky' first."
    return 0
fi

# Find script directory
_SKY_WRAPPER_DIR="${BASH_SOURCE[0]%/*}"
[[ "$_SKY_WRAPPER_DIR" == "${BASH_SOURCE[0]}" ]] && _SKY_WRAPPER_DIR="."
_SKY_WRAPPER_DIR="$(cd "$_SKY_WRAPPER_DIR" && pwd)"

# Auto-run setup if needed
if ! "$_SKY_WRAPPER_DIR/setup.sh"; then
    return 1
fi

# Save original state
_SKY_ORIG_PS1="${PS1:-}"

# Create aliases
alias sky="$_SKY_WRAPPER_DIR/sky"
alias start-container="$_SKY_WRAPPER_DIR/start-container"
alias stop-container="$_SKY_WRAPPER_DIR/stop-container"

# Modify prompt
PS1="(sky-dev) ${PS1:-}"

# Mark as active
export _SKY_WRAPPER_ACTIVE=1
export _SKY_WRAPPER_DIR

# Deactivate function
deactivate-sky() {
    unalias sky start-container stop-container 2>/dev/null
    PS1="${_SKY_ORIG_PS1:-}"
    unset _SKY_WRAPPER_ACTIVE _SKY_WRAPPER_DIR _SKY_ORIG_PS1
    unset -f deactivate-sky
    echo "Deactivated."
}

echo "Activated. Run 'deactivate-sky' to disable."
