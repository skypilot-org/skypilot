#!/bin/bash
# Wrapper that runs sky commands inside the isolated Docker container.
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

check_docker
load_instance

# Start container if not running
if ! container_running; then
    "$SCRIPT_DIR/start-container"
fi

# Determine TTY flags
DOCKER_FLAGS="-i"
if [[ -t 0 ]] && [[ -t 1 ]]; then
    DOCKER_FLAGS="-it"
fi

# Pass through relevant environment variables by prefix
ENV_ARGS=""
for var in $(compgen -v | grep -E '^(SKYPILOT_|SKY_|AWS_|AZURE_|GOOGLE_|GCP_|OCI_|KUBE|KUBERNETES_|RUNPOD_|HYPERBOLIC_|SEEWEB_|LAMBDA_|DOCKER_|GIT_|HTTP_PROXY|HTTPS_PROXY|NO_PROXY|RAY_|HELM_)'); do
    ENV_ARGS="$ENV_ARGS -e $var=${!var}"
done

exec docker exec $DOCKER_FLAGS $ENV_ARGS "$CONTAINER_NAME" \
    /opt/skypilot-venv/bin/sky "$@"
