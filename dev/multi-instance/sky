#!/bin/bash
# Wrapper that runs sky commands inside the isolated Docker container.
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

check_docker
load_instance

# Start container if not running
if ! container_running; then
    echo "Container not running. Starting it..."
    "$SCRIPT_DIR/start-container"
fi

# Determine TTY flags
DOCKER_FLAGS="-i"
if [[ -t 0 ]] && [[ -t 1 ]]; then
    DOCKER_FLAGS="-it"
fi

# Pass through relevant environment variables
ENV_ARGS=""
for var in SKYPILOT_DEV SKYPILOT_DEBUG \
           AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_PROFILE AWS_DEFAULT_REGION \
           GOOGLE_APPLICATION_CREDENTIALS \
           AZURE_SUBSCRIPTION_ID \
           KUBECONFIG; do
    if [[ -n "${!var:-}" ]]; then
        ENV_ARGS="$ENV_ARGS -e $var=${!var}"
    fi
done

exec docker exec $DOCKER_FLAGS $ENV_ARGS \
    -w /app \
    "$CONTAINER_NAME" \
    /opt/skypilot-venv/bin/sky "$@"
