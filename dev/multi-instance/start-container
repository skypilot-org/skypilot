#!/bin/bash
# Start (or create) the isolated SkyPilot development container.
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

check_docker
load_instance

# Create container if it doesn't exist
if ! container_exists; then
    echo "Creating container: $CONTAINER_NAME"

    # Build credential mount options
    CRED_MOUNTS=""
    for cred_dir in .aws .azure .config/gcloud .kube .ssh; do
        if [[ -e "$HOME/$cred_dir" ]]; then
            CRED_MOUNTS="$CRED_MOUNTS -v $HOME/$cred_dir:/root/$cred_dir:ro"
        fi
    done

    docker create \
        --name "$CONTAINER_NAME" \
        --hostname "skypilot-dev" \
        -it \
        -p "${PORT}:46580" \
        -v "$REPO_ROOT:/app" \
        -v "$INSTANCE_DIR/state:/root/.sky" \
        -v "$INSTANCE_DIR/sky_logs:/root/sky_logs" \
        -w /app \
        $CRED_MOUNTS \
        "ubuntu:22.04" \
        sleep infinity
fi

# Start container if not running
if ! container_running; then
    echo "Starting container: $CONTAINER_NAME"
    docker start "$CONTAINER_NAME"
else
    echo "Container already running: $CONTAINER_NAME"
fi

# Setup venv inside container (idempotent)
echo "Ensuring venv is set up..."
docker exec "$CONTAINER_NAME" bash -c '
    set -e

    # Install system deps if needed
    if ! command -v python3 &>/dev/null; then
        apt-get update -qq
        apt-get install -y -qq python3 python3-pip python3-venv git curl >/dev/null
    fi

    # Create venv if needed (inside container, not in mounted repo)
    if [[ ! -d /opt/skypilot-venv ]]; then
        echo "Creating venv at /opt/skypilot-venv..."
        python3 -m venv /opt/skypilot-venv
    fi

    # Install skypilot in dev mode if needed
    source /opt/skypilot-venv/bin/activate
    if ! pip show skypilot &>/dev/null; then
        echo "Installing skypilot in dev mode..."
        pip install -q -e /app
    fi

    echo "Ready."
'

echo ""
echo "Container ready: $CONTAINER_NAME"
echo "  Port: localhost:$PORT -> container:46580"
echo "  Repo: $REPO_ROOT -> /app"
