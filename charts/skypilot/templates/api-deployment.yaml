apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-api-server
  namespace: {{ .Release.Namespace }}
spec:
  # Note: replicas > 1 is not well tested.
  replicas: {{ .Values.apiService.replicas }}
  {{- if eq .Values.apiService.upgradeStrategy "RollingUpdate" }}
  {{- if and (not .Values.apiService.dbConnectionSecretName) (not .Values.apiService.dbConnectionString) }}
  {{- fail "External database must be configured via .apiService.dbConnectionSecretName or .apiService.dbConnectionString when using RollingUpdate strategy" }}
  {{- end }}
  {{- if .Values.storage.enabled }}
  {{- fail "Local storage is not supported when using RollingUpdate strategy. Use recreate upgrade strategy or set storage.enabled to false." }}
  {{- end }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  {{- else }}
  strategy:
    type: Recreate
  {{- end }}
  selector:
    matchLabels:
      app: {{ .Release.Name }}-api
  template:
    metadata:
      annotations:
        {{- if .Values.apiService.metrics.enabled }}
        {{- if .Values.prometheus.useDedicatedScrapeConfig }}
        skypilot.co/scrape: "true"
        skypilot.co/path: "/metrics"
        skypilot.co/port: {{ .Values.apiService.metrics.port | quote }}
        {{- else}}
        # Well-known annotations for Prometheus to scrape the metrics.
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/port: {{ .Values.apiService.metrics.port | quote }}
        {{- end }}
        {{- end }}
        {{- if .Values.apiService.annotations }}
        {{- toYaml .Values.apiService.annotations | nindent 8 }}
        {{- end }}
      labels:
        app: {{ .Release.Name }}-api
        # This label indicates that the API server is ready to serve requests.
        skypilot.co/ready: "true"
    spec:
      automountServiceAccountToken: {{ .Values.kubernetesCredentials.useApiServerCluster }}
      serviceAccountName: {{ include "skypilot.serviceAccountName" . }}
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      runtimeClassName: {{ .Values.runtimeClassName }}
      terminationGracePeriodSeconds: {{ .Values.apiService.terminationGracePeriodSeconds }}
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: skypilot-api
        image: {{ include "common.image" (dict "root" . "image" .Values.apiService.image) }}
        imagePullPolicy: {{ .Values.apiService.imagePullPolicy }}
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        resources:
          {{- toYaml .Values.apiService.resources | nindent 10 }}
        env:
        {{- with $.Values.global.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with .Values.apiService.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        - name: SKYPILOT_DEV
          value: {{ .Values.apiService.skypilotDev | quote }}
        - name: SKYPILOT_RELEASE_NAME
          value: {{ .Release.Name | quote }}
        {{- if include "skypilot.enableBasicAuthInAPIServer" . | trim | eq "true" }}
        - name: SKYPILOT_INITIAL_BASIC_AUTH
          valueFrom:
            secretKeyRef:
              name: {{ include "skypilot.initialBasicAuthSecretName" . }}
              key: auth
        {{- end }}
        {{- if include "skypilot.serviceAccountAuthEnabled" . | trim | eq "true" }}
        - name: ENABLE_SERVICE_ACCOUNTS
          value: "true"
        {{- end }}
        {{- if include "skypilot.ingressBasicAuthEnabled" . | trim | eq "true" }}
        - name: SKYPILOT_INGRESS_BASIC_AUTH_ENABLED
          value: "true"
        {{- end }}
        {{- if .Values.gcpCredentials.enabled }}
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /root/gcp-cred.json
        {{- end }}
        {{- if .Values.kubernetesCredentials.inclusterNamespace }}
        - name: SKYPILOT_IN_CLUSTER_NAMESPACE
          value: {{ .Values.kubernetesCredentials.inclusterNamespace }}
        {{- end }}
        {{- if and .Values.kubernetesCredentials.useKubeconfig .Values.apiService.sshNodePools }}
        - name: KUBECONFIG
          value: /root/.kube/config:/var/skypilot/kubeconfig/config
        {{- end }}
        {{- if .Values.apiService.dbConnectionSecretName }}
        - name: SKYPILOT_DB_CONNECTION_URI
          valueFrom:
            secretKeyRef:
              name: {{ .Values.apiService.dbConnectionSecretName }}
              key: connection_string
        {{- else if .Values.apiService.dbConnectionString }}
        - name: SKYPILOT_DB_CONNECTION_URI
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-db-connection
              key: connection_string
        {{- end }}
        {{- if .Values.apiService.authUserHeaderName }}
        - name: SKYPILOT_AUTH_USER_HEADER
          value: {{ .Values.apiService.authUserHeaderName | quote }}
        {{- end }}
        - name: SKYPILOT_GRACE_PERIOD_SECONDS
          value: {{ .Values.apiService.terminationGracePeriodSeconds | quote}}
        {{- if eq .Values.apiService.upgradeStrategy "RollingUpdate" }}
        - name: SKYPILOT_APISERVER_UUID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        {{- end }}
        {{- if .Values.apiService.metrics.enabled }}
        - name: SKY_API_SERVER_METRICS_ENABLED
          value: "true"
        {{- end }}
        {{- if .Values.auth.oauth.enabled }}
        - name: SKYPILOT_AUTH_OAUTH2_PROXY_ENABLED
          value: "true"
        - name: SKYPILOT_AUTH_OAUTH2_PROXY_BASE_URL
          value: {{ include "skypilot.oauth2ProxyURL" . }}
        {{- end }}
        - name: SKYPILOT_POD_CPU_CORE_LIMIT
          valueFrom:
            resourceFieldRef:
              containerName: skypilot-api
              resource: requests.cpu
        - name: SKYPILOT_POD_MEMORY_BYTES_LIMIT
          valueFrom:
            resourceFieldRef:
              containerName: skypilot-api
              resource: requests.memory
        # Use tini as the init process
        command: ["tini", "--"]
        # Start API server in foreground (if supported) to:
        # 1. Bypass the healthz check of `sky api start`, let kubernetes probes manage the lifecycle directly.
        # 2. Capture all logs in container to stdout/stderr, bypass in-container log file overhead.
        # 3. Exec ensures the process is a direct child of tini, enables correct signal handling.
        # Note: this comment is moved here to avoid appearing in the final start script.
        args:
        - /bin/sh
        - -c
        - |
          set -e
          {{- if .Values.apiService.preDeployHook }}
          {{ .Values.apiService.preDeployHook | nindent 10 }}
          {{- end }}
          mkdir -p /root/.sky
          # When the config.yaml is a symlink, it should be from the old API
          # server code. We remove the symlink and copy the ConfigMap config to
          # PVC location for backward compatibility.
          # TODO(zhwu): remove this after 0.12.0.
          if [ -L /root/.sky/config.yaml ]; then
            echo "Config.yaml is a symlink to ConfigMap config, deleting symlink"
            rm /root/.sky/config.yaml
          fi
          # Initialize the SkyPilot config.
          if [ -s /root/.sky/config.yaml ]; then
            # If the config.yaml is not empty, sync the PVC config to ConfigMap
            python3 -c "from sky.utils.kubernetes import config_map_utils; config_map_utils.initialize_configmap_sync_on_startup('~/.sky/config.yaml')"
          else
            # If the config.yaml is empty, we initialize the config on PVC with
            # user specified config.
            cp /var/skypilot/config/config.yaml /root/.sky/config.yaml
          fi
          {{- if .Values.apiService.sshNodePools }}
          mkdir -p /root/.sky
          echo "Linking ssh_node_pools.yaml from secret to /root/.sky/ssh_node_pools.yaml"
          # The secret serves as the ground truth for the ssh_node_pools.yaml file, read-only
          ln -sf /var/skypilot/ssh_node_pool/ssh_node_pools.yaml /root/.sky/ssh_node_pools.yaml
          # ~/.kube/config is required to be persistent when sshNodePools is enabled, init it if it is empty to avoid parsing error.
          if [ ! -s /root/.kube/config ]; then
            echo "{}" > /root/.kube/config
          fi
          {{- end }}
          # Nebius credentials mounting
          # Since the ~/.nebius directory is also used by the Nebius CLI, we mount the credentials to /root/.nebius_credentials
          # and create a symlink to /root/.nebius. This cannot be done in the init container because the Nebius CLI needs read-write access to ~/.nebius.
          {{- if .Values.nebiusCredentials.enabled }}
          echo "Setting up Nebius credentials..."
          mkdir -p /root/.nebius
          # Link all files from .nebius_credentials to .nebius
          # In workspace, it is possible to use multiple credentials files. We need to link all of them to .nebius
          for file in /root/.nebius_credentials/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              ln -sf "$file" "/root/.nebius/$filename"
            fi
          done
          echo "{{ .Values.nebiusCredentials.tenantId }}" >> /root/.nebius/NEBIUS_TENANT_ID.txt
          # Create a Nebius profile for the nebius CLI to use as default
          nebius profile create --profile sky --endpoint api.nebius.cloud --service-account-file /root/.nebius/credentials.json || echo "Unable to create Nebius profile."
          {{- end }}
          {{- if .Values.apiService.sshKeySecret }}
          mkdir -p /root/.ssh
          echo "Linking ssh keys to /root/.ssh"
          for file in /var/skypilot/ssh_keys/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              ln -sf "$file" "/root/.ssh/$filename"
            fi
          done
          {{- end }}

          mkdir -p /root/.sky/api_server
          exec sky api start {{ include "skypilot.apiArgs" . }} --foreground  2>&1 | tee -a /root/.sky/api_server/server.log
        ports:
        - containerPort: 46580
        livenessProbe:
          httpGet:
            path: /api/health
            port: 46580
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /api/health
            port: 46580
          {{- if eq .Values.apiService.upgradeStrategy "RollingUpdate" }}
          # When using RollingUpdate strategy, be more patient with the new
          # API server to avoid flaky serving where one of the server process
          # returns ready of the healthz check endpoint while others may still
          # be starting up.
          successThreshold: 3
          {{- else }}
          # For fast startup, just serve when healthz check passes. There is no
          # other replica to serve requests anyway.
          successThreshold: 1
          {{- end }}
          failureThreshold: 3
          periodSeconds: 5
          initialDelaySeconds: 5
        volumeMounts:
        - name: state-volume
          mountPath: /root/.sky
          subPath: .sky
        {{- if .Values.storage.enabled }}
        - name: state-volume
          mountPath: /root/.ssh # To preserve the SSH keys for the user when using the API server
          subPath: .ssh
        {{- end }}
        - name: skypilot-config
          mountPath: /var/skypilot/config
        {{- if .Values.apiService.sshNodePools }}
        - name: skypilot-ssh-node-pools
          mountPath: /var/skypilot/ssh_node_pool
        {{- end }}
        {{- if .Values.apiService.sshKeySecret }}
        - name: skypilot-ssh-identity
          mountPath: /var/skypilot/ssh_keys
        {{- end }}
        {{- if .Values.awsCredentials.enabled }}
        {{- if .Values.awsCredentials.useCredentialsFile }}
        # Mount the credentials file directly from secret
        - name: aws-credentials-file
          mountPath: /root/.aws/credentials
          subPath: credentials
          readOnly: true
        {{- else }}
        # Mount emptyDir that will be populated by initContainer
        - name: aws-config
          mountPath: /root/.aws
          readOnly: true
        {{- end }}
        {{- end }}
        {{- if .Values.r2Credentials.enabled }}
        - name: r2-config
          mountPath: /root/.cloudflare
          readOnly: true
        {{- end }}
        {{- if .Values.coreweaveCredentials.enabled }}
        - name: coreweave-config
          mountPath: /root/.coreweave
          readOnly: true
        {{- end }}
        {{- if .Values.gcpCredentials.enabled }}
        - name: gcp-config
          mountPath: /root/.config/gcloud
        - name: gcp-credentials
          mountPath: /root/gcp-cred.json
          subPath: gcp-cred.json
        {{- end }}
        {{- if .Values.kubernetesCredentials.useKubeconfig }}
        {{- if .Values.apiService.sshNodePools }}
        - name: kube-config
          mountPath: /var/skypilot/kubeconfig
        {{- else }}
        - name: kube-config
          mountPath: /root/.kube
        {{- end }}
        {{- end }}
        {{- if .Values.apiService.sshNodePools }}
        - name: state-volume
          mountPath: /root/.kube
          subPath: .kube
        {{- end }}
        {{- if .Values.runpodCredentials.enabled }}
        - name: runpod-config
          mountPath: /root/.runpod
          readOnly: true
        {{- end }}
        {{- if .Values.digitaloceanCredentials.enabled }}
        - name: digitalocean-config
          mountPath: /root/.config/doctl
          readOnly: true
        {{- end }}
        {{- if .Values.lambdaCredentials.enabled }}
        - name: lambda-config
          mountPath: /root/.lambda_cloud
          readOnly: true
        {{- end }}
        {{- if .Values.vastCredentials.enabled }}
        - name: vast-config
          mountPath: /root/.config/vastai
          readOnly: true
        {{- end }}
        {{- if .Values.nebiusCredentials.enabled }}
        - name: nebius-credentials
          mountPath: /root/.nebius_credentials
        {{- end }}
        {{- if .Values.apiService.extraVolumeMounts }}
        {{- toYaml .Values.apiService.extraVolumeMounts | nindent 8 }}
        {{- end }}
      {{- if .Values.apiService.logs.retention.enabled }}
      - name: logrotate
        image: {{ include "common.image" (dict "root" . "image" .Values.apiService.image) }}
        command: ["/bin/sh", "-c"]
        # Warn if logrotate is missing in the image and keep the sidecar running
        args:
        - |
          if ! command -v logrotate >/dev/null 2>&1; then
            echo "warning: logrotate not found; skipping log retention" >&2
            while true; do
              sleep 3600
            done
          fi
          set -x
          cat > /etc/logrotate.conf <<EOF
          /root/.sky/api_server/server.log {
              size {{ .Values.apiService.logs.retention.size }}
              rotate 1
              missingok
              notifempty
              copytruncate
          }
          EOF
          while true; do
            logrotate -s /var/lib/logrotate/status /etc/logrotate.conf
            sleep 60;
          done
        volumeMounts:
        - name: state-volume
          mountPath: /root/.sky
          subPath: .sky
      {{- end }}
      initContainers:
      {{- if and .Values.awsCredentials.enabled (not .Values.awsCredentials.useCredentialsFile) }}
      - name: create-aws-credentials
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: {{ include "common.image" (dict "root" . "image" .Values.apiService.image) }}
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Setting up AWS credentials..."
          if [ -n "$AWS_ACCESS_KEY_ID" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "AWS credentials found in environment variables."
            aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
            aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
            echo "Credentials file created successfully."
          else
            echo "AWS credentials not found in environment variables. Skipping credentials setup."
            echo "Sleeping for 10 minutes before exiting for debugging purposes."
            sleep 600
          fi
        env:
        {{- with $.Values.global.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: {{ .Values.awsCredentials.awsSecretName }}
              key: {{ .Values.awsCredentials.accessKeyIdKeyName }}
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.awsCredentials.awsSecretName }}
              key: {{ .Values.awsCredentials.secretAccessKeyKeyName }}
        volumeMounts:
        - name: aws-config
          mountPath: /root/.aws
      {{- end }}
      {{- if .Values.r2Credentials.enabled }}
      - name: setup-r2-credentials
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: {{ include "common.image" (dict "root" . "image" .Values.apiService.image) }}
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -e
          echo "Setting up R2 credentials..."
          mkdir -p /root/.cloudflare

          # Direct echo of environment variables (no quotes around EOF)
          cat > /root/.cloudflare/r2.credentials <<EOF
          $R2_CREDENTIALS
          EOF

          cat > /root/.cloudflare/accountid <<EOF
          $R2_ACCOUNT_ID
          EOF

          chmod 600 /root/.cloudflare/r2.credentials
          chmod 600 /root/.cloudflare/accountid

          echo "R2 credentials setup complete:"
          ls -la /root/.cloudflare/
          echo "First line of r2.credentials:"
          head -n 1 /root/.cloudflare/r2.credentials
          echo "Account ID:"
          cat /root/.cloudflare/accountid
        env:
        {{- with $.Values.global.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        - name: R2_CREDENTIALS
          valueFrom:
            secretKeyRef:
              name: {{ .Values.r2Credentials.r2SecretName }}
              key: r2.credentials
        - name: R2_ACCOUNT_ID
          valueFrom:
            secretKeyRef:
              name: {{ .Values.r2Credentials.r2SecretName }}
              key: accountid
        volumeMounts:
        - name: r2-config
          mountPath: /root/.cloudflare
      {{- end }}
      {{- if .Values.gcpCredentials.enabled }}
      - name: setup-gcp-credentials
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: {{ include "common.image" (dict "root" . "image" .Values.gcpCredentials.image) }}
        command: ["/bin/sh", "-c"]
        env:
        {{- with $.Values.global.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /root/gcp-cred.json
        args:
        - |
          gcloud auth activate-service-account --key-file=/root/gcp-cred.json
          gcloud config set project {{ .Values.gcpCredentials.projectId }}
        volumeMounts:
        - name: gcp-credentials
          mountPath: /root/gcp-cred.json
          subPath: gcp-cred.json
        - name: gcp-config
          mountPath: /root/.config/gcloud
      {{- end }}
      {{- if .Values.coreweaveCredentials.enabled }}
      - name: setup-coreweave-credentials
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: {{ include "common.image" (dict "root" . "image" .Values.apiService.image) }}
        command: ["/bin/sh", "-c"]
        {{- if $.Values.global.extraEnvs }}
        env:
        {{- with $.Values.global.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- end }}
        args:
        - |
          cp /root/.coreweave_credentials/* /root/.coreweave/
        volumeMounts:
        - name: coreweave-credentials
          mountPath: /root/.coreweave_credentials
        - name: coreweave-config
          mountPath: /root/.coreweave
      {{- end }}
      {{- if .Values.runpodCredentials.enabled }}
      - name: create-runpod-credentials
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: {{ include "common.image" (dict "root" . "image" .Values.apiService.image) }}
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Setting up RunPod credentials..."
          if [ -n "$RUNPOD_API_KEY" ]; then
            echo "RunPod credentials found in environment variable."
            mkdir -p /root/.runpod
            echo "[default]" > /root/.runpod/config.toml
            echo "api_key = \"$RUNPOD_API_KEY\"" >> /root/.runpod/config.toml
          else
            echo "RunPod credentials not found in environment variables. Skipping credentials setup."
            echo "Sleeping for 10 minutes before exiting for debugging purposes."
            sleep 600
          fi
        env:
        {{- with $.Values.global.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        - name: RUNPOD_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.runpodCredentials.runpodSecretName }}
              key: api_key
        volumeMounts:
        - name: runpod-config
          mountPath: /root/.runpod
      {{- end }}
      {{- if .Values.digitaloceanCredentials.enabled }}
      - name: create-digitalocean-credentials
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: {{ .Values.apiService.image }}
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Setting up Digital Ocean credentials..."
          if [ -n "$DIGITALOCEAN_CREDENTIALS" ]; then
            echo "Digital Ocean credentials found in environment variable."
            mkdir -p /.config/doctl
            cat > /.config/doctl/config.yaml <<EOF
          access-token: $DIGITALOCEAN_CREDENTIALS
          EOF
          else
            echo "Digital Ocean credentials not found in environment variables. Skipping credentials setup."
            echo "Sleeping for 10 minutes before exiting for debugging purposes."
            sleep 600
          fi
        env:
        - name: DIGITALOCEAN_CREDENTIALS
          valueFrom:
            secretKeyRef:
              name: {{ .Values.digitaloceanCredentials.digitaloceanSecretName }}
              key: api_key
        volumeMounts:
        - name: digitalocean-config
          mountPath: /.config/doctl
      {{- end }}
      {{- if .Values.lambdaCredentials.enabled }}
      - name: create-lambda-credentials
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: {{ include "common.image" (dict "root" . "image" .Values.apiService.image) }}
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Setting up Lambda credentials..."
          if [ -n "$LAMBDA_API_KEY" ]; then
            echo "Lambda credentials found in environment variable."
            mkdir -p /root/.lambda_cloud
            echo "api_key = $LAMBDA_API_KEY" > /root/.lambda_cloud/lambda_keys
          else
            echo "Lambda credentials not found in environment variables. Skipping credentials setup."
            echo "Sleeping for 10 minutes before exiting for debugging purposes."
            sleep 600
          fi
        env:
        {{- with $.Values.global.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        - name: LAMBDA_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.lambdaCredentials.lambdaSecretName }}
              key: api_key
        volumeMounts:
        - name: lambda-config
          mountPath: /root/.lambda_cloud
      {{- end }}
      {{- if .Values.vastCredentials.enabled }}
      - name: create-vast-credentials
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: {{ include "common.image" (dict "root" . "image" .Values.apiService.image) }}
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Setting up Vast credentials..."
          if [ -n "$VAST_API_KEY" ]; then
            echo "Vast credentials found in environment variable."
            mkdir -p /root/.config/vastai
            echo "$VAST_API_KEY" > /root/.config/vastai/vast_api_key
          else
            echo "Vast credentials not found in environment variables. Skipping credentials setup."
            echo "Sleeping for 10 minutes before exiting for debugging purposes."
            sleep 600
          fi
        env:
        {{- with $.Values.global.extraEnvs }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        - name: VAST_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.vastCredentials.vastSecretName }}
              key: api_key
        volumeMounts:
        - name: vast-config
          mountPath: /root/.config/vastai
      {{- end }}
      {{- if .Values.extraInitContainers }}
      {{- toYaml .Values.extraInitContainers | nindent 6 }}
      {{- end }}

      volumes:
      {{- if .Values.storage.enabled }}
      - name: state-volume
        persistentVolumeClaim:
          claimName: {{ .Release.Name }}-state
      {{- else }}
      - name: state-volume
        emptyDir: {}
      {{- end }}
      {{- if .Values.awsCredentials.enabled }}
      {{- if .Values.awsCredentials.useCredentialsFile }}
      # Mount the credentials file directly from secret
      - name: aws-credentials-file
        secret:
          secretName: {{ .Values.awsCredentials.awsSecretName }}
      {{- else }}
      # Mount emptyDir that will be populated by initContainer
      - name: aws-config
        emptyDir: {}
      {{- end }}
      {{- end }}
      {{- if .Values.gcpCredentials.enabled }}
      - name: gcp-credentials
        secret:
          secretName: {{ .Values.gcpCredentials.gcpSecretName }}
      - name: gcp-config
        emptyDir: {}
      {{- end }}
      {{- if .Values.coreweaveCredentials.enabled }}
      - name: coreweave-credentials
        secret:
          secretName: {{ .Values.coreweaveCredentials.coreweaveSecretName }}
      - name: coreweave-config
        emptyDir: {}
      {{- end }}
      {{- if .Values.runpodCredentials.enabled }}
      - name: runpod-config
        emptyDir: {}
      {{- end }}
      {{- if .Values.digitaloceanCredentials.enabled }}
      - name: digitalocean-config
        emptyDir: {}
      {{- end }}
      {{- if .Values.lambdaCredentials.enabled }}
      - name: lambda-config
        emptyDir: {}
      {{- end }}
      {{- if .Values.vastCredentials.enabled }}
      - name: vast-config
        emptyDir: {}
      {{- end }}
      {{- if .Values.nebiusCredentials.enabled }}
      - name: nebius-credentials
        secret:
          secretName: {{ .Values.nebiusCredentials.nebiusSecretName }}
      {{- end }}
      {{- if .Values.kubernetesCredentials.useKubeconfig }}
      - name: kube-config
        secret:
          secretName: {{ .Values.kubernetesCredentials.kubeconfigSecretName }}
      {{- end }}
      - name: skypilot-config
        configMap:
          name: {{ .Release.Name }}-config
      {{- if .Values.apiService.sshNodePools }}
      - name: skypilot-ssh-node-pools
        secret:
          secretName: {{ .Release.Name }}-ssh-node-pools
      {{- end }}
      {{- if .Values.apiService.sshKeySecret }}
      - name: skypilot-ssh-identity
        secret:
          secretName: {{ .Values.apiService.sshKeySecret }}
          defaultMode: 0600
      {{- end }}
      {{- if .Values.apiService.extraVolumes }}
      {{- toYaml .Values.apiService.extraVolumes | nindent 6 }}
      {{- end }}
      {{- if .Values.r2Credentials.enabled }}
      - name: r2-config
        emptyDir: {}
      {{- end }}
      {{- with .Values.apiService.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.apiService.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.apiService.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
