{{- $externalProxyEnabled := .Values.auth.externalProxy.enabled -}}
{{- $ingressOAuthEnabled := include "skypilot.ingressOAuthEnabled" . | trim | eq "true" -}}
{{- if or $externalProxyEnabled $ingressOAuthEnabled -}}
{{- $fullName := include "skypilot.fullname" . -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-server-config
  namespace: {{ .Release.Namespace }}
data:
  server.yaml: |-
    auth:
      external_proxy:
        {{- if $externalProxyEnabled }}
        enabled: true
        header_name: {{ .Values.auth.externalProxy.headerName | quote }}
        header_format: {{ .Values.auth.externalProxy.headerFormat | quote }}
        jwt_identity_claim: {{ .Values.auth.externalProxy.jwtIdentityClaim | quote }}
        {{- else }}
        # Enabled for ingress.oauth2-proxy compatibility
        enabled: true
        header_name: "X-Auth-Request-Email"
        header_format: "plaintext"
        jwt_identity_claim: "sub"
        {{- end }}
{{- end }}
