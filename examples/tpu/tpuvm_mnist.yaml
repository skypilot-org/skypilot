name: tpuvm_mnist

resources:
  accelerators: tpu-v2-8

# The setup command.  Will be run under the working directory.
setup: |
  git clone https://github.com/google/flax.git --branch v0.10.1

  if [ ! -d ~/flax-venv ]; then
    uv venv ~/flax-venv --python 3.10
    source ~/flax-venv/bin/activate
    # Make sure to install TPU related packages in a venv to avoid package conflicts.
    uv pip install --prerelease=allow \
      -f https://storage.googleapis.com/jax-releases/libtpu_releases.html -f https://storage.googleapis.com/jax-releases/jax_releases.html "jax[tpu]==0.4.35" \
      clu \
      tensorflow tensorflow-datasets
    uv pip install -e flax
    uv pip install --upgrade tensorflow-datasets
    uv pip install --upgrade protobuf
  else
    source ~/flax-venv/bin/activate
  fi


# The command to run.  Will be run under the working directory.
run: |
  source ~/flax-venv/bin/activate
  cd flax/examples/mnist
  python3 main.py --workdir=/tmp/mnist \
    --config=configs/default.py \
    --config.learning_rate=0.05 \
    --config.num_epochs=10
