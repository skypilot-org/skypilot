name: storage-demo

resources:
  cloud: aws
  instance_type: m5.2xlarge

num_nodes: 1

file_mounts:
  /sharedfs:
    name: romil-fs
    source: ~/tmp # Empty dir for MVP, this will not be required if mode==MOUNT
    persistent: True
    mode: 'MOUNT'

setup: |
  # Installing fio for benchmarking. Killing apt process to avoid lock issues
  sudo kill -9 `sudo lsof /var/lib/dpkg/lock-frontend | awk '{print $2}' | tail -n 1`;
  sudo pkill -9 apt-get;
  sudo pkill -9 dpkg;
  sudo apt-get install fio -y

run: |
  echo This is hostname: $(hostname)
  
  # Run read benchmark
  fio --name=sequential-read --rw=read --refill_buffers --bs=4M --size=4G --filename=/sharedfs/$(hostname)_read.fio 2>&1 | tee $(hostname)_readbench.txt
  
  # Run example write
  echo My hostname: $(hostname) > /sharedfs/$(hostname).txt
  
  # ls and exit
  ls -la /sharedfs
