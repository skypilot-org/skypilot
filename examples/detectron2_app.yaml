name: detectron2-app

resources:
  accelerators: V100

setup: |
  pip install --upgrade pip

  if [ ! -d ~/d2 ]; then
    uv venv ~/d2 --python 3.8
    source ~/d2/bin/activate
    pip install torch torchvision
    git clone https://github.com/facebookresearch/detectron2
    cd detectron2
    pip install -e .
  else
    source ~/d2/bin/activate
  fi

  cd tools
  mkdir -p datasets/coco
  cd datasets/coco

  wget http://images.cocodataset.org/zips/train2017.zip
  wget http://images.cocodataset.org/zips/val2017.zip

  unzip train2017.zip
  unzip val2017.zip

  rm train2017.zip
  rm val2017.zip

  wget http://images.cocodataset.org/annotations/annotations_trainval2017.zip
  wget http://images.cocodataset.org/annotations/stuff_annotations_trainval2017.zip

  unzip annotations_trainval2017.zip
  unzip stuff_annotations_trainval2017.zip

  rm annotations_trainval2017.zip
  rm stuff_annotations_trainval2017.zip

run: |
  source ~/d2/bin/activate
  
  cd detectron2/tools
  python train_net.py --config-file ../configs/COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_1x.yaml --num-gpus 1 SOLVER.IMS_PER_BATCH 2 SOLVER.BASE_LR 0.0025 SOLVER.MAX_ITER 100
