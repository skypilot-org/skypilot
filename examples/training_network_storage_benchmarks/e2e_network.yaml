# sky launch e2e_network.yaml -c e2e_network --env HF_TOKEN="YOUR TOKEN"

envs:
  MODEL_ID: openai/gpt-oss-120b  # Default model ID

resources:
  infra: k8s
  accelerators: H100:8
  network_tier: best # Comment out to disable/enable

file_mounts:
  /e2e: ./e2e

num_nodes: 2

setup: |
  conda install cuda -c nvidia
  uv venv ~/training --seed --python 3.10
  source ~/training/bin/activate
  sudo DEBIAN_FRONTEND=noninteractive apt install -y vmtouch
  sudo DEBIAN_FRONTEND=noninteractive apt install -y python3-dev python3.10-dev build-essential

  uv pip install torch --index-url https://download.pytorch.org/whl/cu128
  uv pip install "trl>=0.20.0" "peft>=0.17.0" "transformers>=4.55.0"
  uv pip install deepspeed
  uv pip install git+https://github.com/huggingface/accelerate.git@c0a3aefea8aa5008a0fbf55b049bd3f0efa9cbf2

  # Other tools
  sudo DEBIAN_FRONTEND=noninteractive apt install -y htop sysstat iproute2 net-tools infiniband-diags vim
  uv pip install nvitop

run: |
  source ~/training/bin/activate

  MASTER_ADDR=$(echo "$SKYPILOT_NODE_IPS" | head -n1)
  NP=$(($SKYPILOT_NUM_GPUS_PER_NODE * $SKYPILOT_NUM_NODES))

  accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES \
    --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR \
    --main_process_port 29500 /e2e/e2e_network.py --model_id ${MODEL_ID} --per_device_train_batch_size 4
