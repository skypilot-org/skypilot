name: resnet-app

resources:
  infra: aws
  accelerators:
    V100: 1

inputs: {
  gs://cloud-tpu-test-dataset/fake_imagenet: 70,
}

outputs: {
  resnet-model-dir: 0.1,
}

# file_mounts: {
#   /tmp/fake_imagenet: gs://cloud-tpu-test-datasets/fake_imagenet,
# }

setup: |
  git clone https://github.com/concretevitamin/tpu || true
  cd tpu
  git checkout 9459fee


  uv venv ~/resnet --python 3.7 --seed
  source ~/resnet/bin/activate
  uv pip install nvidia-cudnn-cu11
  uv pip install tensorflow==2.4.0 pyyaml
  uv pip install protobuf==3.20

  cd models
  uv pip install -e .

run: |
  cd tpu
  source ~/resnet/bin/activate
  # Set CUDNN library path
  CUDNN_PATH=$(dirname $(python -c "import nvidia.cudnn;print(nvidia.cudnn.__file__)"))
  export LD_LIBRARY_PATH=$CUDNN_PATH/lib:$LD_LIBRARY_PATH

  export XLA_FLAGS='--xla_gpu_cuda_data_dir=/usr/local/cuda/'
  python -u models/official/resnet/resnet_main.py --use_tpu=False \
      --mode=train --train_batch_size=256 --train_steps=250 \
      --iterations_per_loop=125 \
      --data_dir=gs://cloud-tpu-test-datasets/fake_imagenet \
      --model_dir=resnet-model-dir \
      --amp --xla --loss_scale=128
