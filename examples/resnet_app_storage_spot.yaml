name: resnet-app-storage

resources:
  infra: aws
  accelerators: V100
  use_spot: true
  spot_recovery: failover

file_mounts:
  /tmp/imagenet:
    # A public s3 bucket for the imagenet data in tfrecord format created by the
    # SkyPilot team.  The bucket is available at
    # https://s3.console.aws.amazon.com/s3/buckets/imagenet-bucket?region=us-east-2&tab=objects.
    # This bucket is for demonstration purposes only.
    name: imagenet-bucket
    mode: MOUNT

setup: |
  git clone https://github.com/concretevitamin/tpu || true
  cd tpu
  git checkout 9459fee

  pip install --upgrade pip

  if [ ! -d ~/resnet ]; then
    uv venv ~/resnet --python 3.7
    source ~/resnet/bin/activate
    pip install nvidia-cudnn-cu11
    pip install tensorflow==2.4.0 pyyaml

    cd models
    pip install -e .
  else
    source ~/resnet/bin/activate
  fi

run: |
  cd tpu
  source ~/resnet/bin/activate
  # Set CUDNN library path
  CUDNN_PATH=$(dirname $(python -c "import nvidia.cudnn;print(nvidia.cudnn.__file__)"))
  export LD_LIBRARY_PATH=$CUDNN_PATH/lib:$LD_LIBRARY_PATH

  export XLA_FLAGS='--xla_gpu_cuda_data_dir=/usr/local/cuda/'
  python -u models/official/resnet/resnet_main.py --use_tpu=False \
      --mode=train --train_batch_size=256 --train_steps=250000 \
      --iterations_per_loop=125 \
      --data_dir=/tmp/imagenet \
      --model_dir=resnet-model-dir \
      --amp --xla --loss_scale=128
