resources:
  accelerators: V100:4

file_mounts:
  # Run the following commands locally to get the example input jpeg files.
  # mkdir -p ~/Downloads/detectron-inputs
  # wget http://images.cocodataset.org/val2017/000000439715.jpg -O ~/Downloads/detectron-inputs/input.jpg
  /inputs: ~/Downloads/detectron-inputs
  /detectron2: ./examples/docker/detectron2

setup: |
  # Build:
  sudo apt update
  docker build --build-arg USER_ID=$UID -t detectron2:v0 /detectron2
  mkdir -p ~/outputs

run: |
  # Launch (require GPUs):
  docker run -a stdout -a stderr --gpus=all --pid=host --rm \
    --shm-size=8gb --env="DISPLAY" \
    --volume=$HOME/.torch/fvcore_cache/detectron2:/tmp/detectron2:rw \
    --volume="/inputs:/inputs:ro" \
    --volume="$HOME/outputs:/tmp/outputs:rw" \
    detectron2:v0 /bin/bash -c \
    "echo CUDA_VISIBLE_DEVICES $CUDA_VISIBLE_DEVICES && \
    sudo chmod -R 777 /tmp && \
    python3 demo/demo.py  \
      --config-file configs/COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml \
      --input /inputs/input.jpg --output /tmp/outputs \
      --opts MODEL.WEIGHTS detectron2://COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x/137849600/model_final_f10217.pkl && \
    echo waiting 1200s && \
    sleep 12000"
