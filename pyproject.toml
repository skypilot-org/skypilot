[build-system]
requires = ["setuptools>=58.0"]
build-backend = "setuptools.build_meta"

[tool.yapf]
based_on_style = "google"
allow_split_before_dict_value = false

[tool.pytest.ini_options]
required_plugins = [
    "pytest-xdist",
    "pytest-env>=0.6",
    "buildkite-test-collector"
]
env = [
    "SKYPILOT_DEBUG=1",
    "SKYPILOT_DISABLE_USAGE_COLLECTION=1"
]
addopts = "-s -n 16 -q --tb=short --dist loadgroup --disable-warnings"
asyncio_default_fixture_loop_scope = "function"

[tool.mypy]
python_version = "3.8"
follow_imports = "skip"
ignore_missing_imports = true
allow_redefinition = true
check_untyped_defs = true

[tool.isort]
profile = "google"
line_length = 80
multi_line_output = 0
combine_as_imports = true
use_parentheses = true

[tool.ruff]
line-length = 80
target-version = "py38"

# Pylint rules disabled in .pylintrc that have NO ruff equivalent:
# (These require type checking, cross-file analysis, or are Python 2 era)
# - abstract-method, arguments-differ, attribute-defined-outside-init
# - c-extension-no-member, duplicate-code, import-error, invalid-str-codec
# - locally-disabled, no-init, no-member, no-name-in-module, signature-differs
# - suppressed-message, useless-suppression
# - Plus ~40 Python 2 compatibility rules (obsolete)

# Exclude paths matching pylint config and format.sh:
# - .pylintrc: ignore=third_party,ray_patches,providers (base names match anywhere)
# - format.sh: --ignore-paths 'sky/schemas/generated|sky/skylet/providers/ibm'
extend-exclude = [
    "build/**",
    "**/third_party/**",
    "**/ray_patches/**",
    "**/providers/**",
    "sky/schemas/generated/**",
    "sky/skylet/providers/ibm/**",
]

[tool.ruff.lint]
select = [
    # --- Core rules matching pylint ---
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "Q",      # flake8-quotes (matches pylint-quotes plugin)
    "PLE",    # Pylint errors
    "PLW",    # Pylint warnings
    "PLC",    # Pylint conventions
    "TID",    # flake8-tidy-imports (for banned-api / deprecated-modules)
    # --- Enhancements beyond pylint ---
    "UP",     # pyupgrade - Python version upgrades
    "C4",     # flake8-comprehensions
    "B",      # flake8-bugbear - common bugs
    "RUF",    # Ruff-specific rules
]

ignore = [
    # ==========================================================================
    # Pylint: disable=R (all refactor checks disabled)
    # ==========================================================================
    "PLR",

    # ==========================================================================
    # consider-using-f-string (C0209) - marked FIXME in pylint config
    # ==========================================================================
    "UP031",  # printf-style string formatting
    "UP032",  # f-string instead of format()

    # ==========================================================================
    # global-statement (W0603)
    # ==========================================================================
    "PLW0603",

    # ==========================================================================
    # useless-else-on-loop (W0120)
    # ==========================================================================
    "PLW0120",

    # ==========================================================================
    # import-self (W0406)
    # ==========================================================================
    "PLW0406",

    # ==========================================================================
    # eq-without-hash (W1641)
    # ==========================================================================
    "PLW1641",

    # ==========================================================================
    # unnecessary-lambda-assignment (C3001) - marked FIXME in pylint config
    # ==========================================================================
    "E731",

    # ==========================================================================
    # useless-object-inheritance (R0205)
    # ==========================================================================
    "UP004",

    # ==========================================================================
    # Line length - handled by yapf formatter
    # ==========================================================================
    "E501",

    # ==========================================================================
    # Whitespace rules - handled by yapf formatter
    # ==========================================================================
    "W291",  # Trailing whitespace
    "W292",  # No newline at end of file
    "W293",  # Blank line contains whitespace

    # ==========================================================================
    # Additional compatibility rules
    # ==========================================================================
    "B008",  # Function call in default argument (common pattern in codebase)
]

# Match pylint dummy-variables-rgx: ^\*{0,2}(_$|unused_|dummy_)
dummy-variable-rgx = "^\\*{0,2}(_$|unused_|dummy_)"

[tool.ruff.lint.flake8-quotes]
# Match pylint-quotes plugin settings:
# string-quote=single, triple-quote=double, docstring-quote=double
inline-quotes = "single"
multiline-quotes = "double"
docstring-quotes = "double"
avoid-escape = false  # pylint-quotes doesn't check this

[tool.ruff.lint.flake8-tidy-imports.banned-api]
# Match pylint deprecated-modules setting
"regsub".msg = "Deprecated module"
"TERMIOS".msg = "Deprecated module"
"Bastion".msg = "Deprecated module"
"rexec".msg = "Deprecated module"
"sets".msg = "Deprecated module, use built-in set"
