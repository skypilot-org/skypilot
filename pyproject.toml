[build-system]
requires = ["setuptools>=58.0"]
build-backend = "setuptools.build_meta"

[tool.yapf]
based_on_style = "google"
allow_split_before_dict_value = false

[tool.pytest.ini_options]
required_plugins = [
    "pytest-xdist",
    "pytest-env>=0.6",
    "buildkite-test-collector"
]
env = [
    "SKYPILOT_DEBUG=1",
    "SKYPILOT_DISABLE_USAGE_COLLECTION=1"
]
addopts = "-s -n 16 -q --tb=short --dist loadgroup --disable-warnings"
asyncio_default_fixture_loop_scope = "function"

[tool.mypy]
python_version = "3.8"
follow_imports = "skip"
ignore_missing_imports = true
allow_redefinition = true
check_untyped_defs = true

[tool.isort]
profile = "google"
line_length = 80
multi_line_output = 0
combine_as_imports = true
use_parentheses = true

[tool.ruff]
# Match existing pylint/yapf config
line-length = 80
target-version = "py38"

# Match pylint ignore paths + format.sh excludes
extend-exclude = [
    "build/**",
    "sky/skylet/providers/ibm/**",
    "sky/schemas/generated/**",
    "third_party/**",
    "ray_patches/**",
    "**/providers/**",
    "tests/unit_tests/test_sky/backends/testdata/**",
]

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "C4",     # flake8-comprehensions
    "B",      # flake8-bugbear
    "Q",      # flake8-quotes
    "PLE",    # Pylint errors
    "PLW",    # Pylint warnings
    "PLC",    # Pylint conventions
    "UP",     # pyupgrade
    "G",      # flake8-logging-format
    "RUF",    # Ruff-specific
]

ignore = [
    # ==========================================================================
    # Pylint: disable=R (all refactor checks disabled)
    # ==========================================================================
    "PLR",

    # ==========================================================================
    # consider-using-f-string (C0209) - marked FIXME in pylint config
    # ==========================================================================
    "UP031",  # printf-style string formatting
    "UP032",  # f-string instead of format()

    # ==========================================================================
    # global-statement (W0603)
    # ==========================================================================
    "PLW0603",

    # ==========================================================================
    # logging-format-interpolation (W1202) - marked FIXME in pylint config
    # logging-fstring-interpolation (W1203) - marked FIXME in pylint config
    # Pylint wants lazy % formatting, but these are disabled so all styles allowed
    # ==========================================================================
    "G001",  # Logging statement uses str.format
    "G004",  # Logging statement uses f-string

    # ==========================================================================
    # unnecessary-lambda-assignment (C3001) - marked FIXME in pylint config
    # ==========================================================================
    "E731",

    # ==========================================================================
    # useless-object-inheritance (R0205)
    # ==========================================================================
    "UP004",

    # ==========================================================================
    # Line length - handled by yapf formatter
    # ==========================================================================
    "E501",

    # ==========================================================================
    # Whitespace rules - handled by yapf formatter
    # ==========================================================================
    "W291",  # Trailing whitespace
    "W292",  # No newline at end of file
    "W293",  # Blank line contains whitespace

    # ==========================================================================
    # Additional compatibility rules
    # ==========================================================================
    "B008",  # Function call in default argument (common pattern in codebase)
]

# Match pylint dummy-variables-rgx: ^\*{0,2}(_$|unused_|dummy_)
dummy-variable-rgx = "^\\*{0,2}(_$|unused_|dummy_)"

[tool.ruff.lint.flake8-quotes]
# Match pylint-quotes plugin settings:
# string-quote=single, triple-quote=double, docstring-quote=double
inline-quotes = "single"
multiline-quotes = "double"
docstring-quotes = "double"

[tool.ruff.lint.pydocstyle]
# Match Google style guide used by the project
convention = "google"

[tool.ruff.lint.flake8-tidy-imports.banned-api]
# Match pylint deprecated-modules setting
"regsub".msg = "Deprecated module"
"TERMIOS".msg = "Deprecated module"
"Bastion".msg = "Deprecated module"
"rexec".msg = "Deprecated module"
"sets".msg = "Deprecated module, use built-in set"
