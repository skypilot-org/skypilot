envs:
  WEB_PASSWORD:
  SKYPILOT_API_SERVER_ENDPOINT:

resources:
  cloud: gcp
  zone: us-central1-a
  cpus: 2
  memory: 2+
  disk_size: 100
  ports: 3000

workdir: .

setup: |
  # Check if Node.js and npm are installed, if not install them
  if ! command -v node &> /dev/null || ! command -v npm &> /dev/null
  then
      echo "Node.js or npm not found. Installing Node.js and npm..."
      sudo apt update
      sudo apt install -y curl
      curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
      sudo apt install -y nodejs
      # Verify installation
      node -v
      npm -v
  fi

  # Now run npm commands
  npm install
  npm run build || exit 1

  # Check if nginx is installed, if not install it
  if ! command -v nginx &> /dev/null
  then
      echo "Nginx not installed. Installing Nginx..."
      sudo apt update
      sudo apt install nginx -y
  fi

  # Create a directory for nginx configuration if it doesn't exist
  sudo mkdir -p /etc/nginx/conf.d

  # Create an nginx configuration file
  cat << EOF | sudo tee /etc/nginx/conf.d/my_service.conf
  server {
      listen 8000;
      location / {
          auth_basic "Restricted Access";
          auth_basic_user_file /etc/nginx/.htpasswd;

          proxy_pass http://localhost:3000;
          proxy_set_header Host \$host;
          proxy_set_header X-Real-IP \$remote_addr;
          proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto \$scheme;
      }
  }
  EOF

  # Set up basic authentication
  echo "Setting up basic authentication..."
  sudo apt install apache2-utils lsof -y
  # Replace 'username' and 'your_password_here' with your actual username and desired password
  echo "$WEB_PASSWORD" | sudo htpasswd -c -i /etc/nginx/.htpasswd skypilot

  # Restart nginx to apply configuration
  sudo systemctl restart nginx
  echo "Nginx is configured and restarted successfully."

run: |
  echo "Starting the application..."
  echo "Access it through "
  npm start
