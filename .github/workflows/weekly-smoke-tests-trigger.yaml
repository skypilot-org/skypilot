name: Smoke Tests Trigger (Scheduled and PR)

on:
  schedule:
    - cron: '0 0 * * 0'  # Runs at 00:00 on Sunday (UTC)
  # uncomment this for PR triggers testing
  # pull_request:
  #   types: [opened, synchronize, reopened]

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cloud: [aws, azure, gcp, kubernetes]
    steps:
      - name: Trigger Smoke Tests (${{ matrix.cloud }})
        env:
          BUILDKITE_TOKEN: ${{ secrets.BUILDKITE_TOKEN }}
          BUILDKITE_API_URL: "https://api.buildkite.com/v2/organizations/skypilot-1/pipelines/smoke-tests/builds"
        run: |
          response=$(curl -w "%{http_code}" -H "Authorization: Bearer $BUILDKITE_TOKEN" \
            -X POST "$BUILDKITE_API_URL" \
            -d '{
              "commit": "HEAD",
              "branch": "master",
              "message": "Weekly Smoke Tests on (${{ matrix.cloud }})",
              "ignore_pipeline_branch_filters": true,
              "env": {
                "ARGS": "--${{ matrix.cloud }}"
              }
            }')

          http_code=$(echo "$response" | tail -n 1)
          response_body=$(echo "$response" | head -n -1)

          if [ "$http_code" != "201" ]; then
            echo "Error: Buildkite API returned HTTP status code $http_code"
            echo "Response body:"
            echo "$response_body"
            exit 1
          fi

          echo "Build triggered successfully (HTTP status code: $http_code)"
