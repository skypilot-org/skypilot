name: Test ReadTheDocs Branch Sanitization

on:
  pull_request:
    paths:
      - '.github/workflows/readthedocs-manual-pr-build.yml'
      - '.github/workflows/test-readthedocs-branch-sanitization.yml'

jobs:
  test-rtd-build:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger ReadTheDocs build (test)
        env:
          READTHEDOCS_TOKEN: ${{ secrets.READTHEDOCS_TOKEN }}
          READTHEDOCS_PROJECT: ${{ secrets.READTHEDOCS_PROJECT }}
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          # ReadTheDocs automatically replaces forward slashes with dashes when generating version slugs
          # See: https://docs.readthedocs.com/platform/latest/versions.html
          # So we need to match that behavior when calling the API
          # Then URL-encode the sanitized branch name for the API call
          SANITIZED_BRANCH=$(echo -n "${BRANCH_NAME}" | sed 's/\//-/g')
          VERSION_SLUG=$(echo -n "${SANITIZED_BRANCH}" | jq -sRr @uri)

          echo "Triggering ReadTheDocs build for project: ${READTHEDOCS_PROJECT}, branch: ${BRANCH_NAME}"
          echo "Using version slug: ${SANITIZED_BRANCH} (sanitized from branch name)"

          # Activate and configure the version
          CONFIG_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            "https://readthedocs.com/api/v3/projects/${READTHEDOCS_PROJECT}/versions/${VERSION_SLUG}/" \
            -H "Authorization: Token ${READTHEDOCS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "active": true,
              "hidden": true,
              "privacy_level": "public"
            }')

          CONFIG_HTTP_CODE=$(echo "$CONFIG_RESPONSE" | tail -n1)
          CONFIG_BODY=$(echo "$CONFIG_RESPONSE" | head -n-1)

          if [ "$CONFIG_HTTP_CODE" -eq 404 ]; then
            echo "⚠️  Branch '${BRANCH_NAME}' not found in ReadTheDocs."
            echo "Triggering version sync from GitHub..."

            SYNC_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "https://readthedocs.com/api/v3/projects/${READTHEDOCS_PROJECT}/sync-versions/" \
              -H "Authorization: Token ${READTHEDOCS_TOKEN}" \
              -H "Content-Type: application/json")

            SYNC_HTTP_CODE=$(echo "$SYNC_RESPONSE" | tail -n1)

            if [ "$SYNC_HTTP_CODE" -eq 202 ] || [ "$SYNC_HTTP_CODE" -eq 200 ]; then
              echo "✅ Version sync triggered successfully"
              sleep 10

              CONFIG_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
                "https://readthedocs.com/api/v3/projects/${READTHEDOCS_PROJECT}/versions/${VERSION_SLUG}/" \
                -H "Authorization: Token ${READTHEDOCS_TOKEN}" \
                -H "Content-Type: application/json" \
                -d '{
                  "active": true,
                  "hidden": true,
                  "privacy_level": "public"
                }')

              CONFIG_HTTP_CODE=$(echo "$CONFIG_RESPONSE" | tail -n1)
              CONFIG_BODY=$(echo "$CONFIG_RESPONSE" | head -n-1)

              if [ "$CONFIG_HTTP_CODE" -eq 404 ]; then
                echo "❌ Branch still not found after sync."
                echo "Response: $CONFIG_BODY"
                exit 1
              fi
            fi
          fi

          if [ "$CONFIG_HTTP_CODE" -ne 200 ] && [ "$CONFIG_HTTP_CODE" -ne 204 ]; then
            echo "❌ Failed to activate version. HTTP status: $CONFIG_HTTP_CODE"
            echo "$CONFIG_BODY"
            exit 1
          fi

          echo "✅ Version activated successfully"

          # Trigger the build
          BUILD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://readthedocs.com/api/v3/projects/${READTHEDOCS_PROJECT}/versions/${VERSION_SLUG}/builds/" \
            -H "Authorization: Token ${READTHEDOCS_TOKEN}" \
            -H "Content-Type: application/json")

          BUILD_HTTP_CODE=$(echo "$BUILD_RESPONSE" | tail -n1)

          if [ "$BUILD_HTTP_CODE" -eq 202 ] || [ "$BUILD_HTTP_CODE" -eq 201 ]; then
            echo "✅ ReadTheDocs build triggered successfully!"
          else
            echo "❌ Failed to trigger build. HTTP status: $BUILD_HTTP_CODE"
            exit 1
          fi
