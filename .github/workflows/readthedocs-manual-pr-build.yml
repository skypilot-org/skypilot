name: Manual ReadTheDocs Build on PR

on:
  issue_comment:
    types: [created]

jobs:
  trigger-rtd-build:
    # Only run if:
    # 1. The comment is on a pull request (not an issue)
    # 2. The comment contains /build-docs
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/build-docs')
    runs-on: ubuntu-latest
    steps:
      - name: Check authorization
        id: check-auth
        env:
          AUTHORIZED_USERS: ${{ vars.AUTHORIZED_RTD_BUILDERS }}
        uses: actions/github-script@v7
        with:
          script: |
            // Get authorized users from repository variable (comma-separated list)
            const authorizedUsersStr = process.env.AUTHORIZED_USERS || '';
            const authorizedUsers = authorizedUsersStr
              .split(',')
              .map(u => u.trim())
              .filter(u => u.length > 0);

            if (authorizedUsers.length === 0) {
              core.setFailed('AUTHORIZED_RTD_BUILDERS variable is not set or empty. Please configure it in repository settings.');
              return false;
            }

            const commenter = context.payload.comment.user.login;
            const isAuthorized = authorizedUsers.includes(commenter);

            if (!isAuthorized) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `❌ @${commenter} is not authorized to trigger ReadTheDocs builds. Please contact a maintainer.`
              });
              core.setFailed(`User ${commenter} is not authorized`);
              return false;
            }

            console.log(`✅ User ${commenter} is authorized to trigger builds`);
            return true;
          result-encoding: string

      - name: Get PR branch
        id: get-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return pr.data.head.ref;
          result-encoding: string

      - name: Trigger ReadTheDocs build
        env:
          READTHEDOCS_TOKEN: ${{ secrets.READTHEDOCS_TOKEN }}
          BRANCH_NAME: ${{ steps.get-branch.outputs.result }}
        run: |
          # Trigger a build for the PR branch on ReadTheDocs
          # The branch needs to exist as a version on ReadTheDocs

          PROJECT_SLUG="skypilot"
          VERSION_SLUG="${BRANCH_NAME}"

          echo "Triggering ReadTheDocs build for project: ${PROJECT_SLUG}, version: ${VERSION_SLUG}"

          # First, ensure the version exists and is configured correctly
          # Update version settings to be hidden, active, and public
          curl -X PATCH \
            "https://readthedocs.org/api/v3/projects/${PROJECT_SLUG}/versions/${VERSION_SLUG}/" \
            -H "Authorization: Token ${READTHEDOCS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "active": true,
              "hidden": true,
              "privacy_level": "public"
            }' || echo "Version may not exist yet or update failed"

          # Trigger the build
          RESPONSE=$(curl -X POST \
            "https://readthedocs.org/api/v3/projects/${PROJECT_SLUG}/versions/${VERSION_SLUG}/builds/" \
            -H "Authorization: Token ${READTHEDOCS_TOKEN}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" -eq 202 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "✅ ReadTheDocs build triggered successfully!"
            echo "$BODY"
          else
            echo "❌ Failed to trigger ReadTheDocs build. HTTP status: $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.get-branch.outputs.result }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ ReadTheDocs build triggered for branch \`${branch}\`\n\nThe documentation will be available at: https://skypilot.readthedocs.io/en/${branch}/`
            })

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.get-branch.outputs.result }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ Failed to trigger ReadTheDocs build for branch \`${branch}\`. Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
            })
