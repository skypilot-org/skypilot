
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sky.backends.cloud_vm_ray_backend &#8212; Sky 0.1 documentation</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-book-theme.css?digest=84ace793992934648b4de8eed757e5a2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.9d8b4a8b9bb19db25eeaddc40d639ba2.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<div class="col-12 col-md-3 bd-sidebar site-navigation " id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Sky 0.1 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../getting-started/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../getting-started/quickstart.html">
   Quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../getting-started/tutorial.html">
   Tutorial: DNN Training
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Use Cases
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../examples/auto-failover.html">
   Auto-provisioning GPUs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../examples/iterative-dev-project.html">
   Iteratively Developing a Project
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../examples/launch-many-tasks-vm.html">
   Launch Multiple Tasks on a VM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../examples/grid-search.html">
   Grid Search
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../examples/distributed-jobs.html">
   Distributed Jobs on many VMs
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../reference/interactive-nodes.html">
   Interactive Nodes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../reference/iterative-development.html">
   Iterative Development
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../reference/storage.html">
   Storage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../reference/job-queue.html">
   Job Queue
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../reference/cli.html">
   CLI Reference
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<!-- This is an invisible pixel that we watch to see if we've scrolled. -->
<div class="sbt-scroll-pixel-helper"></div>
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            <div class="topbar-left">
                
                <label class="nav-toggle-button" for="__navigation">
                    <div class="visually-hidden">Toggle navigation</div>
                    <i class="fas fa-bars"></i>
                </label>
                
            </div>
            
            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            
              <div>
                
  <h1>Source code for sky.backends.cloud_vm_ray_backend</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Backend: runs on cloud virtual machines, managed by Ray.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">colorama</span>

<span class="kn">import</span> <span class="nn">sky</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">backends</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">clouds</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">cloud_stores</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">dag</span> <span class="k">as</span> <span class="n">dag_lib</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">global_user_state</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">sky_logging</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">optimizer</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">resources</span> <span class="k">as</span> <span class="n">resources_lib</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">task</span> <span class="k">as</span> <span class="n">task_lib</span>
<span class="kn">from</span> <span class="nn">sky.backends</span> <span class="kn">import</span> <span class="n">backend_utils</span>
<span class="kn">from</span> <span class="nn">sky.skylet</span> <span class="kn">import</span> <span class="n">job_lib</span><span class="p">,</span> <span class="n">log_lib</span>

<span class="n">Dag</span> <span class="o">=</span> <span class="n">dag_lib</span><span class="o">.</span><span class="n">Dag</span>
<span class="n">OptimizeTarget</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">OptimizeTarget</span>
<span class="n">Resources</span> <span class="o">=</span> <span class="n">resources_lib</span><span class="o">.</span><span class="n">Resources</span>
<span class="n">Task</span> <span class="o">=</span> <span class="n">task_lib</span><span class="o">.</span><span class="n">Task</span>

<span class="n">Path</span> <span class="o">=</span> <span class="nb">str</span>
<span class="n">PostSetupFn</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
<span class="n">SKY_REMOTE_APP_DIR</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">SKY_REMOTE_APP_DIR</span>
<span class="n">SKY_REMOTE_WORKDIR</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">SKY_REMOTE_WORKDIR</span>
<span class="n">SKY_LOGS_DIRECTORY</span> <span class="o">=</span> <span class="n">job_lib</span><span class="o">.</span><span class="n">SKY_LOGS_DIRECTORY</span>
<span class="n">SKY_REMOTE_LOGS_ROOT</span> <span class="o">=</span> <span class="n">job_lib</span><span class="o">.</span><span class="n">SKY_REMOTE_LOGS_ROOT</span>
<span class="n">SKY_REMOTE_RAY_VERSION</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">SKY_REMOTE_RAY_VERSION</span>
<span class="n">SKYLET_REMOTE_PATH</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">SKY_REMOTE_PATH</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">sky_logging</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_cluster_name_is_valid</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Errors out on invalid cluster names not supported by cloud providers.</span>

<span class="sd">    Bans (including but not limited to) names that:</span>
<span class="sd">    - are digits-only</span>
<span class="sd">    - contain underscore (_)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cluster_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># GCP errors return this exact regex.  An informal description is also at:</span>
    <span class="c1"># https://cloud.google.com/compute/docs/naming-resources#resource-name-format</span>
    <span class="n">valid_regex</span> <span class="o">=</span> <span class="s1">&#39;[a-z]([-a-z0-9]{0,61}[a-z0-9])?&#39;</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">valid_regex</span><span class="p">,</span> <span class="n">cluster_name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster name &quot;</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">&quot; is invalid; &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;ensure it is fully matched by regex: </span><span class="si">{</span><span class="n">valid_regex</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_cluster_config_template</span><span class="p">(</span><span class="n">cloud</span><span class="p">):</span>
    <span class="n">cloud_to_template</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">clouds</span><span class="o">.</span><span class="n">AWS</span><span class="p">:</span> <span class="s1">&#39;config/aws-ray.yml.j2&#39;</span><span class="p">,</span>
        <span class="n">clouds</span><span class="o">.</span><span class="n">Azure</span><span class="p">:</span> <span class="s1">&#39;config/azure-ray.yml.j2&#39;</span><span class="p">,</span>
        <span class="n">clouds</span><span class="o">.</span><span class="n">GCP</span><span class="p">:</span> <span class="s1">&#39;config/gcp-ray.yml.j2&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">cloud_to_template</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">cloud</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sky</span><span class="o">.</span><span class="n">__root_dir__</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_task_demands_dict</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Returns the accelerator dict of the task&quot;&quot;&quot;</span>
    <span class="c1"># TODO: CPU and other memory resources are not supported yet.</span>
    <span class="n">accelerator_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">best_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">best_resources</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Task may (e.g., sky launch) or may not (e.g., sky exec) have undergone</span>
        <span class="c1"># sky.optimize(), so best_resources may be None.</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">resources</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">accelerator_dict</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get_accelerators</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">accelerator_dict</span>


<span class="k">def</span> <span class="nf">_add_cluster_to_ssh_config</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cluster_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">auth_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">backend_utils</span><span class="o">.</span><span class="n">SSHConfigHelper</span><span class="o">.</span><span class="n">add_cluster</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">cluster_ip</span><span class="p">,</span>
                                              <span class="n">auth_config</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_remove_cluster_from_ssh_config</span><span class="p">(</span><span class="n">cluster_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                    <span class="n">auth_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">backend_utils</span><span class="o">.</span><span class="n">SSHConfigHelper</span><span class="o">.</span><span class="n">remove_cluster</span><span class="p">(</span><span class="n">cluster_ip</span><span class="p">,</span> <span class="n">auth_config</span><span class="p">)</span>


<div class="viewcode-block" id="RayCodeGen"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RayCodeGen">[docs]</a><span class="k">class</span> <span class="nc">RayCodeGen</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Code generator of a Ray program that executes a sky.Task.</span>

<span class="sd">    Usage:</span>

<span class="sd">      &gt;&gt; codegen = RayCodegen()</span>
<span class="sd">      &gt;&gt; codegen.add_prologue()</span>

<span class="sd">      &gt;&gt; codegen.add_ray_task(...)</span>
<span class="sd">      &gt;&gt; codegen.add_ray_task(...)</span>

<span class="sd">      &gt;&gt; codegen.add_epilogue()</span>
<span class="sd">      &gt;&gt; code = codegen.build()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Code generated so far, to be joined via &#39;\n&#39;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Guard method calling order.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_prologue</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_epilogue</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># For n nodes gang scheduling.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_gang_scheduling</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_nodes</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_register_run_fn</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># job_id</span>
        <span class="c1"># Job ID is used to identify the job (also this generated code).</span>
        <span class="c1"># It is a int automatically generated by the DB on the cluster</span>
        <span class="c1"># and monotonically increasing starting from 1.</span>
        <span class="c1"># To generate the job ID, we use the following logic:</span>
        <span class="c1">#   job_codegen = backend_utils.JobLibCodeGen()</span>
        <span class="c1">#   job_codegen.add_job(username, run_timestamp)</span>
        <span class="c1">#   code = job_codegen.build()</span>
        <span class="c1">#   job_id = get_output(run_on_cluster(code))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RayCodeGen.add_prologue"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RayCodeGen.add_prologue">[docs]</a>    <span class="k">def</span> <span class="nf">add_prologue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_prologue</span><span class="p">,</span> <span class="s1">&#39;add_prologue() called twice?&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_prologue</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            import io</span>
<span class="s2">            import os</span>
<span class="s2">            import pathlib</span>
<span class="s2">            import sys</span>
<span class="s2">            import selectors</span>
<span class="s2">            import subprocess</span>
<span class="s2">            import tempfile</span>
<span class="s2">            import textwrap</span>
<span class="s2">            import time</span>
<span class="s2">            from typing import Dict, List, Optional, Tuple, Union</span>

<span class="s2">            import ray</span>
<span class="s2">            import ray.util as ray_util</span>

<span class="s2">            from sky.skylet import job_lib</span>

<span class="s2">            SKY_REMOTE_WORKDIR = </span><span class="si">{</span><span class="n">log_lib</span><span class="o">.</span><span class="n">SKY_REMOTE_WORKDIR</span><span class="si">!r}</span><span class="s2"></span>
<span class="s2">            job_lib.set_status(</span><span class="si">{</span><span class="n">job_id</span><span class="si">!r}</span><span class="s2">, job_lib.JobStatus.PENDING)</span>

<span class="s2">            ray.init(&#39;auto&#39;, namespace=&#39;__sky__</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">__&#39;, log_to_driver=True)</span>
<span class="s2">            </span>
<span class="s2">            run_fn = None</span>
<span class="s2">            futures = []&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="c1"># FIXME: This is a hack to make sure that the functions can be found</span>
            <span class="c1"># by ray.remote. This should be removed once we have a better way to</span>
            <span class="c1"># specify dependencies for ray.</span>
            <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">log_lib</span><span class="o">.</span><span class="n">redirect_process_output</span><span class="p">),</span>
            <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">log_lib</span><span class="o">.</span><span class="n">run_with_log</span><span class="p">),</span>
            <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">log_lib</span><span class="o">.</span><span class="n">make_task_bash_script</span><span class="p">),</span>
            <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">log_lib</span><span class="o">.</span><span class="n">run_bash_command_with_log</span><span class="p">),</span>
            <span class="s1">&#39;run_bash_command_with_log = ray.remote(run_bash_command_with_log)&#39;</span><span class="p">,</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="RayCodeGen.add_gang_scheduling_placement_group"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RayCodeGen.add_gang_scheduling_placement_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_gang_scheduling_placement_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_nodes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">accelerator_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the gang scheduling placement group for a Task.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_prologue</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Call add_prologue() before &#39;</span>
                                    <span class="s1">&#39;add_gang_scheduling_placement_group().&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_gang_scheduling</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_nodes</span> <span class="o">=</span> <span class="n">num_nodes</span>

        <span class="c1"># Set CPU to avoid ray hanging the resources allocation</span>
        <span class="c1"># for remote functions, since the task will request 1 CPU</span>
        <span class="c1"># by default.</span>
        <span class="n">bundles</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;CPU&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">accelerator_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">accelerator_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">acc_count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">accelerator_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">gpu_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GPU&#39;</span><span class="p">:</span> <span class="n">acc_count</span><span class="p">}</span>
            <span class="c1"># gpu_dict should be empty when the accelerator is not GPU.</span>
            <span class="c1"># FIXME: This is a hack to make sure that we do not reserve</span>
            <span class="c1"># GPU when requesting TPU.</span>
            <span class="k">if</span> <span class="s1">&#39;tpu&#39;</span> <span class="ow">in</span> <span class="n">acc_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">gpu_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bundle</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">:</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="o">**</span><span class="n">accelerator_dict</span><span class="p">,</span>
                    <span class="c1"># Set the GPU to avoid ray hanging the resources allocation</span>
                    <span class="o">**</span><span class="n">gpu_dict</span><span class="p">,</span>
                <span class="p">})</span>

        <span class="n">pack_mode</span> <span class="o">=</span> <span class="s1">&#39;STRICT_SPREAD&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">                pg = ray_util.placement_group(</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bundles</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pack_mode</span><span class="si">!r}</span><span class="s2">)</span>
<span class="s2">                print(&#39;SKY INFO: Reserving task slots on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bundles</span><span class="p">)</span><span class="si">}</span><span class="s2"> nodes.&#39;,</span>
<span class="s2">                      file=sys.stderr,</span>
<span class="s2">                      flush=True)</span>
<span class="s2">                # FIXME: This will print the error message from autoscaler if</span>
<span class="s2">                # it is waiting for other task to finish. We should hide the</span>
<span class="s2">                # error message.</span>
<span class="s2">                ray.get(pg.ready())</span>
<span class="s2">                print(&#39;SKY INFO: All task slots reserved.&#39;,</span>
<span class="s2">                      file=sys.stderr,</span>
<span class="s2">                      flush=True)</span>
<span class="s2">                job_lib.set_job_started(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="si">!r}</span><span class="s2">)</span>
<span class="s2">                export_sky_env_vars = &#39;&#39;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Export IP and node rank to the environment variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">                @ray.remote</span>
<span class="s2">                def check_ip():</span>
<span class="s2">                    return ray.util.get_node_ip_address()</span>
<span class="s2">                ip_list = ray.get([</span>
<span class="s2">                    check_ip.options(placement_group=pg,</span>
<span class="s2">                                     placement_group_bundle_index=i).remote()</span>
<span class="s2">                    for i in range(pg.bundle_count)</span>
<span class="s2">                ])</span>
<span class="s2">                print(&#39;SKY INFO: Placement group IPs:&#39;, ip_list)</span>
<span class="s2">                ip_list_str = &#39; &#39;.join([repr(ip) for ip in ip_list])</span>
<span class="s2">                export_sky_env_vars = &#39;export SKY_NODE_IPS=(&#39; + ip_list_str + &#39;)</span><span class="se">\\</span><span class="s2">n&#39;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="RayCodeGen.register_run_fn"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RayCodeGen.register_run_fn">[docs]</a>    <span class="k">def</span> <span class="nf">register_run_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_fn_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register the run function to be run on the remote cluster.</span>

<span class="sd">        Args:</span>
<span class="sd">            run_fn: The run function to be run on the remote cluster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_gang_scheduling</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;Call add_gang_scheduling_placement_group() &#39;</span>
            <span class="s1">&#39;before register_run_fn().&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_register_run_fn</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;register_run_fn() called twice?&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_register_run_fn</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">run_fn</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;run_fn = </span><span class="si">{</span><span class="n">run_fn_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="RayCodeGen.add_ray_task"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RayCodeGen.add_ray_task">[docs]</a>    <span class="k">def</span> <span class="nf">add_ray_task</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bash_script</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">ray_resources_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">log_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">gang_scheduling_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates code for a ray remote task that runs a bash command.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_gang_scheduling</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;Call add_gang_schedule_placement_group() before add_ray_task().&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_register_run_fn</span> <span class="ow">or</span>
                <span class="n">bash_script</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;bash_script should &#39;</span>
                                       <span class="s1">&#39;be None when run_fn is registered.&#39;</span><span class="p">)</span>
        <span class="c1"># Build remote_task.options(...)</span>
        <span class="c1">#   name=...</span>
        <span class="c1">#   resources=...</span>
        <span class="c1">#   num_gpus=...</span>
        <span class="n">name_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;name=</span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">task_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make the task name more meaningful in ray log.</span>
            <span class="n">name_str</span> <span class="o">=</span> <span class="s1">&#39;name=</span><span class="se">\&#39;</span><span class="s1">task</span><span class="se">\&#39;</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">ray_resources_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resources_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">num_gpus_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray_resources_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
                <span class="p">(</span><span class="s1">&#39;There can only be one type of accelerator per instance.&#39;</span>
                 <span class="sa">f</span><span class="s1">&#39; Found: </span><span class="si">{</span><span class="n">ray_resources_dict</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="n">resources_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;, resources=</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">ray_resources_dict</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1"># Passing this ensures that the Ray remote task gets</span>
            <span class="c1"># CUDA_VISIBLE_DEVICES set correctly.  If not passed, that flag</span>
            <span class="c1"># would be force-set to empty by Ray.</span>
            <span class="n">num_gpus_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;, num_gpus=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ray_resources_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="c1"># `num_gpus` should be empty when the accelerator is not GPU.</span>
            <span class="c1"># FIXME: use a set of GPU types.</span>
            <span class="n">resources_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ray_resources_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;tpu&#39;</span> <span class="ow">in</span> <span class="n">resources_key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">num_gpus_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">resources_str</span> <span class="o">=</span> <span class="s1">&#39;, placement_group=pg&#39;</span>
        <span class="n">resources_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;, placement_group_bundle_index=</span><span class="si">{</span><span class="n">gang_scheduling_id</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Added Task with options: </span><span class="si">{</span><span class="n">name_str</span><span class="si">}{</span><span class="n">resources_str</span><span class="si">}{</span><span class="n">num_gpus_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        script = </span><span class="si">{</span><span class="n">bash_script</span><span class="si">!r}</span><span class="s2"></span>
<span class="s2">        if run_fn is not None:</span>
<span class="s2">            script = run_fn(</span><span class="si">{</span><span class="n">gang_scheduling_id</span><span class="si">}</span><span class="s2">, ip_list)</span>

<span class="s2">        if script is not None:</span>
<span class="s2">            node_export_sky_env_vars = (export_sky_env_vars + </span>
<span class="s2">                                        &#39;export SKY_NODE_RANK=</span><span class="si">{</span><span class="n">gang_scheduling_id</span><span class="si">}</span><span class="se">\\</span><span class="s2">n&#39;)</span>
<span class="s2">            futures.append(run_bash_command_with_log </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">                    .options(</span><span class="si">{</span><span class="n">name_str</span><span class="si">}{</span><span class="n">resources_str</span><span class="si">}{</span><span class="n">num_gpus_str</span><span class="si">}</span><span class="s2">) </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">                    .remote(</span>
<span class="s2">                        script,</span>
<span class="s2">                        </span><span class="si">{</span><span class="n">log_path</span><span class="si">!r}</span><span class="s2">,</span>
<span class="s2">                        export_sky_env_vars=node_export_sky_env_vars,</span>
<span class="s2">                        stream_logs=True,</span>
<span class="s2">                        with_ray=True,</span>
<span class="s2">                    ))&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="RayCodeGen.add_epilogue"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RayCodeGen.add_epilogue">[docs]</a>    <span class="k">def</span> <span class="nf">add_epilogue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates code that waits for all tasks, then exits.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_prologue</span><span class="p">,</span> <span class="s1">&#39;Call add_prologue() before add_epilogue().&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_epilogue</span><span class="p">,</span> <span class="s1">&#39;add_epilogue() called twice?&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_epilogue</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            try:</span>
<span class="s2">                ray.get(futures)</span>
<span class="s2">                job_lib.set_status(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="si">!r}</span><span class="s2">, job_lib.JobStatus.SUCCEEDED)</span>
<span class="s2">            except ray.exceptions.WorkerCrashedError as e:</span>
<span class="s2">                job_lib.set_status(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="si">!r}</span><span class="s2">, job_lib.JobStatus.FAILED)</span>
<span class="s2">                raise RuntimeError(&#39;Command failed, please check the logs.&#39;) from e</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="RayCodeGen.build"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RayCodeGen.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the entire generated program.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_epilogue</span><span class="p">,</span> <span class="s1">&#39;Call add_epilogue() before build().&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RetryingVmProvisioner"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RetryingVmProvisioner">[docs]</a><span class="k">class</span> <span class="nc">RetryingVmProvisioner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A provisioner that retries different cloud/regions/zones.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dag</span><span class="p">:</span> <span class="n">Dag</span><span class="p">,</span> <span class="n">optimize_target</span><span class="p">:</span> <span class="n">OptimizeTarget</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_regions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_zones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_launchable_resources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">log_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span> <span class="o">=</span> <span class="n">dag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_target</span> <span class="o">=</span> <span class="n">optimize_target</span>

        <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_in_blocklist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cloud</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_regions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># We do not keep track of zones in Azure.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">Azure</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">zones</span><span class="p">,</span> <span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zone</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_zones</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_clear_blocklist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_regions</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_zones</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_blocklist_on_gcp_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zones</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="n">zones</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">exception_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">splits</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Exception: &#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exception_str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Parse structured response {&#39;errors&#39;: [...]}.</span>
            <span class="n">exception_str</span> <span class="o">=</span> <span class="n">exception_str</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Exception: &#39;</span><span class="p">):]</span>
            <span class="n">exception_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">exception_str</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">exception_dict</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">error</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">zone</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">DIM</span><span class="si">}</span><span class="s1">(message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">)&#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;QUOTA_EXCEEDED&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">GPUS_ALL_REGIONS</span><span class="se">\&#39;</span><span class="s1"> exceeded&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
                        <span class="c1"># Global quota.  All regions in GCP will fail.  Ex:</span>
                        <span class="c1"># Quota &#39;GPUS_ALL_REGIONS&#39; exceeded.  Limit: 1.0</span>
                        <span class="c1"># globally.</span>
                        <span class="c1"># This skip is only correct if we implement &quot;first</span>
                        <span class="c1"># retry the region/zone of an existing cluster with the</span>
                        <span class="c1"># same name&quot; correctly.</span>
                        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">clouds</span><span class="o">.</span><span class="n">GCP</span><span class="o">.</span><span class="n">region_zones_provision_loop</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_regions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Per region.  Ex: Quota &#39;CPUS&#39; exceeded.  Limit: 24.0</span>
                        <span class="c1"># in region us-west1.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_regions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;ZONE_RESOURCE_POOL_EXHAUSTED&#39;</span><span class="p">:</span>  <span class="c1"># Per zone.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_zones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">zone</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No such structured error response found.</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">exception_str</span><span class="p">,</span> <span class="n">stderr</span>
            <span class="k">if</span> <span class="s1">&#39;was not found&#39;</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="c1"># Example: The resource</span>
                <span class="c1"># &#39;projects/&lt;id&gt;/zones/zone/acceleratorTypes/nvidia-tesla-v100&#39;</span>
                <span class="c1"># was not found.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got </span><span class="se">\&#39;</span><span class="s1">resource not found</span><span class="se">\&#39;</span><span class="s1"> in </span><span class="si">{</span><span class="n">zone</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_zones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">zone</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;====== stdout ======&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;====== stderr ======&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;Errors occurred during provision/file_mounts/setup; &#39;</span>
                    <span class="s1">&#39;check logs above.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_blocklist_on_aws_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">zones</span>  <span class="c1"># Unused.</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="n">stdout_splits</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">stderr_splits</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stdout_splits</span> <span class="o">+</span> <span class="n">stderr_splits</span>
            <span class="k">if</span> <span class="s1">&#39;An error occurred&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="c1"># Need to handle boto3 printing error but its retry succeeded:</span>
        <span class="c1">#   error occurred (Unsupported) .. not supported in your requested</span>
        <span class="c1">#   Availability Zone (us-west-2d)...retrying</span>
        <span class="c1">#   --&gt; it automatically succeeded in another zone</span>
        <span class="c1">#   --&gt; failed in [4/7] Running initialization commands due to user cmd</span>
        <span class="c1"># In this case, we should error out.</span>
        <span class="n">head_node_up</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;1/1&gt; Setting up head node&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout_splits</span> <span class="o">+</span> <span class="n">stderr_splits</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">errors</span> <span class="ow">or</span> <span class="n">head_node_up</span><span class="p">:</span>
            <span class="c1"># TODO: Got transient &#39;Failed to create security group&#39; that goes</span>
            <span class="c1"># away after a few minutes.  Should we auto retry other regions, or</span>
            <span class="c1"># let the user retry.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;====== stdout ======&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stdout_splits</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;====== stderr ======&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stderr_splits</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Errors occurred during provision/file_mounts/setup; &#39;</span>
                <span class="s1">&#39;check logs above.&#39;</span><span class="p">)</span>
        <span class="c1"># The underlying ray autoscaler / boto3 will try all zones of a region</span>
        <span class="c1"># at once.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got error(s) in all zones of </span><span class="si">{</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">DIM</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">messages</span><span class="si">}{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_regions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_blocklist_on_azure_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">zones</span>  <span class="c1"># Unused.</span>
        <span class="c1"># The underlying ray autoscaler will try all zones of a region at once.</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="n">stdout_splits</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">stderr_splits</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stdout_splits</span> <span class="o">+</span> <span class="n">stderr_splits</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Exception Details:&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span>
                <span class="s1">&#39;InvalidTemplateDeployment&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">errors</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;====== stdout ======&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stdout_splits</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;====== stderr ======&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stderr_splits</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Errors occurred during provision/file_mounts/setup; &#39;</span>
                <span class="s1">&#39;check logs above.&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got error(s) in </span><span class="si">{</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">DIM</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">messages</span><span class="si">}{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_regions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_blocklist_on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cloud</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span>
                                   <span class="n">stderr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handles cloud-specific errors and updates the block list.</span>

<span class="sd">        This parses textual stdout/stderr because we don&#39;t directly use the</span>
<span class="sd">        underlying clouds&#39; SDKs.  If we did that, we could catch proper</span>
<span class="sd">        exceptions instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Gang scheduling failure.  Simply block the region.</span>
            <span class="k">assert</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_regions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">GCP</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_blocklist_on_gcp_error</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">AWS</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_blocklist_on_aws_error</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">Azure</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_blocklist_on_azure_error</span><span class="p">(</span>
                <span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Unknown cloud: </span><span class="si">{</span><span class="n">cloud</span><span class="si">}</span><span class="s1">.&#39;</span>

    <span class="k">def</span> <span class="nf">_yield_region_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">:</span> <span class="n">Resources</span><span class="p">,</span> <span class="n">cluster_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cloud</span> <span class="o">=</span> <span class="n">to_provision</span><span class="o">.</span><span class="n">cloud</span>
        <span class="n">region</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">zones</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Try loading previously launched region/zones and try them first,</span>
        <span class="c1"># because we may have an existing cluster there.</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)</span>
                <span class="n">prev_resources</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span>

                <span class="k">if</span> <span class="n">prev_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cloud</span><span class="o">.</span><span class="n">is_same_cloud</span><span class="p">(</span>
                        <span class="n">prev_resources</span><span class="o">.</span><span class="n">cloud</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">clouds</span><span class="o">.</span><span class="n">AWS</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">GCP</span><span class="p">):</span>
                        <span class="n">region</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">][</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
                        <span class="n">zones</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">][</span><span class="s1">&#39;availability_zone&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">Azure</span><span class="p">):</span>
                        <span class="n">region</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
                        <span class="n">zones</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cloud</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="c1"># Happens if no previous cluster.yaml exists.</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">clouds</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zones</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">clouds</span><span class="o">.</span><span class="n">Zone</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">zone</span><span class="p">)</span> <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="n">region</span><span class="o">.</span><span class="n">set_zones</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span>
            <span class="c1"># Get the *previous* cluster status.</span>
            <span class="n">cluster_status</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_status_from_cluster_name</span><span class="p">(</span>
                <span class="n">cluster_name</span><span class="p">)</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">)</span>  <span class="c1"># Ok to yield again in the next loop.</span>

            <span class="c1"># If it reaches here: the cluster status gets set to INIT, since</span>
            <span class="c1"># a launch request was issued but failed.</span>
            <span class="c1">#</span>
            <span class="c1"># Check the *previous* cluster status. If the cluster is previously</span>
            <span class="c1"># stopped, we should not retry other regions, since the previously</span>
            <span class="c1"># attached volumes are not visible on another region.</span>
            <span class="k">if</span> <span class="n">cluster_status</span> <span class="o">==</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">ClusterStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;Failed to acquire resources to restart the stopped &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;cluster </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s1">. Please retry again &#39;</span>
                    <span class="s1">&#39;later.&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="c1"># Reset to STOPPED (rather than keeping it at INIT), because</span>
                <span class="c1"># (1) the cluster is not up (2) it ensures future `sky start`</span>
                <span class="c1"># will disable auto-failover too.</span>
                <span class="n">global_user_state</span><span class="o">.</span><span class="n">set_cluster_status</span><span class="p">(</span>
                    <span class="n">cluster_name</span><span class="p">,</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">ClusterStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">)</span>

                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ResourcesUnavailableError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span>
                                                           <span class="n">no_retry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span> <span class="ow">in</span> <span class="n">cloud</span><span class="o">.</span><span class="n">region_zones_provision_loop</span><span class="p">(</span>
                <span class="n">instance_type</span><span class="o">=</span><span class="n">to_provision</span><span class="o">.</span><span class="n">instance_type</span><span class="p">,</span>
                <span class="n">accelerators</span><span class="o">=</span><span class="n">to_provision</span><span class="o">.</span><span class="n">accelerators</span><span class="p">,</span>
                <span class="n">use_spot</span><span class="o">=</span><span class="n">to_provision</span><span class="o">.</span><span class="n">use_spot</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_try_provision_tpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">:</span> <span class="n">Resources</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns whether the provision is successful.&quot;&quot;&quot;</span>
        <span class="n">tpu_name</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;tpu_name&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s1">&#39;tpu-create-script&#39;</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">,</span> \
            <span class="s1">&#39;Expect TPU provisioning with gcloud.&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">backend_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bash </span><span class="si">{</span><span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;tpu-create-script&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                              <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;ALREADY_EXISTS&#39;</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="c1"># FIXME: should use &#39;start&#39; on stopped TPUs, replacing</span>
                <span class="c1"># &#39;create&#39;. Or it can be in a &quot;deleting&quot; state. Investigate the</span>
                <span class="c1"># right thing to do (force kill + re-provision?).</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TPU </span><span class="si">{</span><span class="n">tpu_name</span><span class="si">}</span><span class="s1"> already exists; skipped creation.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="s1">&#39;RESOURCE_EXHAUSTED&#39;</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;TPU </span><span class="si">{</span><span class="n">tpu_name</span><span class="si">}</span><span class="s1"> creation failed due to quota exhaustion. &#39;</span>
                    <span class="s1">&#39;Please visit &#39;</span>
                    <span class="s1">&#39;https://console.cloud.google.com/iam-admin/quotas for more&#39;</span>
                    <span class="s1">&#39; information.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="s1">&#39;PERMISSION_DENIED&#39;</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;TPUs are not available in this zone.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="s1">&#39;no more capacity in the zone&#39;</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No more capacity in this zone.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="s1">&#39;CloudTpu received an invalid AcceleratorType&#39;</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="c1"># INVALID_ARGUMENT: CloudTpu received an invalid</span>
                <span class="c1"># AcceleratorType, &quot;v3-8&quot; for zone &quot;us-central1-c&quot;. Valid</span>
                <span class="c1"># values are &quot;v2-8, &quot;.</span>
                <span class="n">tpu_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">to_provision</span><span class="o">.</span><span class="n">accelerators</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;TPU type </span><span class="si">{</span><span class="n">tpu_type</span><span class="si">}</span><span class="s1"> is not available in this zone.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">_retry_region_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">:</span> <span class="n">Resources</span><span class="p">,</span>
                            <span class="n">num_nodes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dryrun</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">stream_logs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                            <span class="n">cluster_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">prev_cluster_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot;The provision retry loop.&quot;&quot;&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="c1"># Get log_path name</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;provision.log&#39;</span><span class="p">)</span>
        <span class="n">log_abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
        <span class="n">tail_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;tail -n100 -f </span><span class="si">{</span><span class="n">log_path</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;To view detailed progress: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}{</span><span class="n">tail_cmd</span><span class="si">}{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_blocklist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yield_region_zones</span><span class="p">(</span><span class="n">to_provision</span><span class="p">,</span>
                                                      <span class="n">cluster_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_blocklist</span><span class="p">(</span><span class="n">to_provision</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">zones</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">zone_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">z</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">)</span> <span class="k">if</span> <span class="n">zones</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;all zones&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}</span><span class="s1">Launching on </span><span class="si">{</span><span class="n">to_provision</span><span class="o">.</span><span class="n">cloud</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">zone_str</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">write_cluster_config</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="n">to_provision</span><span class="p">,</span>
                <span class="n">num_nodes</span><span class="p">,</span>
                <span class="n">_get_cluster_config_template</span><span class="p">(</span><span class="n">to_provision</span><span class="o">.</span><span class="n">cloud</span><span class="p">),</span>
                <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">zones</span><span class="o">=</span><span class="n">zones</span><span class="p">,</span>
                <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">,</span>
                <span class="n">cluster_name</span><span class="o">=</span><span class="n">cluster_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">tpu_name</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tpu_name&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tpu_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_provision_tpu</span><span class="p">(</span><span class="n">to_provision</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">cluster_config_file</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;ray&#39;</span><span class="p">]</span>

            <span class="c1"># Record early, so if anything goes wrong, &#39;sky status&#39; will show</span>
            <span class="c1"># the cluster name and users can appropriately &#39;sky down&#39;.  It also</span>
            <span class="c1"># means a second &#39;sky launch -c &lt;name&gt;&#39; will attempt to reuse.</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">CloudVmRayBackend</span><span class="o">.</span><span class="n">ResourceHandle</span><span class="p">(</span>
                <span class="n">cluster_name</span><span class="o">=</span><span class="n">cluster_name</span><span class="p">,</span>
                <span class="n">cluster_yaml</span><span class="o">=</span><span class="n">cluster_config_file</span><span class="p">,</span>
                <span class="n">launched_nodes</span><span class="o">=</span><span class="n">num_nodes</span><span class="p">,</span>
                <span class="c1"># OK for this to be shown in CLI as status == INIT.</span>
                <span class="n">launched_resources</span><span class="o">=</span><span class="n">to_provision</span><span class="p">,</span>
                <span class="n">tpu_create_script</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tpu-create-script&#39;</span><span class="p">),</span>
                <span class="n">tpu_delete_script</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tpu-delete-script&#39;</span><span class="p">))</span>
            <span class="n">global_user_state</span><span class="o">.</span><span class="n">add_or_update_cluster</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span>
                                                    <span class="n">cluster_handle</span><span class="o">=</span><span class="n">handle</span><span class="p">,</span>
                                                    <span class="n">ready</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">gang_failed</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gang_schedule_ray_up</span><span class="p">(</span>
                <span class="n">to_provision</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">cluster_config_file</span><span class="p">,</span>
                <span class="n">log_abs_path</span><span class="p">,</span> <span class="n">stream_logs</span><span class="p">,</span> <span class="n">prev_cluster_config</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">gang_failed</span> <span class="ow">or</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gang_failed</span><span class="p">:</span>
                    <span class="c1"># There exist partial nodes (e.g., head node) so we must</span>
                    <span class="c1"># down before moving on to other regions.</span>
                    <span class="c1"># FIXME(zongheng): terminating a potentially live cluster</span>
                    <span class="c1"># is scary.  Say: users have an existing cluster, do sky</span>
                    <span class="c1"># launch, gang failed, then we are terminating it here.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;*** Failed provisioning the cluster. ***&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;====== stdout ======&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;====== stderr ======&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;*** Tearing down the failed cluster. ***&#39;</span><span class="p">)</span>
                    <span class="n">CloudVmRayBackend</span><span class="p">()</span><span class="o">.</span><span class="n">teardown</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_blocklist_on_error</span><span class="p">(</span>
                        <span class="n">to_provision</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span>
                        <span class="n">region</span><span class="p">,</span>
                        <span class="c1"># Ignored and block region:</span>
                        <span class="n">zones</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_blocklist_on_error</span><span class="p">(</span><span class="n">to_provision</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span>
                                                    <span class="n">zones</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Success.</span>

                <span class="c1"># However, ray processes may not be up due to &#39;ray up</span>
                <span class="c1"># --no-restart&#39; flag.  Ensure so.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_cluster_ray_started</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">log_abs_path</span><span class="p">)</span>

                <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;cluster_name&#39;</span><span class="p">]</span>
                <span class="n">plural</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;s&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}</span><span class="s1">Successfully provisioned or found&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39; existing VM</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s1">. Setup completed.</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">config_dict</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Failed to acquire resources in all regions/zones&#39;</span>
                   <span class="sa">f</span><span class="s1">&#39; (requested </span><span class="si">{</span><span class="n">to_provision</span><span class="si">}</span><span class="s1">).&#39;</span>
                   <span class="s1">&#39; Try changing resource requirements or use another cloud.&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ResourcesUnavailableError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_gang_schedule_ray_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_provision_cloud</span><span class="p">:</span> <span class="n">clouds</span><span class="o">.</span><span class="n">Cloud</span><span class="p">,</span>
                              <span class="n">num_nodes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cluster_config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">log_abs_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stream_logs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                              <span class="n">prev_cluster_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot;Provisions a cluster via &#39;ray up&#39; with gang scheduling.</span>

<span class="sd">        Steps for provisioning &gt; 1 node:</span>
<span class="sd">          1) ray up an empty config (no filemounts, no setup commands)</span>
<span class="sd">          2) ray up a full config (with filemounts and setup commands)</span>

<span class="sd">        For provisioning 1 node, only step 2 is run.</span>

<span class="sd">        Benefits:</span>
<span class="sd">          - Ensures all nodes are allocated first before potentially expensive</span>
<span class="sd">            file_mounts/setup.  (If not all nodes aren&#39;t allocated, step 1</span>
<span class="sd">            would fail.)</span>

<span class="sd">        Returns:</span>
<span class="sd">          (did gang scheduling failed; proc; stdout; stderr).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>

        <span class="k">def</span> <span class="nf">ray_up</span><span class="p">(</span><span class="n">start_streaming_at</span><span class="p">):</span>
            <span class="c1"># Redirect stdout/err to the file and streaming (if stream_logs).</span>
            <span class="c1"># With stdout/err redirected, &#39;ray up&#39; will have no color and</span>
            <span class="c1"># different order from directly running in the console. The</span>
            <span class="c1"># `--log-style` and `--log-color` flags do not work. To reproduce,</span>
            <span class="c1"># `ray up --log-style pretty --log-color true | tee tmp.out`.</span>
            <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">log_lib</span><span class="o">.</span><span class="n">run_with_log</span><span class="p">(</span>
                <span class="c1"># NOTE: --no-restart solves the following bug.  Without it, if</span>
                <span class="c1"># &#39;ray up&#39; (sky launch) twice on a cluster with &gt;1 node, the</span>
                <span class="c1"># worker node gets disconnected/killed by ray autoscaler; the</span>
                <span class="c1"># whole task will just freeze.  (Doesn&#39;t affect 1-node</span>
                <span class="c1"># clusters.)  With this flag, ray processes no longer restart</span>
                <span class="c1"># and this bug doesn&#39;t show.  Downside is existing tasks on the</span>
                <span class="c1"># cluster will keep running (which may be ok with the semantics</span>
                <span class="c1"># of &#39;sky launch&#39; twice).</span>
                <span class="c1"># Tracked in https://github.com/ray-project/ray/issues/20402.</span>
                <span class="p">[</span><span class="s1">&#39;ray&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;-y&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-restart&#39;</span><span class="p">,</span> <span class="n">cluster_config_file</span><span class="p">],</span>
                <span class="n">log_abs_path</span><span class="p">,</span>
                <span class="n">stream_logs</span><span class="p">,</span>
                <span class="n">start_streaming_at</span><span class="o">=</span><span class="n">start_streaming_at</span><span class="p">,</span>
                <span class="c1"># Reduce BOTO_MAX_RETRIES from 12 to 5 to avoid long hanging</span>
                <span class="c1"># time during &#39;ray up&#39; if insufficient capacity occurs.</span>
                <span class="n">env</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">BOTO_MAX_RETRIES</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

        <span class="k">def</span> <span class="nf">is_cluster_yaml_identical</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">prev_cluster_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">curr_config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">cluster_config_file</span><span class="p">)</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">curr_config</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prev_cluster_config</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">curr</span> <span class="o">==</span> <span class="n">prev</span>

        <span class="n">ray_up_on_full_confg_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Fast paths for &quot;no need to gang schedule&quot;:</span>
        <span class="c1">#  (1) num_nodes == 1, no need to pre-provision.</span>
        <span class="c1">#  (2) otherwise, if cluster configs have not changed, no need either.</span>
        <span class="c1">#    TODO: can relax further: if (num_nodes x requested_resources) now</span>
        <span class="c1">#    == existing, then skip Step 1.  Requested resources =</span>
        <span class="c1">#    cloud(instance_type, acc, acc_args).  If requested clouds are</span>
        <span class="c1">#    different, we still need to gang schedule on the new cloud.</span>
        <span class="k">if</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># ray up the full yaml.</span>
            <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ray_up</span><span class="p">(</span>
                <span class="n">start_streaming_at</span><span class="o">=</span><span class="s1">&#39;Shared connection to&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>
        <span class="k">elif</span> <span class="n">is_cluster_yaml_identical</span><span class="p">():</span>
            <span class="n">ray_up_on_full_confg_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># NOTE: consider the exceptional case where cluster yamls are</span>
            <span class="c1"># identical, but existing cluster has a few nodes killed (e.g.,</span>
            <span class="c1"># spot).  For that case, we ray up once on the full config, instead</span>
            <span class="c1"># of doing gang schedule first.  This seems an ok tradeoff because</span>
            <span class="c1"># (1) checking how many nodes remain maybe slow, a price the common</span>
            <span class="c1"># cases should not pay; (2) setup on the (presumably live) head</span>
            <span class="c1"># node is likely no-op.  We can revisit.</span>

        <span class="c1"># Step 1: ray up the emptied config.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ray_up_on_full_confg_only</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">cluster_config_file</span><span class="p">)</span>
            <span class="n">pinned_ray_install</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pip3 install -U &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;ray[default]==</span><span class="si">{</span><span class="n">SKY_REMOTE_RAY_VERSION</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">file_mounts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;ssh_public_key&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="c1"># For Azure, we need to add ssh public key to VM by filemounts.</span>
                <span class="n">public_key_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;ssh_public_key&#39;</span><span class="p">]</span>
                <span class="n">file_mounts</span><span class="p">[</span><span class="n">public_key_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">public_key_path</span>

            <span class="k">if</span> <span class="n">SKYLET_REMOTE_PATH</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_mounts&#39;</span><span class="p">]:</span>
                <span class="n">file_mounts</span><span class="p">[</span><span class="n">SKYLET_REMOTE_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_mounts&#39;</span><span class="p">][</span>
                    <span class="n">SKYLET_REMOTE_PATH</span><span class="p">]</span>

            <span class="n">fields_to_empty</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;file_mounts&#39;</span><span class="p">:</span> <span class="n">file_mounts</span><span class="p">,</span>
                <span class="c1"># Need ray for &#39;ray status&#39; in wait_until_ray_cluster_ready().</span>
                <span class="c1"># Need sky for external node provider.</span>
                <span class="s1">&#39;setup_commands&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;setup_commands&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">existing_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields_to_empty</span><span class="p">}</span>
            <span class="c1"># Keep both in sync.</span>
            <span class="k">assert</span> <span class="n">pinned_ray_install</span> <span class="ow">in</span> <span class="n">existing_fields</span><span class="p">[</span><span class="s1">&#39;setup_commands&#39;</span><span class="p">][</span>
                <span class="mi">0</span><span class="p">],</span> <span class="n">existing_fields</span><span class="p">[</span><span class="s1">&#39;setup_commands&#39;</span><span class="p">]</span>
            <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fields_to_empty</span><span class="p">)</span>
            <span class="n">backend_utils</span><span class="o">.</span><span class="n">dump_yaml</span><span class="p">(</span><span class="n">cluster_config_file</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ray_up</span><span class="p">(</span><span class="n">start_streaming_at</span><span class="o">=</span><span class="s1">&#39;Shared connection to&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Head node provisioning failure.</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}</span><span class="s1">Successfully provisioned or found&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39; existing head VM. Waiting for workers.</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># FIXME(zongheng): the below requires ray processes are up on head. To</span>
        <span class="c1"># repro it failing: launch a 2-node cluster, log into head and ray</span>
        <span class="c1"># stop, then launch again.</span>
        <span class="c1"># TODO: if requesting a large amount (say 32) of expensive VMs, this</span>
        <span class="c1"># may loop for a long time.  Use timeouts and treat as gang_failed.</span>
        <span class="n">cluster_ready</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">wait_until_ray_cluster_ready</span><span class="p">(</span>
            <span class="n">to_provision_cloud</span><span class="p">,</span> <span class="n">cluster_config_file</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">)</span>
        <span class="n">gang_failed</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">cluster_ready</span>
        <span class="k">if</span> <span class="n">gang_failed</span> <span class="ow">or</span> <span class="n">ray_up_on_full_confg_only</span><span class="p">:</span>
            <span class="c1"># Head OK; gang scheduling failure.</span>
            <span class="k">return</span> <span class="n">gang_failed</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

        <span class="c1"># Step 2: ray up the full config (file mounts, setup).</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">existing_fields</span><span class="p">)</span>
        <span class="n">backend_utils</span><span class="o">.</span><span class="n">dump_yaml</span><span class="p">(</span><span class="n">cluster_config_file</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}</span><span class="s1">Starting to set up the cluster.</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ray_up</span><span class="p">(</span>
            <span class="c1"># FIXME: Not ideal. The setup log (pip install) will be streamed</span>
            <span class="c1"># first, before the ray autoscaler&#39;s step-by-step output (&lt;1/1&gt;</span>
            <span class="c1"># Setting up head node). Probably some buffering or</span>
            <span class="c1"># stdout-vs-stderr bug?  We want the latter to show first, not</span>
            <span class="c1"># printed in the end.</span>
            <span class="n">start_streaming_at</span><span class="o">=</span><span class="s1">&#39;Shared connection to&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

    <span class="k">def</span> <span class="nf">_ensure_cluster_ray_started</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">handle</span><span class="p">:</span> <span class="s1">&#39;CloudVmRayBackend.ResourceHandle&#39;</span><span class="p">,</span>
                                    <span class="n">log_abs_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensures ray processes are up on a just-provisioned cluster.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># FIXME(zongheng): this has NOT been tested with multinode</span>
            <span class="c1"># clusters; mainly because this function will not be reached in</span>
            <span class="c1"># that case.  See #140 for details.  If it were reached, the</span>
            <span class="c1"># following logic might work:</span>
            <span class="c1">#   - get all node ips</span>
            <span class="c1">#   - for all nodes: ray stop</span>
            <span class="c1">#   - ray up --restart-only</span>
            <span class="k">return</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">CloudVmRayBackend</span><span class="p">()</span>
        <span class="n">proc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span>
            <span class="n">handle</span><span class="p">,</span>
            <span class="s1">&#39;ray status&#39;</span><span class="p">,</span>
            <span class="c1"># At this state, an erroneous cluster may not have cached</span>
            <span class="c1"># handle.head_ip (global_user_state.add_or_update_cluster(...,</span>
            <span class="c1"># ready=True)).</span>
            <span class="n">use_cached_head_ip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s1">&#39;ray stop&#39;</span><span class="p">,</span> <span class="n">use_cached_head_ip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">log_lib</span><span class="o">.</span><span class="n">run_with_log</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ray&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;-y&#39;</span><span class="p">,</span> <span class="s1">&#39;--restart-only&#39;</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">],</span>
            <span class="n">log_abs_path</span><span class="p">,</span>
            <span class="n">stream_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="RetryingVmProvisioner.provision_with_retries"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.RetryingVmProvisioner.provision_with_retries">[docs]</a>    <span class="k">def</span> <span class="nf">provision_with_retries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">:</span> <span class="n">Resources</span><span class="p">,</span>
                               <span class="n">num_nodes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dryrun</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">stream_logs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                               <span class="n">cluster_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provision with retries for all launchable resources.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">cluster_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;cluster_name must be specified.&#39;</span>
        <span class="n">launchable_retries_disabled</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">prev_handle</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span>
            <span class="n">cluster_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev_handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prev_cluster_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prev_cluster_config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span>
                    <span class="n">prev_handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">prev_cluster_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="c1"># Retrying launchable resources.</span>
        <span class="n">provision_failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">provision_failed</span><span class="p">:</span>
            <span class="n">provision_failed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_region_zones</span><span class="p">(</span>
                    <span class="n">task</span><span class="p">,</span>
                    <span class="n">to_provision</span><span class="p">,</span>
                    <span class="n">num_nodes</span><span class="p">,</span>
                    <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">,</span>
                    <span class="n">stream_logs</span><span class="o">=</span><span class="n">stream_logs</span><span class="p">,</span>
                    <span class="n">cluster_name</span><span class="o">=</span><span class="n">cluster_name</span><span class="p">,</span>
                    <span class="n">prev_cluster_config</span><span class="o">=</span><span class="n">prev_cluster_config</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;launched_resources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_provision</span>
            <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ResourcesUnavailableError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">no_retry</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">if</span> <span class="n">launchable_retries_disabled</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;DAG and optimize_target needs to be registered first &#39;</span>
                        <span class="s1">&#39;to enable cross-cloud retry. &#39;</span>
                        <span class="s1">&#39;To fix, call backend.register_info(dag=dag, &#39;</span>
                        <span class="s1">&#39;optimize_target=sky.OptimizeTarget.COST)&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="n">provision_failed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}</span><span class="s1">Provision failed for </span><span class="si">{</span><span class="n">to_provision</span><span class="si">}</span><span class="s1">. &#39;</span>
                    <span class="s1">&#39;Trying other launchable resources (if any)...&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># Add failed resources to the blocklist.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_launchable_resources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">to_provision</span><span class="p">)</span>
                <span class="c1"># Set to None so that sky.optimize() will assign a new one</span>
                <span class="c1"># (otherwise will skip re-optimizing this task).</span>
                <span class="c1"># TODO: set all remaining tasks&#39; best_resources to None.</span>
                <span class="n">task</span><span class="o">.</span><span class="n">best_resources</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dag</span><span class="p">,</span>
                                         <span class="n">minimize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimize_target</span><span class="p">,</span>
                                         <span class="n">blocked_launchable_resources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span>
                                         <span class="n">_blocked_launchable_resources</span><span class="p">)</span>
                <span class="n">to_provision</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">best_resources</span>
                <span class="k">assert</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="s1">&#39;Internal logic error.&#39;</span>
                <span class="k">assert</span> <span class="n">to_provision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">task</span>
        <span class="k">return</span> <span class="n">config_dict</span></div></div>


<div class="viewcode-block" id="CloudVmRayBackend"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend">[docs]</a><span class="k">class</span> <span class="nc">CloudVmRayBackend</span><span class="p">(</span><span class="n">backends</span><span class="o">.</span><span class="n">Backend</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Backend: runs on cloud virtual machines, managed by Ray.</span>

<span class="sd">    Changing this class may also require updates to:</span>
<span class="sd">      * Cloud providers&#39; templates under config/</span>
<span class="sd">      * Cloud providers&#39; implementations under clouds/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s1">&#39;cloudvmray&#39;</span>

<div class="viewcode-block" id="CloudVmRayBackend.ResourceHandle"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.ResourceHandle">[docs]</a>    <span class="k">class</span> <span class="nc">ResourceHandle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A pickle-able tuple of:</span>

<span class="sd">        - (required) Cluster name.</span>
<span class="sd">        - (required) Path to a cluster.yaml file.</span>
<span class="sd">        - (optional) A cached head node public IP.  Filled in after a</span>
<span class="sd">            successful provision().</span>
<span class="sd">        - (optional) Launched num nodes</span>
<span class="sd">        - (optional) Launched resources</span>
<span class="sd">        - (optional) If TPU(s) are managed, a path to a deletion script.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">cluster_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">cluster_yaml</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">head_ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">launched_nodes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">launched_resources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Resources</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">tpu_create_script</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">tpu_delete_script</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_yaml</span> <span class="o">=</span> <span class="n">cluster_yaml</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head_ip</span> <span class="o">=</span> <span class="n">head_ip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">launched_nodes</span> <span class="o">=</span> <span class="n">launched_nodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">launched_resources</span> <span class="o">=</span> <span class="n">launched_resources</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpu_create_script</span> <span class="o">=</span> <span class="n">tpu_create_script</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpu_delete_script</span> <span class="o">=</span> <span class="n">tpu_delete_script</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ResourceHandle(&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">cluster_name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">,&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">head_ip=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">head_ip</span><span class="si">}</span><span class="s1">,&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">cluster_yaml=&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">launched_resources=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">launched_nodes</span><span class="si">}</span><span class="s1">x &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">launched_resources</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">tpu_create_script=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tpu_create_script</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">tpu_delete_script=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tpu_delete_script</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="CloudVmRayBackend.ResourceHandle.get_cluster_name"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.ResourceHandle.get_cluster_name">[docs]</a>        <span class="k">def</span> <span class="nf">get_cluster_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span></div></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_timestamp</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">get_run_timestamp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SKY_LOGS_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_timestamp</span><span class="p">)</span>
        <span class="c1"># Do not make directories to avoid create folder for commands that</span>
        <span class="c1"># do not need it (`sky status`, `sky logs` ...)</span>
        <span class="c1"># os.makedirs(self.log_dir, exist_ok=True)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_target</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CloudVmRayBackend.register_info"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.register_info">[docs]</a>    <span class="k">def</span> <span class="nf">register_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dag&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_target</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;optimize_target&#39;</span><span class="p">,</span>
                                           <span class="n">OptimizeTarget</span><span class="o">.</span><span class="n">COST</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_task_resources_smaller_than_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span>
                                                   <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if resources requested by the task are available.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">resources</span>

        <span class="n">launched_resources</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span>
        <span class="n">task_resources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># requested_resources &lt;= actual_resources.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">&lt;=</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span> <span class="ow">and</span>
                <span class="n">task_resources</span><span class="o">.</span><span class="n">less_demanding_than</span><span class="p">(</span><span class="n">launched_resources</span><span class="p">)):</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">cluster_name</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ResourcesMismatchError</span><span class="p">(</span>
                <span class="s1">&#39;Requested resources do not match the existing cluster.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;  Requested: </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span><span class="si">}</span><span class="s1">x </span><span class="si">{</span><span class="n">task_resources</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;  Existing: </span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span><span class="si">}</span><span class="s1">x &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;To fix: specify a new cluster name, or down the &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;existing cluster first: sky down </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_existing_cluster</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">:</span> <span class="n">Resources</span><span class="p">,</span>
            <span class="n">cluster_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Resources</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Cluster already exists.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_task_resources_smaller_than_cluster</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
            <span class="c1"># Use the existing cluster.</span>
            <span class="k">assert</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="p">,</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s1">Creating a new cluster: &quot;</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span><span class="si">}</span><span class="s1">x </span><span class="si">{</span><span class="n">to_provision</span><span class="si">}</span><span class="s1">].</span><span class="si">{</span><span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;Tip: to reuse an existing cluster, &#39;</span>
            <span class="s1">&#39;specify --cluster-name (-c) in the CLI or use &#39;</span>
            <span class="s1">&#39;sky.launch(.., cluster_name=..) in the Python API. &#39;</span>
            <span class="s1">&#39;Run `sky status` to see existing clusters.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_name</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span>

    <span class="k">def</span> <span class="nf">_set_tpu_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster_config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                      <span class="n">tpu_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sets TPU_NAME on all nodes.&quot;&quot;&quot;</span>
        <span class="n">ip_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_ips</span><span class="p">(</span><span class="n">cluster_config_file</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">)</span>
        <span class="n">ssh_user</span><span class="p">,</span> <span class="n">ssh_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ssh_credential</span><span class="p">(</span>
            <span class="n">cluster_config_file</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ip_list</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[[ -z $TPU_NAME ]] &amp;&amp; echo &quot;export TPU_NAME=</span><span class="si">{</span><span class="n">tpu_name</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                   <span class="s1">&#39;&gt;&gt; ~/.bashrc || echo &quot;TPU_NAME already set&quot;&#39;</span><span class="p">)</span>
            <span class="n">backend_utils</span><span class="o">.</span><span class="n">run_command_on_ip_via_ssh</span><span class="p">(</span>
                <span class="n">ip</span><span class="p">,</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">ssh_user</span><span class="o">=</span><span class="n">ssh_user</span><span class="p">,</span>
                <span class="n">ssh_private_key</span><span class="o">=</span><span class="n">ssh_private_key</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="CloudVmRayBackend.provision"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.provision">[docs]</a>    <span class="k">def</span> <span class="nf">provision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
                  <span class="n">to_provision</span><span class="p">:</span> <span class="n">Resources</span><span class="p">,</span>
                  <span class="n">dryrun</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">stream_logs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">cluster_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provisions using &#39;ray up&#39;.&quot;&quot;&quot;</span>
        <span class="c1"># Try to launch the exiting cluster first</span>
        <span class="k">if</span> <span class="n">cluster_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">generate_cluster_name</span><span class="p">()</span>
        <span class="n">_check_cluster_name_is_valid</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">)</span>
        <span class="c1"># ray up: the VMs.</span>
        <span class="c1"># FIXME: ray up for Azure with different cluster_names will overwrite</span>
        <span class="c1"># each other.</span>
        <span class="n">provisioner</span> <span class="o">=</span> <span class="n">RetryingVmProvisioner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_target</span><span class="p">)</span>

        <span class="n">launched_nodes</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>  <span class="c1"># dry run doesn&#39;t need to check existing cluster.</span>
            <span class="n">cluster_name</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">,</span> <span class="n">launched_nodes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_existing_cluster</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">,</span> <span class="n">cluster_name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">provisioner</span><span class="o">.</span><span class="n">provision_with_retries</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">to_provision</span><span class="p">,</span> <span class="n">launched_nodes</span><span class="p">,</span> <span class="n">dryrun</span><span class="p">,</span> <span class="n">stream_logs</span><span class="p">,</span>
                <span class="n">cluster_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ResourcesUnavailableError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Do not remove the stopped cluster from the global state if failed</span>
            <span class="c1"># to start.</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">no_retry</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="c1"># Clean up the cluster&#39;s entry in `sky status`.</span>
            <span class="n">global_user_state</span><span class="o">.</span><span class="n">remove_cluster</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ResourcesUnavailableError</span><span class="p">(</span>
                <span class="s1">&#39;Failed to provision all possible launchable resources. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Relax the task</span><span class="se">\&#39;</span><span class="s1">s resource requirements:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">launched_nodes</span><span class="si">}</span><span class="s1">x &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">cluster_config_file</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;ray&#39;</span><span class="p">]</span>
        <span class="n">provisioned_resources</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;launched_resources&#39;</span><span class="p">]</span>

        <span class="c1"># Set TPU environment variables</span>
        <span class="n">tpu_name</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tpu_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tpu_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_tpu_name</span><span class="p">(</span><span class="n">cluster_config_file</span><span class="p">,</span> <span class="n">launched_nodes</span><span class="p">,</span> <span class="n">tpu_name</span><span class="p">)</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ResourceHandle</span><span class="p">(</span>
            <span class="n">cluster_name</span><span class="o">=</span><span class="n">cluster_name</span><span class="p">,</span>
            <span class="n">cluster_yaml</span><span class="o">=</span><span class="n">cluster_config_file</span><span class="p">,</span>
            <span class="c1"># Cache head ip in the handle to speed up ssh operations.</span>
            <span class="n">head_ip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_node_ips</span><span class="p">(</span><span class="n">cluster_config_file</span><span class="p">,</span> <span class="n">launched_nodes</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">launched_nodes</span><span class="o">=</span><span class="n">launched_nodes</span><span class="p">,</span>
            <span class="n">launched_resources</span><span class="o">=</span><span class="n">provisioned_resources</span><span class="p">,</span>
            <span class="c1"># TPU.</span>
            <span class="n">tpu_create_script</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tpu-create-script&#39;</span><span class="p">),</span>
            <span class="n">tpu_delete_script</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tpu-delete-script&#39;</span><span class="p">))</span>
        <span class="n">global_user_state</span><span class="o">.</span><span class="n">add_or_update_cluster</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span>
                                                <span class="n">handle</span><span class="p">,</span>
                                                <span class="n">ready</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">auth_config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span>
        <span class="n">_add_cluster_to_ssh_config</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">head_ip</span><span class="p">,</span> <span class="n">auth_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handle</span></div>

<div class="viewcode-block" id="CloudVmRayBackend.sync_workdir"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.sync_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">sync_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span> <span class="n">workdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Even though provision() takes care of it, there may be cases where</span>
        <span class="c1"># this function is called in isolation, without calling provision(),</span>
        <span class="c1"># e.g., in CLI.  So we should rerun rsync_up.</span>
        <span class="n">fore</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="n">ip_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_ips</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span><span class="p">)</span>
        <span class="c1"># TODO(zhwu): make this in parallel</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ip_list</span><span class="p">):</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;worker</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;head&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fore</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s1">Syncing: </span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}</span><span class="s1"> workdir -&gt; </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsync_up</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                           <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
                           <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">,</span>
                           <span class="n">target</span><span class="o">=</span><span class="n">SKY_REMOTE_WORKDIR</span><span class="p">,</span>
                           <span class="n">with_outputs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudVmRayBackend.sync_file_mounts"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.sync_file_mounts">[docs]</a>    <span class="k">def</span> <span class="nf">sync_file_mounts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span>
        <span class="n">all_file_mounts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">cloud_to_remote_file_mounts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># &#39;all_file_mounts&#39; should be handled, since the provision will not</span>
        <span class="c1"># update the file_mounts for workers.</span>
        <span class="n">mounts</span> <span class="o">=</span> <span class="n">all_file_mounts</span>
        <span class="k">if</span> <span class="n">mounts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mounts</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">fore</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="n">cyan</span> <span class="o">=</span> <span class="n">fore</span><span class="o">.</span><span class="n">CYAN</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span>
        <span class="n">bright</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cyan</span><span class="si">}</span><span class="s1">Processing cloud to VM file mounts.</span><span class="si">{</span><span class="n">reset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">ip_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_ips</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span><span class="p">)</span>
        <span class="n">ssh_user</span><span class="p">,</span> <span class="n">ssh_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ssh_credential</span><span class="p">(</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">sync_to_all_nodes</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># TODO(zhwu): make this in parallel</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ip_list</span><span class="p">):</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;worker</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;head&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cyan</span><span class="si">}</span><span class="s1"> Syncing (on </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s1">): &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bright</span><span class="si">}{</span><span class="n">src</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">}{</span><span class="n">reset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">backend_utils</span><span class="o">.</span><span class="n">run_command_on_ip_via_ssh</span><span class="p">(</span>
                        <span class="n">ip</span><span class="p">,</span>
                        <span class="n">command</span><span class="p">,</span>
                        <span class="n">ssh_user</span><span class="o">=</span><span class="n">ssh_user</span><span class="p">,</span>
                        <span class="n">ssh_private_key</span><span class="o">=</span><span class="n">ssh_private_key</span><span class="p">,</span>
                        <span class="n">log_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;file_mounts.log&#39;</span><span class="p">),</span>
                        <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">ssh_control_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssh_control_name</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rsync_up</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                                   <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
                                   <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span>
                                   <span class="n">target</span><span class="o">=</span><span class="n">dst</span><span class="p">,</span>
                                   <span class="n">with_outputs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">mounts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># TODO: room for improvement.  Here there are many moving parts</span>
            <span class="c1"># (download gsutil on remote, run gsutil on remote).  Consider</span>
            <span class="c1"># alternatives (smart_open, each provider&#39;s own sdk), a</span>
            <span class="c1"># data-transfer container etc.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dst</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;~/&#39;</span><span class="p">):</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;~/</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">use_symlink_trick</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Sync &#39;src&#39; to &#39;wrapped_dst&#39;, a safe-to-write &quot;wrapped&quot; path.</span>
            <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;~/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dst</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="p">):</span>
                <span class="c1"># Skip as these should be writable locations.</span>
                <span class="n">wrapped_dst</span> <span class="o">=</span> <span class="n">dst</span>
                <span class="n">use_symlink_trick</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wrapped_dst</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">FileMountHelper</span><span class="o">.</span><span class="n">wrap_file_mount</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">task_lib</span><span class="o">.</span><span class="n">is_cloud_store_url</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                <span class="n">sync_to_all_nodes</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wrapped_dst</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">storage</span> <span class="o">=</span> <span class="n">cloud_stores</span><span class="o">.</span><span class="n">get_storage_from_path</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">storage</span><span class="o">.</span><span class="n">is_directory</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                <span class="n">sync</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">make_sync_dir_command</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span>
                                                     <span class="n">destination</span><span class="o">=</span><span class="n">wrapped_dst</span><span class="p">)</span>
                <span class="c1"># It is a directory so make sure it exists.</span>
                <span class="n">mkdir_for_wrapped_dst</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;mkdir -p </span><span class="si">{</span><span class="n">wrapped_dst</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sync</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">make_sync_file_command</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span>
                                                      <span class="n">destination</span><span class="o">=</span><span class="n">wrapped_dst</span><span class="p">)</span>
                <span class="c1"># It is a file so make sure *its parent dir* exists.</span>
                <span class="n">mkdir_for_wrapped_dst</span> <span class="o">=</span> \
                    <span class="sa">f</span><span class="s1">&#39;mkdir -p </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">wrapped_dst</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">download_target_commands</span> <span class="o">=</span> <span class="p">[</span>
                <span class="c1"># Ensure sync can write to wrapped_dst (e.g., &#39;/data/&#39;).</span>
                <span class="n">mkdir_for_wrapped_dst</span><span class="p">,</span>
                <span class="c1"># Both the wrapped and the symlink dir exist; sync.</span>
                <span class="n">sync</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_symlink_trick</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39; &amp;&amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_target_commands</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Goal: point dst --&gt; wrapped_dst.</span>
                <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">backend_utils</span><span class="o">.</span><span class="n">FileMountHelper</span><span class="o">.</span><span class="n">make_safe_symlink_command</span><span class="p">(</span>
                        <span class="n">source</span><span class="o">=</span><span class="n">dst</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">=</span><span class="n">wrapped_dst</span><span class="p">,</span>
                        <span class="n">download_target_commands</span><span class="o">=</span><span class="n">download_target_commands</span><span class="p">))</span>

            <span class="n">sync_to_all_nodes</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudVmRayBackend.sync_down_logs"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.sync_down_logs">[docs]</a>    <span class="k">def</span> <span class="nf">sync_down_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">JobLibCodeGen</span><span class="p">()</span>
        <span class="n">codegen</span><span class="o">.</span><span class="n">get_log_path</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">stream_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">local_log_dir</span> <span class="o">=</span> <span class="n">log_dir</span>
        <span class="n">remote_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SKY_REMOTE_LOGS_ROOT</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">)</span>

        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="n">fore</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fore</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s1">Logs Directory: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}{</span><span class="n">local_log_dir</span><span class="si">}{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">ips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_ips</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rsync_down</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ray.autoscaler</span> <span class="kn">import</span> <span class="n">sdk</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
            <span class="n">sdk</span><span class="o">.</span><span class="n">rsync</span><span class="p">(</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">remote_log_dir</span><span class="si">}</span><span class="s1">/*&#39;</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">local_log_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">down</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
                <span class="n">use_internal_ip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">should_bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Call the ray sdk to rsync the logs back to local.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ips</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Disable the output of rsync.</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span>
                        <span class="n">f</span><span class="p">),</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stderr</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">rsync_down</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fore</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s1">Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s1"> logs: Downloaded from &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;node-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">)</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">click</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClickException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Raised by rsync_down. Remote log dir may not exist, since</span>
                <span class="c1"># the job can be run on some part of the nodes.</span>
                <span class="k">if</span> <span class="s1">&#39;SSH command failed&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;node-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">) does not have the tasks/*.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span></div>

    <span class="k">def</span> <span class="nf">_exec_code_on_head</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span>
        <span class="n">codegen</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">executable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">detach_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Executes generated code on the head node.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sky_app_&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">codegen</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SKY_REMOTE_APP_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sky_job_</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># We choose to sync code + exec, because the alternative of &#39;ray</span>
            <span class="c1"># submit&#39; may not work as it may use system python (python2) to</span>
            <span class="c1"># execute the script.  Happens for AWS.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsync_up</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                           <span class="n">source</span><span class="o">=</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">target</span><span class="o">=</span><span class="n">script_path</span><span class="p">,</span>
                           <span class="n">with_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">job_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;job_submit.log&#39;</span><span class="p">)</span>
        <span class="n">remote_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SKY_REMOTE_LOGS_ROOT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="n">remote_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_log_dir</span><span class="p">,</span> <span class="s1">&#39;run.log&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">executable</span> <span class="o">==</span> <span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="n">executable</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;cd </span><span class="si">{</span><span class="n">SKY_REMOTE_WORKDIR</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">job_submit_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;mkdir -p </span><span class="si">{</span><span class="n">remote_log_dir</span><span class="si">}</span><span class="s1"> &amp;&amp; ray job submit &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;--address=127.0.0.1:8265 --job-id </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s1"> -- &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">executable</span><span class="si">}</span><span class="s1"> -u </span><span class="si">{</span><span class="n">script_path</span><span class="si">}</span><span class="s1"> &gt; </span><span class="si">{</span><span class="n">remote_log_path</span><span class="si">}</span><span class="s1"> 2&gt;&amp;1&quot;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cd</span><span class="si">}</span><span class="s1"> &amp;&amp; </span><span class="si">{</span><span class="n">job_submit_cmd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">log_path</span><span class="o">=</span><span class="n">job_log_path</span><span class="p">,</span>
                         <span class="n">stream_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="n">fore</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job submitted with Job ID: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}{</span><span class="n">job_id</span><span class="si">}{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">detach_run</span><span class="p">:</span>
                <span class="c1"># Wait for the job being sucessfully submitted to ray job.</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Sky logs. Not using subprocess.run since it will make the</span>
                <span class="c1"># ssh keep connected after ctrl-c.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tail_logs</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">cluster_name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">fore</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s1">Job ID: &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}{</span><span class="n">job_id</span><span class="si">}{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To cancel the job:</span><span class="se">\t</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s1">sky cancel </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">RESET_BOLD</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To stream the logs:</span><span class="se">\t</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s1">sky logs </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">RESET_BOLD</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To view the job queue:</span><span class="se">\t</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s1">sky queue </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">RESET_BOLD</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="CloudVmRayBackend.tail_logs"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.tail_logs">[docs]</a>    <span class="k">def</span> <span class="nf">tail_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">JobLibCodeGen</span><span class="p">()</span>
        <span class="n">codegen</span><span class="o">.</span><span class="n">tail_logs</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Start streaming logs...&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">stream_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="c1"># Do nothing. When receiving ctrl-c.</span>
            <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_add_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span> <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">JobLibCodeGen</span><span class="p">()</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="n">codegen</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_timestamp</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="n">job_id_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">stream_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_id_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to parse job id: </span><span class="si">{</span><span class="n">job_id_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">job_id</span>

<div class="viewcode-block" id="CloudVmRayBackend.execute"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
        <span class="n">detach_run</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check the task resources vs the cluster resources. Since `sky exec`</span>
        <span class="c1"># will not run the provision and _check_existing_cluster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_task_resources_smaller_than_cluster</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>

        <span class="c1"># Otherwise, handle a basic Task.</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Nothing to run (Task.run not specified).&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_job</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Case: Task(run, num_nodes=1)</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_task_one_node</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">detach_run</span><span class="p">)</span>

        <span class="c1"># Case: Task(run, num_nodes=N)</span>
        <span class="k">assert</span> <span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_task_n_nodes</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">detach_run</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_execute_task_one_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
                               <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">detach_run</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Launch the command as a Ray task.</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">SKY_REMOTE_LOGS_ROOT</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;tasks&#39;</span><span class="p">)</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;run.log&#39;</span><span class="p">)</span>

        <span class="n">accelerator_dict</span> <span class="o">=</span> <span class="n">_get_task_demands_dict</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="n">codegen</span> <span class="o">=</span> <span class="n">RayCodeGen</span><span class="p">()</span>
        <span class="n">codegen</span><span class="o">.</span><span class="n">add_prologue</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">codegen</span><span class="o">.</span><span class="n">add_gang_scheduling_placement_group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">accelerator_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">):</span>
            <span class="n">run_fn_code</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
            <span class="n">run_fn_name</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">codegen</span><span class="o">.</span><span class="n">register_run_fn</span><span class="p">(</span><span class="n">run_fn_code</span><span class="p">,</span> <span class="n">run_fn_name</span><span class="p">)</span>

        <span class="n">command_for_node</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">codegen</span><span class="o">.</span><span class="n">add_ray_task</span><span class="p">(</span><span class="n">bash_script</span><span class="o">=</span><span class="n">command_for_node</span><span class="p">,</span>
                             <span class="n">task_name</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="n">ray_resources_dict</span><span class="o">=</span><span class="n">_get_task_demands_dict</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
                             <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">)</span>

        <span class="n">codegen</span><span class="o">.</span><span class="n">add_epilogue</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exec_code_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                                <span class="n">codegen</span><span class="o">.</span><span class="n">build</span><span class="p">(),</span>
                                <span class="n">job_id</span><span class="p">,</span>
                                <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span>
                                <span class="n">detach_run</span><span class="o">=</span><span class="n">detach_run</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_task_n_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
                              <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">detach_run</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Strategy:</span>
        <span class="c1">#   ray.init(...)</span>
        <span class="c1">#   for node:</span>
        <span class="c1">#     submit _run_cmd(cmd) with resource {node_i: 1}</span>
        <span class="n">log_dir_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">SKY_REMOTE_LOGS_ROOT</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir_base</span><span class="p">,</span> <span class="s1">&#39;tasks&#39;</span><span class="p">)</span>
        <span class="n">accelerator_dict</span> <span class="o">=</span> <span class="n">_get_task_demands_dict</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="n">codegen</span> <span class="o">=</span> <span class="n">RayCodeGen</span><span class="p">()</span>
        <span class="n">codegen</span><span class="o">.</span><span class="n">add_prologue</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">codegen</span><span class="o">.</span><span class="n">add_gang_scheduling_placement_group</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
                                                    <span class="n">accelerator_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">):</span>
            <span class="n">run_fn_code</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
            <span class="n">run_fn_name</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">codegen</span><span class="o">.</span><span class="n">register_run_fn</span><span class="p">(</span><span class="n">run_fn_code</span><span class="p">,</span> <span class="n">run_fn_name</span><span class="p">)</span>
        <span class="c1"># TODO (zhwu): The resources limitation for multi-node ray.tune and</span>
        <span class="c1"># horovod should be considered.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">):</span>
            <span class="n">command_for_node</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># Ray&#39;s per-node resources, to constrain scheduling each command to</span>
            <span class="c1"># the corresponding node, represented by private IPs.</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;node-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">log_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>

            <span class="n">codegen</span><span class="o">.</span><span class="n">add_ray_task</span><span class="p">(</span>
                <span class="n">bash_script</span><span class="o">=</span><span class="n">command_for_node</span><span class="p">,</span>
                <span class="n">task_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">ray_resources_dict</span><span class="o">=</span><span class="n">accelerator_dict</span><span class="p">,</span>
                <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
                <span class="n">gang_scheduling_id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">codegen</span><span class="o">.</span><span class="n">add_epilogue</span><span class="p">()</span>

        <span class="c1"># Logger.</span>
        <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">fore</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">fore</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s1">Starting Task execution.</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># TODO(zhanghao): Add help info for downloading logs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exec_code_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                                <span class="n">codegen</span><span class="o">.</span><span class="n">build</span><span class="p">(),</span>
                                <span class="n">job_id</span><span class="p">,</span>
                                <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span>
                                <span class="n">detach_run</span><span class="o">=</span><span class="n">detach_run</span><span class="p">)</span>

<div class="viewcode-block" id="CloudVmRayBackend.post_execute"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.post_execute">[docs]</a>    <span class="k">def</span> <span class="nf">post_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span> <span class="n">teardown</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">fore</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">teardown</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">cluster_name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">fore</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s1">Cluster name: &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="si">}{</span><span class="n">name</span><span class="si">}{</span><span class="n">style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To log into the head VM:</span><span class="se">\t</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s1">ssh </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">RESET_BOLD</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To submit a job:&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s1">sky exec </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> yaml_file&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">RESET_BOLD</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To stop the cluster:&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s1">sky stop </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">RESET_BOLD</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To teardown the cluster:&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s1">sky down </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">RESET_BOLD</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">tpu_delete_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Tip: `sky down` will delete launched TPU(s) too.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudVmRayBackend.teardown_ephemeral_storage"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.teardown_ephemeral_storage">[docs]</a>    <span class="k">def</span> <span class="nf">teardown_ephemeral_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">storage_mounts</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">storage_mounts</span>
        <span class="k">if</span> <span class="n">storage_mounts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">storage</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">storage_mounts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">storage</span><span class="o">.</span><span class="n">persistent</span><span class="p">:</span>
                    <span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="CloudVmRayBackend.teardown"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.teardown">[docs]</a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span> <span class="n">terminate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cloud</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="o">.</span><span class="n">cloud</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)</span>
        <span class="n">prev_status</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_status_from_cluster_name</span><span class="p">(</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">)</span>
        <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;cluster_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">terminate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="p">(</span><span class="n">clouds</span><span class="o">.</span><span class="n">AWS</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">GCP</span><span class="p">)):</span>
            <span class="c1"># FIXME: no mentions of cache_stopped_nodes in</span>
            <span class="c1"># https://github.com/ray-project/ray/blob/master/python/ray/autoscaler/_private/_azure/node_provider.py</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Stopping cluster </span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_name</span><span class="si">!r}</span><span class="s1">: not supported on &#39;</span>
                <span class="s1">&#39;non-AWS and non-GCP clusters yet. Try manually stopping, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;or terminate by: sky down </span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">Azure</span><span class="p">):</span>
            <span class="c1"># Special handling because `ray down` is buggy with Azure.</span>
            <span class="c1"># Set check=False to not error out on not found VMs.</span>
            <span class="n">backend_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="s1">&#39;az vm delete --yes --ids $(az vm list --query &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;&quot;[? contains(name, </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">)].id&quot; -o tsv)&#39;</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">terminate</span> <span class="ow">and</span>
              <span class="n">prev_status</span> <span class="o">==</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">ClusterStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">clouds</span><span class="o">.</span><span class="n">AWS</span><span class="p">):</span>
                <span class="c1"># TODO (zhwu): Room for optimization. We can move these cloud</span>
                <span class="c1"># specific handling to the cloud class.</span>
                <span class="c1"># The stopped instance on AWS will not be correctly terminated</span>
                <span class="c1"># due to ray&#39;s bug.</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">][</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
                <span class="n">query_cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;aws ec2 describe-instances --region </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s1"> --filters &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Name=tag:ray-cluster-name,Values=</span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;Name=instance-state-name,Values=stopping,stopped &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;--query Reservations[].Instances[].InstanceId &#39;</span>
                    <span class="s1">&#39;--output text&#39;</span><span class="p">)</span>
                <span class="n">terminate_cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;aws ec2 terminate-instances --region </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;--instance-ids $(</span><span class="si">{</span><span class="n">query_cmd</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">backend_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">terminate_cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO(suquark,zongheng): Support deleting stopped GCP clusters.</span>
                <span class="c1"># Tracked in issue #318.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Cannot terminate non-AWS cluster </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;because it is STOPPED. </span><span class="se">\n</span><span class="s1">To fix: manually terminate in &#39;</span>
                    <span class="s1">&#39;the cloud</span><span class="se">\&#39;</span><span class="s1">s UI or &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;`sky start </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">; sky down </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">` &#39;</span>
                    <span class="s1">&#39;(This limitation will be addressed in the future.)&#39;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">][</span><span class="s1">&#39;cache_stopped_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">terminate</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                                             <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sky_&#39;</span><span class="p">,</span>
                                             <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.yml&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">backend_utils</span><span class="o">.</span><span class="n">dump_yaml</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">backend_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ray down -y </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">tpu_delete_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">backend_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bash </span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">tpu_delete_script</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">auth_config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span>
        <span class="n">_remove_cluster_from_ssh_config</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">head_ip</span><span class="p">,</span> <span class="n">auth_config</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_cluster_name_from_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">global_user_state</span><span class="o">.</span><span class="n">remove_cluster</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="n">terminate</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">terminate</span><span class="p">:</span>
            <span class="c1"># Clean up generated config</span>
            <span class="c1"># No try-except is needed since Ray will fail to teardown the</span>
            <span class="c1"># cluster if the cluster_yaml is missing.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)</span>

            <span class="c1"># Clean up TPU creation/deletion scripts</span>
            <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">tpu_delete_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">handle</span><span class="o">.</span><span class="n">tpu_create_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">tpu_create_script</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">tpu_delete_script</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_node_ips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">cluster_yaml</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">expected_num_nodes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                      <span class="n">return_private_ips</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns the IPs of all nodes in the cluster.&quot;&quot;&quot;</span>
        <span class="n">yaml_handle</span> <span class="o">=</span> <span class="n">cluster_yaml</span>
        <span class="k">if</span> <span class="n">return_private_ips</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">yaml_handle</span><span class="p">)</span>
            <span class="c1"># Add this field to a temp file to get private ips.</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">][</span><span class="s1">&#39;use_internal_ips&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">yaml_handle</span> <span class="o">=</span> <span class="n">cluster_yaml</span> <span class="o">+</span> <span class="s1">&#39;.tmp&#39;</span>
            <span class="n">backend_utils</span><span class="o">.</span><span class="n">dump_yaml</span><span class="p">(</span><span class="n">yaml_handle</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ray get-head-ip </span><span class="si">{</span><span class="n">yaml_handle</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">head_ip</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">IP_ADDR_REGEX</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">head_ip</span><span class="p">),</span> <span class="n">out</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ray get-worker-ips </span><span class="si">{</span><span class="n">yaml_handle</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">worker_ips</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">IP_ADDR_REGEX</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">expected_num_nodes</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">worker_ips</span><span class="p">),</span> <span class="p">(</span><span class="n">expected_num_nodes</span> <span class="o">-</span>
                                                           <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_private_ips</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">yaml_handle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">head_ip</span> <span class="o">+</span> <span class="n">worker_ips</span>

    <span class="k">def</span> <span class="nf">_rsync_up</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">with_outputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs rsync from &#39;source&#39; to the cluster&#39;s node &#39;target&#39;.&quot;&quot;&quot;</span>
        <span class="c1"># Attempt to use &#39;rsync user@ip&#39; directly, which is much faster than</span>
        <span class="c1"># going through ray (either &#39;ray rsync_*&#39; or sdk.rsync()).</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">head_ip</span>
        <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">head_ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The cluster &quot;</span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">&quot; appears to be down. &#39;</span>
                <span class="s1">&#39;Run a re-provisioning command (e.g., sky launch) and retry.&#39;</span><span class="p">)</span>
        <span class="n">ssh_user</span><span class="p">,</span> <span class="n">ssh_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ssh_credential</span><span class="p">(</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)</span>
        <span class="c1"># Build command.</span>
        <span class="c1"># rsync options: progress bar; verbose; compress</span>
        <span class="n">rsync_command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rsync&#39;</span><span class="p">,</span> <span class="s1">&#39;-Pavz&#39;</span><span class="p">]</span>
        <span class="n">filter_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;.gitignore&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filter_path</span><span class="p">):</span>
            <span class="n">rsync_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--filter=</span><span class="se">\&#39;</span><span class="s1">:- </span><span class="si">{</span><span class="n">filter_path</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ssh_options</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">backend_utils</span><span class="o">.</span><span class="n">ssh_options_list</span><span class="p">(</span><span class="n">ssh_private_key</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_control_name</span><span class="p">(</span><span class="n">handle</span><span class="p">)))</span>
        <span class="n">rsync_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-e &quot;ssh </span><span class="si">{</span><span class="n">ssh_options</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="n">rsync_command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ssh_user</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">])</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rsync_command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_outputs</span><span class="p">:</span>
            <span class="c1"># TODO (zhwu): Test this if the command will be still running in the</span>
            <span class="c1"># background, after the current program is killed.</span>
            <span class="n">backend_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backend_utils</span><span class="o">.</span><span class="n">run_no_outputs</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ssh_control_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">_get_head_ip</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span>
        <span class="n">use_cached_head_ip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the ip of the head node&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_cached_head_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">head_ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># This happens for INIT clusters (e.g., exit 1 in setup).</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cluster</span><span class="se">\&#39;</span><span class="s1">s head IP not found; is it up? To fix: &#39;</span>
                    <span class="s1">&#39;run a successful launch first (`sky launch`) to ensure&#39;</span>
                    <span class="s1">&#39; the cluster status is UP (`sky status`).&#39;</span><span class="p">)</span>
            <span class="n">head_ip</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">head_ip</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">head_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_ips</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">,</span>
                                         <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">head_ip</span>

    <span class="k">def</span> <span class="nf">_get_ssh_credential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster_yaml</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns ssh_user and ssh_private_key.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">cluster_yaml</span><span class="p">)</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span>
        <span class="n">ssh_user</span> <span class="o">=</span> <span class="n">auth</span><span class="p">[</span><span class="s1">&#39;ssh_user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ssh_private_key</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ssh_private_key&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ssh_user</span><span class="p">,</span> <span class="n">ssh_private_key</span>

    <span class="c1"># TODO(zhwu): Refactor this to a CommandRunner class, so different backends</span>
    <span class="c1"># can support its own command runner.</span>
<div class="viewcode-block" id="CloudVmRayBackend.run_on_head"><a class="viewcode-back" href="../../../sky.backends.html#sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.run_on_head">[docs]</a>    <span class="k">def</span> <span class="nf">run_on_head</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">:</span> <span class="n">ResourceHandle</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">port_forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span>
        <span class="n">stream_logs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_cached_head_ip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ssh_mode</span><span class="p">:</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">SshMode</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">SshMode</span><span class="o">.</span><span class="n">NON_INTERACTIVE</span><span class="p">,</span>
        <span class="n">under_remote_workdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Runs &#39;cmd&#39; on the cluster&#39;s head node.&quot;&quot;&quot;</span>
        <span class="n">head_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_head_ip</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">use_cached_head_ip</span><span class="p">)</span>
        <span class="n">ssh_user</span><span class="p">,</span> <span class="n">ssh_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ssh_credential</span><span class="p">(</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">cluster_yaml</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">under_remote_workdir</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;cd </span><span class="si">{</span><span class="n">SKY_REMOTE_WORKDIR</span><span class="si">}</span><span class="s1"> &amp;&amp; </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">run_command_on_ip_via_ssh</span><span class="p">(</span>
            <span class="n">head_ip</span><span class="p">,</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">ssh_user</span><span class="o">=</span><span class="n">ssh_user</span><span class="p">,</span>
            <span class="n">ssh_private_key</span><span class="o">=</span><span class="n">ssh_private_key</span><span class="p">,</span>
            <span class="n">port_forward</span><span class="o">=</span><span class="n">port_forward</span><span class="p">,</span>
            <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
            <span class="n">stream_logs</span><span class="o">=</span><span class="n">stream_logs</span><span class="p">,</span>
            <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">,</span>
            <span class="n">ssh_mode</span><span class="o">=</span><span class="n">ssh_mode</span><span class="p">,</span>
            <span class="n">ssh_control_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssh_control_name</span><span class="p">(</span><span class="n">handle</span><span class="p">),</span>
        <span class="p">)</span></div></div>
</pre></div>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By the Sky authors<br/>
    
        &copy; Copyright 2022, Sky Team.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>