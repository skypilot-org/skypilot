
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sky.skylet.ray_patches.worker &#8212; Sky 0.1 documentation</title>
    
  <link href="../../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-book-theme.css?digest=84ace793992934648b4de8eed757e5a2" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/sphinx-book-theme.9d8b4a8b9bb19db25eeaddc40d639ba2.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<div class="col-12 col-md-3 bd-sidebar site-navigation " id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Sky 0.1 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../getting-started/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../getting-started/quickstart.html">
   Quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../getting-started/tutorial.html">
   Tutorial: DNN Training
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Use Cases
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../examples/auto-failover.html">
   Auto-provisioning GPUs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../examples/iterative-dev-project.html">
   Iteratively Developing a Project
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../examples/launch-many-tasks-vm.html">
   Launch Multiple Tasks on a VM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../examples/grid-search.html">
   Grid Search
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../examples/distributed-jobs.html">
   Distributed Jobs on many VMs
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Sky CLI
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../reference/cli.html">
   CLI Reference
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Features
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../reference/yaml-spec.html">
   YAML Configuration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../reference/interactive-nodes.html">
   Interactive Nodes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../reference/iterative-development.html">
   Iterative Development
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../reference/storage.html">
   Storage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../reference/job-queue.html">
   Job Queue
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<!-- This is an invisible pixel that we watch to see if we've scrolled. -->
<div class="sbt-scroll-pixel-helper"></div>
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            <div class="topbar-left">
                
                <label class="nav-toggle-button" for="__navigation">
                    <div class="visually-hidden">Toggle navigation</div>
                    <i class="fas fa-bars"></i>
                </label>
                
            </div>
            
            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            
              <div>
                
  <h1>Source code for sky.skylet.ray_patches.worker</h1><div class="highlight"><pre>
<span></span><span class="c1"># Adapted from https://github.com/ray-project/ray/blob/ray-1.10.0/python/ray/worker.py</span>
<span class="c1"># Fixed the problem in ray&#39;s issue https://github.com/ray-project/ray/issues/9233</span>
<span class="c1"># Tracked in PR https://github.com/ray-project/ray/pull/21977/files.</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">faulthandler</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># Ray modules</span>
<span class="kn">from</span> <span class="nn">ray.autoscaler._private.constants</span> <span class="kn">import</span> <span class="n">AUTOSCALER_EVENTS</span>
<span class="kn">from</span> <span class="nn">ray.autoscaler._private.util</span> <span class="kn">import</span> <span class="n">DEBUG_AUTOSCALING_ERROR</span>
<span class="kn">import</span> <span class="nn">ray.cloudpickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">ray._private.memory_monitor</span> <span class="k">as</span> <span class="nn">memory_monitor</span>
<span class="kn">import</span> <span class="nn">ray.node</span>
<span class="kn">import</span> <span class="nn">ray.job_config</span>
<span class="kn">import</span> <span class="nn">ray._private.parameter</span>
<span class="kn">import</span> <span class="nn">ray.ray_constants</span> <span class="k">as</span> <span class="nn">ray_constants</span>
<span class="kn">import</span> <span class="nn">ray.remote_function</span>
<span class="kn">import</span> <span class="nn">ray.serialization</span> <span class="k">as</span> <span class="nn">serialization</span>
<span class="kn">import</span> <span class="nn">ray._private.gcs_utils</span> <span class="k">as</span> <span class="nn">gcs_utils</span>
<span class="kn">import</span> <span class="nn">ray._private.services</span> <span class="k">as</span> <span class="nn">services</span>
<span class="kn">from</span> <span class="nn">ray.util.scheduling_strategies</span> <span class="kn">import</span> <span class="n">SchedulingStrategyT</span>
<span class="kn">from</span> <span class="nn">ray._private.gcs_pubsub</span> <span class="kn">import</span> <span class="n">gcs_pubsub_enabled</span><span class="p">,</span> <span class="n">GcsPublisher</span><span class="p">,</span> \
    <span class="n">GcsErrorSubscriber</span><span class="p">,</span> <span class="n">GcsLogSubscriber</span><span class="p">,</span> <span class="n">GcsFunctionKeySubscriber</span>
<span class="kn">from</span> <span class="nn">ray._private.runtime_env.py_modules</span> <span class="kn">import</span> <span class="n">upload_py_modules_if_needed</span>
<span class="kn">from</span> <span class="nn">ray._private.runtime_env.working_dir</span> <span class="kn">import</span> <span class="n">upload_working_dir_if_needed</span>
<span class="kn">from</span> <span class="nn">ray._private.runtime_env.constants</span> <span class="kn">import</span> <span class="n">RAY_JOB_CONFIG_JSON_ENV_VAR</span>
<span class="kn">import</span> <span class="nn">ray._private.import_thread</span> <span class="k">as</span> <span class="nn">import_thread</span>
<span class="kn">from</span> <span class="nn">ray.util.tracing.tracing_helper</span> <span class="kn">import</span> <span class="n">import_from_string</span>
<span class="kn">from</span> <span class="nn">ray.util.annotations</span> <span class="kn">import</span> <span class="n">PublicAPI</span><span class="p">,</span> <span class="n">DeveloperAPI</span><span class="p">,</span> <span class="n">Deprecated</span>
<span class="kn">from</span> <span class="nn">ray.util.debug</span> <span class="kn">import</span> <span class="n">log_once</span>
<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">import</span> <span class="nn">colorama</span>
<span class="kn">import</span> <span class="nn">setproctitle</span>
<span class="kn">import</span> <span class="nn">ray.state</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ActorID</span><span class="p">,</span>
    <span class="n">JobID</span><span class="p">,</span>
    <span class="n">ObjectRef</span><span class="p">,</span>
    <span class="n">Language</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">ray._private.profiling</span> <span class="k">as</span> <span class="nn">profiling</span>

<span class="kn">from</span> <span class="nn">ray.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RaySystemError</span><span class="p">,</span>
    <span class="n">RayError</span><span class="p">,</span>
    <span class="n">RayTaskError</span><span class="p">,</span>
    <span class="n">ObjectStoreFullError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray._private.function_manager</span> <span class="kn">import</span> <span class="n">FunctionActorManager</span>
<span class="kn">from</span> <span class="nn">ray._private.ray_logging</span> <span class="kn">import</span> <span class="n">setup_logger</span>
<span class="kn">from</span> <span class="nn">ray._private.ray_logging</span> <span class="kn">import</span> <span class="n">global_worker_stdstream_dispatcher</span>
<span class="kn">from</span> <span class="nn">ray._private.utils</span> <span class="kn">import</span> <span class="n">check_oversized_function</span>
<span class="kn">from</span> <span class="nn">ray.util.inspect</span> <span class="kn">import</span> <span class="n">is_cython</span>
<span class="kn">from</span> <span class="nn">ray.experimental.internal_kv</span> <span class="kn">import</span> <span class="p">(</span><span class="n">_internal_kv_initialized</span><span class="p">,</span>
                                          <span class="n">_initialize_internal_kv</span><span class="p">,</span>
                                          <span class="n">_internal_kv_reset</span><span class="p">,</span> <span class="n">_internal_kv_get</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray._private.client_mode_hook</span> <span class="kn">import</span> <span class="n">client_mode_hook</span>

<span class="n">SCRIPT_MODE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">WORKER_MODE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">LOCAL_MODE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SPILL_WORKER_MODE</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">RESTORE_WORKER_MODE</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">ERROR_KEY_PREFIX</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Error:&quot;</span>

<span class="c1"># Logger for this module. It should be configured at the entry point</span>
<span class="c1"># into the program using Ray. Ray provides a default configuration at</span>
<span class="c1"># entry/init points.</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Visible for testing.</span>
<span class="k">def</span> <span class="nf">_unhandled_error_handler</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unhandled error (suppress with &quot;</span>
                 <span class="s2">&quot;RAY_IGNORE_UNHANDLED_ERRORS=1): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<div class="viewcode-block" id="Worker"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker">[docs]</a><span class="k">class</span> <span class="nc">Worker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class used to define the control flow of a worker process.</span>

<span class="sd">    Note:</span>
<span class="sd">        The methods in this class are considered unexposed to the user. The</span>
<span class="sd">        functions outside of this class are considered exposed.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        node (ray.node.Node): The node this worker is attached to.</span>
<span class="sd">        mode: The mode of the worker. One of SCRIPT_MODE, LOCAL_MODE, and</span>
<span class="sd">            WORKER_MODE.</span>
<span class="sd">        cached_functions_to_run (List): A list of functions to run on all of</span>
<span class="sd">            the workers that should be exported as soon as connect is called.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Worker object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_functions_to_run</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># When the worker is constructed. Record the original value of the</span>
        <span class="c1"># CUDA_VISIBLE_DEVICES environment variable.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_gpu_ids</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_cuda_visible_devices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_monitor</span> <span class="o">=</span> <span class="n">memory_monitor</span><span class="o">.</span><span class="n">MemoryMonitor</span><span class="p">()</span>
        <span class="c1"># A dictionary that maps from driver id to SerializationContext</span>
        <span class="c1"># TODO: clean up the SerializationContext once the job finished.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialization_context_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_actor_manager</span> <span class="o">=</span> <span class="n">FunctionActorManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># This event is checked regularly by all of the threads so that they</span>
        <span class="c1"># know when to exit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads_stopped</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="c1"># Index of the current session. This number will</span>
        <span class="c1"># increment every time when `ray.shutdown` is called.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># If this is set, the next .remote call should drop into the</span>
        <span class="c1"># debugger, at the specified breakpoint ID.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugger_breakpoint</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="c1"># If this is set, ray.get calls invoked on the object ID returned</span>
        <span class="c1"># by the worker should drop into the debugger at the specified</span>
        <span class="c1"># breakpoint ID.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugger_get_breakpoint</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="c1"># If True, make the debugger external to the node this worker is</span>
        <span class="c1"># running on.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray_debugger_external</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_code_from_local</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Used to toggle whether or not logs should be filtered to only those</span>
        <span class="c1"># produced in the same job.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_logs_by_job</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: True if Ray has been started and False otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">node_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">node_ip_address</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">load_code_from_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_code_from_local</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_job_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">actor_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_actor_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ActorID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_task_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_task_id</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_node_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_node_id</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_job_config</span><span class="p">()</span><span class="o">.</span><span class="n">ray_namespace</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">placement_group_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_placement_group_id</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">worker_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_worker_id</span><span class="p">()</span><span class="o">.</span><span class="n">binary</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">should_capture_child_tasks_in_placement_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">should_capture_child_tasks_in_placement_group</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_session_and_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current session index and job id as pair.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">JobID</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runtime_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the runtime env in json format&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_runtime_env</span><span class="p">()</span>

<div class="viewcode-block" id="Worker.get_serialization_context"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.get_serialization_context">[docs]</a>    <span class="k">def</span> <span class="nf">get_serialization_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the SerializationContext of the job that this worker is processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_id: The ID of the job that indicates which job to get</span>
<span class="sd">                the serialization context for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The serialization context of the given job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This function needs to be protected by a lock, because it will be</span>
        <span class="c1"># called by`register_class_for_serialization`, as well as the import</span>
        <span class="c1"># thread, from different threads. Also, this function will recursively</span>
        <span class="c1"># call itself, so we use RLock here.</span>
        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialization_context_map</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialization_context_map</span><span class="p">[</span>
                    <span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">SerializationContext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialization_context_map</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span></div>

<div class="viewcode-block" id="Worker.check_connected"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.check_connected">[docs]</a>    <span class="k">def</span> <span class="nf">check_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the worker is connected.</span>

<span class="sd">        Raises:</span>
<span class="sd">          Exception: An exception is raised if the worker is not connected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RaySystemError</span><span class="p">(</span><span class="s2">&quot;Ray has not been started yet. You can &quot;</span>
                                 <span class="s2">&quot;start Ray with &#39;ray.init()&#39;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Worker.set_mode"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.set_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the mode of the worker.</span>

<span class="sd">        The mode SCRIPT_MODE should be used if this Worker is a driver that is</span>
<span class="sd">        being run as a Python script or interactively in a shell. It will print</span>
<span class="sd">        information about task failures.</span>

<span class="sd">        The mode WORKER_MODE should be used if this Worker is not a driver. It</span>
<span class="sd">        will not print information about tasks.</span>

<span class="sd">        The mode LOCAL_MODE should be used if this Worker is a driver and if</span>
<span class="sd">        you want to run the driver in a manner equivalent to serial Python for</span>
<span class="sd">        debugging purposes. It will not send remote function calls to the</span>
<span class="sd">        scheduler and will instead execute them in a blocking fashion.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode: One of SCRIPT_MODE, WORKER_MODE, and LOCAL_MODE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span></div>

<div class="viewcode-block" id="Worker.set_load_code_from_local"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.set_load_code_from_local">[docs]</a>    <span class="k">def</span> <span class="nf">set_load_code_from_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_code_from_local</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_code_from_local</span> <span class="o">=</span> <span class="n">load_code_from_local</span></div>

<div class="viewcode-block" id="Worker.put_object"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.put_object">[docs]</a>    <span class="k">def</span> <span class="nf">put_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">object_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">owner_address</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Put value in the local object store with object reference `object_ref`.</span>

<span class="sd">        This assumes that the value for `object_ref` has not yet been placed in</span>
<span class="sd">        the local object store. If the plasma store is full, the worker will</span>
<span class="sd">        automatically retry up to DEFAULT_PUT_OBJECT_RETRIES times. Each</span>
<span class="sd">        retry will delay for an exponentially doubling amount of time,</span>
<span class="sd">        starting with DEFAULT_PUT_OBJECT_DELAY. After this, exception</span>
<span class="sd">        will be raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: The value to put in the object store.</span>
<span class="sd">            object_ref (ObjectRef): The object ref of the value to be</span>
<span class="sd">                put. If None, one will be generated.</span>
<span class="sd">            owner_address: The serialized address of object&#39;s owner.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ObjectRef: The object ref the object was put under.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ray.exceptions.ObjectStoreFullError: This is raised if the attempt</span>
<span class="sd">                to store the object fails because the object store is full even</span>
<span class="sd">                after multiple retries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that the value is not an object ref.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ObjectRef</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Calling &#39;put&#39; on an ray.ObjectRef is not allowed &quot;</span>
                <span class="s2">&quot;(similarly, returning an ray.ObjectRef from a remote &quot;</span>
                <span class="s2">&quot;function is not allowed). If you really want to &quot;</span>
                <span class="s2">&quot;do this, you can wrap the ray.ObjectRef in a list and &quot;</span>
                <span class="s2">&quot;call &#39;put&#39; on it (or return it).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">object_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Local Mode does not support &quot;</span>
                                        <span class="s2">&quot;inserting with an ObjectRef&quot;</span><span class="p">)</span>

        <span class="n">serialized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serialization_context</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># This *must* be the first place that we construct this python</span>
        <span class="c1"># ObjectRef because an entry with 0 local references is created when</span>
        <span class="c1"># the object is Put() in the core worker, expecting that this python</span>
        <span class="c1"># reference will be created. If another reference is created and</span>
        <span class="c1"># removed before this one, it will corrupt the state in the</span>
        <span class="c1"># reference counter.</span>
        <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">put_serialized_object</span><span class="p">(</span><span class="n">serialized_value</span><span class="p">,</span>
                                                   <span class="n">object_ref</span><span class="o">=</span><span class="n">object_ref</span><span class="p">,</span>
                                                   <span class="n">owner_address</span><span class="o">=</span><span class="n">owner_address</span><span class="p">),</span>
            <span class="c1"># If the owner address is set, then the initial reference is</span>
            <span class="c1"># already acquired internally in CoreWorker::CreateOwned.</span>
            <span class="c1"># TODO(ekl) we should unify the code path more with the others</span>
            <span class="c1"># to avoid this special case.</span>
            <span class="n">skip_adding_local_ref</span><span class="o">=</span><span class="p">(</span><span class="n">owner_address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span></div>

<div class="viewcode-block" id="Worker.raise_errors"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.raise_errors">[docs]</a>    <span class="k">def</span> <span class="nf">raise_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_metadata_pairs</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_objects</span><span class="p">(</span><span class="n">data_metadata_pairs</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;RAY_IGNORE_UNHANDLED_ERRORS&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">_unhandled_error_handler</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="Worker.deserialize_objects"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.deserialize_objects">[docs]</a>    <span class="k">def</span> <span class="nf">deserialize_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_metadata_pairs</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">):</span>
        <span class="c1"># Function actor manager or the import thread may call pickle.loads</span>
        <span class="c1"># at the same time which can lead to failed imports</span>
        <span class="c1"># TODO: We may be better off locking on all imports or injecting a lock</span>
        <span class="c1"># into pickle.loads (https://github.com/ray-project/ray/issues/16304)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_actor_manager</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serialization_context</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">deserialize_objects</span><span class="p">(</span><span class="n">data_metadata_pairs</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Worker.get_objects"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.get_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the values in the object store associated with the IDs.</span>

<span class="sd">        Return the values from the local object store for object_refs. This</span>
<span class="sd">        will block until all the values for object_refs have been written to</span>
<span class="sd">        the local object store.</span>

<span class="sd">        Args:</span>
<span class="sd">            object_refs (List[object_ref.ObjectRef]): A list of the object refs</span>
<span class="sd">                whose values should be retrieved.</span>
<span class="sd">            timeout (float): timeout (float): The maximum amount of time in</span>
<span class="sd">                seconds to wait before returning.</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: List of deserialized objects</span>
<span class="sd">            bytes: UUID of the debugger breakpoint we should drop</span>
<span class="sd">                into or b&quot;&quot; if there is no breakpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that the values are object refs.</span>
        <span class="k">for</span> <span class="n">object_ref</span> <span class="ow">in</span> <span class="n">object_refs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_ref</span><span class="p">,</span> <span class="n">ObjectRef</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Attempting to call `get` on the value </span><span class="si">{</span><span class="n">object_ref</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;which is not an ray.ObjectRef.&quot;</span><span class="p">)</span>

        <span class="n">timeout_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">if</span> <span class="n">timeout</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">data_metadata_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_objects</span><span class="p">(</span>
            <span class="n">object_refs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_task_id</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>
        <span class="n">debugger_breakpoint</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data_metadata_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">metadata_fields</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_fields</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">metadata_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                        <span class="n">ray_constants</span><span class="o">.</span><span class="n">OBJECT_METADATA_DEBUG_PREFIX</span><span class="p">):</span>
                    <span class="n">debugger_breakpoint</span> <span class="o">=</span> <span class="n">metadata_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">OBJECT_METADATA_DEBUG_PREFIX</span><span class="p">):]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_objects</span><span class="p">(</span><span class="n">data_metadata_pairs</span><span class="p">,</span>
                                        <span class="n">object_refs</span><span class="p">),</span> <span class="n">debugger_breakpoint</span></div>

<div class="viewcode-block" id="Worker.run_function_on_all_workers"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.run_function_on_all_workers">[docs]</a>    <span class="k">def</span> <span class="nf">run_function_on_all_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run arbitrary code on all of the workers.</span>

<span class="sd">        This function will first be run on the driver, and then it will be</span>
<span class="sd">        exported to all of the workers to be run. It will also be run on any</span>
<span class="sd">        new workers that register later. If ray.init has not been called yet,</span>
<span class="sd">        then cache the function and export it later.</span>

<span class="sd">        Args:</span>
<span class="sd">            function (Callable): The function to run on all of the workers. It</span>
<span class="sd">                takes only one argument, a worker info dict. If it returns</span>
<span class="sd">                anything, its return values will not be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If ray.init has not been called yet, then cache the function and</span>
        <span class="c1"># export it when connect is called. Otherwise, run the function on all</span>
        <span class="c1"># workers.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cached_functions_to_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Attempt to pickle the function before we need it. This could</span>
            <span class="c1"># fail, and it is more convenient if the failure happens before we</span>
            <span class="c1"># actually run the function locally.</span>
            <span class="n">pickled_function</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

            <span class="n">function_to_run_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">shake_128</span><span class="p">(</span><span class="n">pickled_function</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span>
                <span class="n">ray_constants</span><span class="o">.</span><span class="n">ID_SIZE</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;FunctionsToRun:&quot;</span> <span class="o">+</span> <span class="n">function_to_run_id</span>
            <span class="c1"># First run the function on the driver.</span>
            <span class="c1"># We always run the task locally.</span>
            <span class="n">function</span><span class="p">({</span><span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>
            <span class="c1"># Check if the function has already been put into redis.</span>
            <span class="n">function_exported</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcs_client</span><span class="o">.</span><span class="n">internal_kv_put</span><span class="p">(</span>
                <span class="sa">b</span><span class="s2">&quot;Lock:&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">ray_constants</span><span class="o">.</span><span class="n">KV_NAMESPACE_FUNCTION_TABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">function_exported</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># In this case, the function has already been exported, so</span>
                <span class="c1"># we don&#39;t need to export it again.</span>
                <span class="k">return</span>

            <span class="n">check_oversized_function</span><span class="p">(</span><span class="n">pickled_function</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                     <span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="c1"># Run the function on all workers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gcs_client</span><span class="o">.</span><span class="n">internal_kv_put</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                    <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
                    <span class="s2">&quot;function_id&quot;</span><span class="p">:</span> <span class="n">function_to_run_id</span><span class="p">,</span>
                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="n">pickled_function</span><span class="p">,</span>
                <span class="p">}),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">KV_NAMESPACE_FUNCTION_TABLE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_actor_manager</span><span class="o">.</span><span class="n">export_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>
            <span class="c1"># TODO(rkn): If the worker fails after it calls setnx and before it</span>
            <span class="c1"># successfully completes the hset and rpush, then the program will</span>
            <span class="c1"># most likely hang. This could be fixed by making these three</span>
            <span class="c1"># operations into a transaction (or by implementing a custom</span>
            <span class="c1"># command that does all three things).</span>

<div class="viewcode-block" id="Worker.main_loop"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.main_loop">[docs]</a>    <span class="k">def</span> <span class="nf">main_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The main loop a worker runs to receive and execute tasks.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">sigterm_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="n">shutdown</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_sigterm_handler</span><span class="p">(</span><span class="n">sigterm_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">run_task_loop</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Worker.print_logs"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.Worker.print_logs">[docs]</a>    <span class="k">def</span> <span class="nf">print_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints log messages from workers on all nodes in the same job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcs_pubsub_enabled</span><span class="p">:</span>
            <span class="n">subscriber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcs_log_subscriber</span>
            <span class="n">subscriber</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subscriber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">pubsub</span><span class="p">(</span>
                <span class="n">ignore_subscribe_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subscriber</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">gcs_utils</span><span class="o">.</span><span class="n">LOG_FILE_CHANNEL</span><span class="p">)</span>
        <span class="n">localhost</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">get_node_ip_address</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Keep track of the number of consecutive log messages that have</span>
            <span class="c1"># been received with no break in between. If this number grows</span>
            <span class="c1"># continually, then the worker is probably not able to process the</span>
            <span class="c1"># log messages as rapidly as they are coming in.</span>
            <span class="n">num_consecutive_messages_received</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">job_id_hex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Exit if we received a signal that we should stop.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads_stopped</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcs_pubsub_enabled</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">get_message</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">num_consecutive_messages_received</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">threads_stopped</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">num_consecutive_messages_received</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">num_consecutive_messages_received</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
                        <span class="n">num_consecutive_messages_received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;The driver may not be able to keep up with the &quot;</span>
                        <span class="s2">&quot;stdout/stderr of the workers. To avoid forwarding &quot;</span>
                        <span class="s2">&quot;logs to the driver, use &quot;</span>
                        <span class="s2">&quot;&#39;ray.init(log_to_driver=False)&#39;.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcs_pubsub_enabled</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]))</span>

                <span class="c1"># Don&#39;t show logs from other drivers.</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_logs_by_job</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">]</span> <span class="ow">and</span>
                        <span class="n">job_id_hex</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;localhost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">localhost</span>
                <span class="n">global_worker_stdstream_dispatcher</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">redis</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;print_logs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Close the pubsub client to avoid leaking file descriptors.</span>
            <span class="n">subscriber</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="get_gpu_ids"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.get_gpu_ids">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_gpu_ids</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the IDs of the GPUs that are available to the worker.</span>

<span class="sd">    If the CUDA_VISIBLE_DEVICES environment variable was set when the worker</span>
<span class="sd">    started up, then the IDs returned by this method will be a subset of the</span>
<span class="sd">    IDs in CUDA_VISIBLE_DEVICES. If not, the IDs will fall in the range</span>
<span class="sd">    [0, NUM_GPUS - 1], where NUM_GPUS is the number of GPUs that the node has.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of GPU IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WORKER_MODE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;worker_get_gpu_ids_empty_from_driver&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;`ray.get_gpu_ids()` will always return the empty list when &quot;</span>
                <span class="s2">&quot;called from the driver. This is because Ray does not manage &quot;</span>
                <span class="s2">&quot;GPU allocations to the driver process.&quot;</span><span class="p">)</span>

    <span class="c1"># TODO(ilr) Handle inserting resources in local mode</span>
    <span class="n">all_resource_ids</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">resource_ids</span><span class="p">()</span>
    <span class="n">assigned_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">resource</span><span class="p">,</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">all_resource_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Handle both normal and placement group GPU resources.</span>
        <span class="c1"># Note: We should only get the GPU ids from the placement</span>
        <span class="c1"># group resource that does not contain the bundle index!</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="s2">&quot;GPU&quot;</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^GPU_group_[0-9A-Za-z]+$&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">assignment</span><span class="p">:</span>
                <span class="n">assigned_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>

    <span class="n">assigned_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assigned_ids</span><span class="p">)</span>
    <span class="c1"># If the user had already set CUDA_VISIBLE_DEVICES, then respect that (in</span>
    <span class="c1"># the sense that only GPU IDs that appear in CUDA_VISIBLE_DEVICES should be</span>
    <span class="c1"># returned).</span>
    <span class="k">if</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">original_gpu_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">assigned_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">global_worker</span><span class="o">.</span><span class="n">original_gpu_ids</span><span class="p">[</span><span class="n">gpu_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">gpu_id</span> <span class="ow">in</span> <span class="n">assigned_ids</span>
        <span class="p">]</span>
        <span class="c1"># Give all GPUs in local_mode.</span>
        <span class="k">if</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
            <span class="n">max_gpus</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_resource_spec</span><span class="p">()</span><span class="o">.</span><span class="n">num_gpus</span>
            <span class="n">assigned_ids</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">original_gpu_ids</span><span class="p">[:</span><span class="n">max_gpus</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">assigned_ids</span></div>


<div class="viewcode-block" id="get_resource_ids"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.get_resource_ids">[docs]</a><span class="nd">@Deprecated</span>
<span class="k">def</span> <span class="nf">get_resource_ids</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the IDs of the resources that are available to the worker.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping the name of a resource to a list of pairs, where</span>
<span class="sd">        each pair consists of the ID of a resource and the fraction of that</span>
<span class="sd">        resource reserved for this worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;ray.worker.get_resource_ids() currently does not work in &quot;</span>
            <span class="s2">&quot;local_mode.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">resource_ids</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_dashboard_url"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.get_dashboard_url">[docs]</a><span class="nd">@Deprecated</span>
<span class="k">def</span> <span class="nf">get_dashboard_url</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the URL to access the Ray dashboard.</span>

<span class="sd">    Note that the URL does not specify which node the dashboard is on.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The URL of the dashboard as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_global_node</span><span class="o">.</span><span class="n">webui_url</span></div>


<span class="n">global_worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Worker: The global Worker object for this worker process.</span>

<span class="sd">We use a global Worker object to ensure that there is a single worker object</span>
<span class="sd">per worker process.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">_global_node</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;ray.node.Node: The global node object that is created by ray.init().&quot;&quot;&quot;</span>


<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.init">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span>
        <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">num_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_gpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">object_store_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">local_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_reinit_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_dashboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dashboard_host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">DEFAULT_DASHBOARD_IP</span><span class="p">,</span>
        <span class="n">dashboard_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_config</span><span class="p">:</span> <span class="s2">&quot;ray.job_config.JobConfig&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">configure_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">logging_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">LOGGER_LEVEL</span><span class="p">,</span>
        <span class="n">logging_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">LOGGER_FORMAT</span><span class="p">,</span>
        <span class="n">log_to_driver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">runtime_env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># The following are unstable parameters and their use is discouraged.</span>
        <span class="n">_enable_object_reconstruction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">_redis_max_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_plasma_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_node_ip_address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">NODE_DEFAULT_IP</span><span class="p">,</span>
        <span class="n">_driver_object_store_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_redis_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">REDIS_DEFAULT_PASSWORD</span><span class="p">,</span>
        <span class="n">_temp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_metrics_export_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_system_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_tracing_startup_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to an existing Ray cluster or start one and connect to it.</span>

<span class="sd">    This method handles two cases; either a Ray cluster already exists and we</span>
<span class="sd">    just attach this driver to it or we start all of the processes associated</span>
<span class="sd">    with a Ray cluster and attach to the newly started cluster.</span>

<span class="sd">    To start Ray locally and all of the relevant processes, use this as</span>
<span class="sd">    follows:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        ray.init()</span>

<span class="sd">    To connect to an existing local cluster, use this as follows.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        ray.init(address=&quot;auto&quot;)</span>

<span class="sd">    To connect to an existing remote cluster, use this as follows (substituting</span>
<span class="sd">    in the appropriate address). Note the addition of &quot;ray://&quot; at the beginning</span>
<span class="sd">    of the address.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        ray.init(address=&quot;ray://123.45.67.89:10001&quot;)</span>

<span class="sd">    More details for starting and connecting to a remote cluster can be found</span>
<span class="sd">    here: https://docs.ray.io/en/master/cluster/ray-client.html</span>

<span class="sd">    You can also define an environment variable called `RAY_ADDRESS` in</span>
<span class="sd">    the same format as the `address` parameter to connect to an existing</span>
<span class="sd">    cluster with ray.init() or ray.init(address=&quot;auto&quot;).</span>

<span class="sd">    Args:</span>
<span class="sd">        address (str): The address of the Ray cluster to connect to. If</span>
<span class="sd">            this address is not provided, then this command will start Redis,</span>
<span class="sd">            a raylet, a plasma store, a plasma manager, and some workers.</span>
<span class="sd">            It will also kill these processes when Python exits. If the driver</span>
<span class="sd">            is running on a node in a Ray cluster, using `auto` as the value</span>
<span class="sd">            tells the driver to detect the cluster, removing the need to</span>
<span class="sd">            specify a specific node address. If the environment variable</span>
<span class="sd">            `RAY_ADDRESS` is defined and the address is None or &quot;auto&quot;, Ray</span>
<span class="sd">            will set `address` to `RAY_ADDRESS`.</span>
<span class="sd">            Addresses can be prefixed with a &quot;ray://&quot; to connect to a remote</span>
<span class="sd">            cluster. For example, passing in the address</span>
<span class="sd">            &quot;ray://123.45.67.89:50005&quot; will connect to the cluster at the</span>
<span class="sd">            given address.</span>
<span class="sd">        num_cpus (int): Number of CPUs the user wishes to assign to each</span>
<span class="sd">            raylet. By default, this is set based on virtual cores.</span>
<span class="sd">        num_gpus (int): Number of GPUs the user wishes to assign to each</span>
<span class="sd">            raylet. By default, this is set based on detected GPUs.</span>
<span class="sd">        resources: A dictionary mapping the names of custom resources to the</span>
<span class="sd">            quantities for them available.</span>
<span class="sd">        object_store_memory: The amount of memory (in bytes) to start the</span>
<span class="sd">            object store with. By default, this is automatically set based on</span>
<span class="sd">            available system memory.</span>
<span class="sd">        local_mode (bool): If true, the code will be executed serially. This</span>
<span class="sd">            is useful for debugging.</span>
<span class="sd">        ignore_reinit_error: If true, Ray suppresses errors from calling</span>
<span class="sd">            ray.init() a second time. Ray won&#39;t be restarted.</span>
<span class="sd">        include_dashboard: Boolean flag indicating whether or not to start the</span>
<span class="sd">            Ray dashboard, which displays the status of the Ray</span>
<span class="sd">            cluster. If this argument is None, then the UI will be started if</span>
<span class="sd">            the relevant dependencies are present.</span>
<span class="sd">        dashboard_host: The host to bind the dashboard server to. Can either be</span>
<span class="sd">            localhost (127.0.0.1) or 0.0.0.0 (available from all interfaces).</span>
<span class="sd">            By default, this is set to localhost to prevent access from</span>
<span class="sd">            external machines.</span>
<span class="sd">        dashboard_port(int, None): The port to bind the dashboard server to.</span>
<span class="sd">            Defaults to 8265 and Ray will automatically find a free port if</span>
<span class="sd">            8265 is not available.</span>
<span class="sd">        job_config (ray.job_config.JobConfig): The job configuration.</span>
<span class="sd">        configure_logging: True (default) if configuration of logging is</span>
<span class="sd">            allowed here. Otherwise, the user may want to configure it</span>
<span class="sd">            separately.</span>
<span class="sd">        logging_level: Logging level, defaults to logging.INFO. Ignored unless</span>
<span class="sd">            &quot;configure_logging&quot; is true.</span>
<span class="sd">        logging_format: Logging format, defaults to string containing a</span>
<span class="sd">            timestamp, filename, line number, and message. See the source file</span>
<span class="sd">            ray_constants.py for details. Ignored unless &quot;configure_logging&quot;</span>
<span class="sd">            is true.</span>
<span class="sd">        log_to_driver (bool): If true, the output from all of the worker</span>
<span class="sd">            processes on all nodes will be directed to the driver.</span>
<span class="sd">        namespace (str): Namespace to use</span>
<span class="sd">        runtime_env (dict): The runtime environment to use for this job (see</span>
<span class="sd">                :ref:`runtime-environments` for details).  This API is in beta</span>
<span class="sd">                and may change before becoming stable.</span>
<span class="sd">        _enable_object_reconstruction (bool): If True, when an object stored in</span>
<span class="sd">            the distributed plasma store is lost due to node failure, Ray will</span>
<span class="sd">            attempt to reconstruct the object by re-executing the task that</span>
<span class="sd">            created the object. Arguments to the task will be recursively</span>
<span class="sd">            reconstructed. If False, then ray.ObjectLostError will be</span>
<span class="sd">            thrown.</span>
<span class="sd">        _redis_max_memory: Redis max memory.</span>
<span class="sd">        _plasma_directory: Override the plasma mmap file directory.</span>
<span class="sd">        _node_ip_address (str): The IP address of the node that we are on.</span>
<span class="sd">        _driver_object_store_memory (int): Deprecated.</span>
<span class="sd">        _memory: Amount of reservable memory resource to create.</span>
<span class="sd">        _redis_password (str): Prevents external clients without the password</span>
<span class="sd">            from connecting to Redis if provided.</span>
<span class="sd">        _temp_dir (str): If provided, specifies the root temporary</span>
<span class="sd">            directory for the Ray process. Defaults to an OS-specific</span>
<span class="sd">            conventional location, e.g., &quot;/tmp/ray&quot;.</span>
<span class="sd">        _metrics_export_port(int): Port number Ray exposes system metrics</span>
<span class="sd">            through a Prometheus endpoint. It is currently under active</span>
<span class="sd">            development, and the API is subject to change.</span>
<span class="sd">        _system_config (dict): Configuration for overriding</span>
<span class="sd">            RayConfig defaults. For testing purposes ONLY.</span>
<span class="sd">        _tracing_startup_hook (str): If provided, turns on and sets up tracing</span>
<span class="sd">            for Ray. Must be the name of a function that takes no arguments and</span>
<span class="sd">            sets up a Tracer Provider, Remote Span Processors, and</span>
<span class="sd">            (optional) additional instruments. See more at</span>
<span class="sd">            docs.ray.io/tracing.html. It is currently under active development,</span>
<span class="sd">            and the API is subject to change.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If the provided address includes a protocol, for example by prepending</span>
<span class="sd">        &quot;ray://&quot; to the address to get &quot;ray://1.2.3.4:10001&quot;, then a</span>
<span class="sd">        ClientContext is returned with information such as settings, server</span>
<span class="sd">        versions for ray and python, and the dashboard_url. Otherwise,</span>
<span class="sd">        returns address information about the started processes.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: An exception is raised if an inappropriate combination of</span>
<span class="sd">            arguments is passed in.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If available, use RAY_ADDRESS to override if the address was left</span>
    <span class="c1"># unspecified, or set to &quot;auto&quot; in the call to init</span>
    <span class="n">address_env_var</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_ADDRESS_ENVIRONMENT_VARIABLE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">address_env_var</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">address</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">address_env_var</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using address </span><span class="si">{</span><span class="n">address_env_var</span><span class="si">}</span><span class="s2"> set in the environment &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;variable </span><span class="si">{</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_ADDRESS_ENVIRONMENT_VARIABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;://&quot;</span> <span class="ow">in</span> <span class="n">address</span><span class="p">:</span>
        <span class="c1"># Address specified a protocol, use ray client</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">_deprecation_warn_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Forward any keyword arguments that were changed from their default</span>
        <span class="c1"># values to the builder</span>
        <span class="n">init_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
        <span class="n">passed_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">argument_name</span><span class="p">,</span> <span class="n">param_obj</span> <span class="ow">in</span> <span class="n">init_sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">argument_name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">}:</span>
                <span class="c1"># kwargs and address are handled separately</span>
                <span class="k">continue</span>
            <span class="n">default_value</span> <span class="o">=</span> <span class="n">param_obj</span><span class="o">.</span><span class="n">default</span>
            <span class="n">passed_value</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">argument_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">passed_value</span> <span class="o">!=</span> <span class="n">default_value</span><span class="p">:</span>
                <span class="c1"># passed value is different than default, pass to the client</span>
                <span class="c1"># builder</span>
                <span class="n">passed_kwargs</span><span class="p">[</span><span class="n">argument_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">passed_value</span>
        <span class="n">passed_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">_init_args</span><span class="p">(</span><span class="o">**</span><span class="n">passed_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="c1"># User passed in extra keyword arguments but isn&#39;t connecting through</span>
        <span class="c1"># ray client. Raise an error, since most likely a typo in keyword</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown keyword argument(s): </span><span class="si">{</span><span class="n">unknown</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Try to increase the file descriptor limit, which is too low by</span>
    <span class="c1"># default for Ray: https://github.com/ray-project/ray/issues/11239</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">resource</span>
        <span class="n">soft</span><span class="p">,</span> <span class="n">hard</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">soft</span> <span class="o">&lt;</span> <span class="n">hard</span><span class="p">:</span>
            <span class="c1"># https://github.com/ray-project/ray/issues/12059</span>
            <span class="n">soft</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">hard</span><span class="p">,</span> <span class="mi">65536</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Automatically increasing RLIMIT_NOFILE to max &quot;</span>
                         <span class="s2">&quot;value of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hard</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="n">hard</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to raise limit.&quot;</span><span class="p">)</span>
        <span class="n">soft</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">soft</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;File descriptor limit </span><span class="si">{}</span><span class="s2"> is too low for production &quot;</span>
                           <span class="s2">&quot;servers and may result in connection errors. &quot;</span>
                           <span class="s2">&quot;At least 8192 is recommended. --- &quot;</span>
                           <span class="s2">&quot;Fix with &#39;ulimit -n 8192&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">soft</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not import resource module (on Windows)&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">RAY_JOB_CONFIG_JSON_ENV_VAR</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">runtime_env</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Both RAY_JOB_CONFIG_JSON_ENV_VAR and ray.init(runtime_env) &quot;</span>
                <span class="s2">&quot;are provided, only using JSON_ENV_VAR to construct &quot;</span>
                <span class="s2">&quot;job_config. Please ensure no runtime_env is used in driver &quot;</span>
                <span class="s2">&quot;script&#39;s ray.init() when using job submission API.&quot;</span><span class="p">)</span>
        <span class="c1"># Set runtime_env in job_config if passed as env variable, such as</span>
        <span class="c1"># ray job submission with driver script executed in subprocess</span>
        <span class="n">job_config_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RAY_JOB_CONFIG_JSON_ENV_VAR</span><span class="p">))</span>
        <span class="n">job_config</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">job_config</span><span class="o">.</span><span class="n">JobConfig</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">job_config_json</span><span class="p">)</span>
    <span class="c1"># RAY_JOB_CONFIG_JSON_ENV_VAR is only set at ray job manager level and has</span>
    <span class="c1"># higher priority in case user also provided runtime_env for ray.init()</span>
    <span class="k">elif</span> <span class="n">runtime_env</span><span class="p">:</span>
        <span class="c1"># Set runtime_env in job_config if passed in as part of ray.init()</span>
        <span class="k">if</span> <span class="n">job_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_config</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">job_config</span><span class="o">.</span><span class="n">JobConfig</span><span class="p">()</span>
        <span class="n">job_config</span><span class="o">.</span><span class="n">set_runtime_env</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">)</span>

    <span class="c1"># Convert hostnames to numerical IP address.</span>
    <span class="k">if</span> <span class="n">_node_ip_address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node_ip_address</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">address_to_ip</span><span class="p">(</span><span class="n">_node_ip_address</span><span class="p">)</span>
    <span class="n">raylet_ip_address</span> <span class="o">=</span> <span class="n">node_ip_address</span>

    <span class="k">if</span> <span class="n">address</span><span class="p">:</span>
        <span class="n">redis_address</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">validate_redis_address</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">redis_address</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">configure_logging</span><span class="p">:</span>
        <span class="n">setup_logger</span><span class="p">(</span><span class="n">logging_level</span><span class="p">,</span> <span class="n">logging_format</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">redis_address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Connecting to existing Ray cluster at address: </span><span class="si">{</span><span class="n">redis_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">local_mode</span><span class="p">:</span>
        <span class="n">driver_mode</span> <span class="o">=</span> <span class="n">LOCAL_MODE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">driver_mode</span> <span class="o">=</span> <span class="n">SCRIPT_MODE</span>

    <span class="k">if</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ignore_reinit_error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Calling ray.init() again after it has already been called.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Maybe you called ray.init twice by accident? &quot;</span>
                               <span class="s2">&quot;This error can be suppressed by passing in &quot;</span>
                               <span class="s2">&quot;&#39;ignore_reinit_error=True&#39; or by calling &quot;</span>
                               <span class="s2">&quot;&#39;ray.shutdown()&#39; prior to &#39;ray.init()&#39;.&quot;</span><span class="p">)</span>

    <span class="n">_system_config</span> <span class="o">=</span> <span class="n">_system_config</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_system_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The _system_config must be a dict.&quot;</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">_global_node</span>
    <span class="k">if</span> <span class="n">redis_address</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># In this case, we need to start a new cluster.</span>
        <span class="n">ray_params</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">RayParams</span><span class="p">(</span>
            <span class="n">redis_address</span><span class="o">=</span><span class="n">redis_address</span><span class="p">,</span>
            <span class="n">node_ip_address</span><span class="o">=</span><span class="n">node_ip_address</span><span class="p">,</span>
            <span class="n">raylet_ip_address</span><span class="o">=</span><span class="n">raylet_ip_address</span><span class="p">,</span>
            <span class="n">object_ref_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">driver_mode</span><span class="o">=</span><span class="n">driver_mode</span><span class="p">,</span>
            <span class="n">redirect_worker_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">redirect_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">num_cpus</span><span class="o">=</span><span class="n">num_cpus</span><span class="p">,</span>
            <span class="n">num_gpus</span><span class="o">=</span><span class="n">num_gpus</span><span class="p">,</span>
            <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span>
            <span class="n">num_redis_shards</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">redis_max_clients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">redis_password</span><span class="o">=</span><span class="n">_redis_password</span><span class="p">,</span>
            <span class="n">plasma_directory</span><span class="o">=</span><span class="n">_plasma_directory</span><span class="p">,</span>
            <span class="n">huge_pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">include_dashboard</span><span class="o">=</span><span class="n">include_dashboard</span><span class="p">,</span>
            <span class="n">dashboard_host</span><span class="o">=</span><span class="n">dashboard_host</span><span class="p">,</span>
            <span class="n">dashboard_port</span><span class="o">=</span><span class="n">dashboard_port</span><span class="p">,</span>
            <span class="n">memory</span><span class="o">=</span><span class="n">_memory</span><span class="p">,</span>
            <span class="n">object_store_memory</span><span class="o">=</span><span class="n">object_store_memory</span><span class="p">,</span>
            <span class="n">redis_max_memory</span><span class="o">=</span><span class="n">_redis_max_memory</span><span class="p">,</span>
            <span class="n">plasma_store_socket_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">temp_dir</span><span class="o">=</span><span class="n">_temp_dir</span><span class="p">,</span>
            <span class="c1"># We need to disable it if runtime env is not set.</span>
            <span class="c1"># Uploading happens after core worker is created. And we should</span>
            <span class="c1"># prevent default worker being created before uploading.</span>
            <span class="c1"># TODO (yic): Have a separate connection to gcs client when</span>
            <span class="c1"># removal redis is done. The uploading should happen before this</span>
            <span class="c1"># one.</span>
            <span class="n">start_initial_python_workers_for_first_job</span><span class="o">=</span><span class="p">(</span>
                <span class="n">job_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">job_config</span><span class="o">.</span><span class="n">runtime_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">_system_config</span><span class="o">=</span><span class="n">_system_config</span><span class="p">,</span>
            <span class="n">enable_object_reconstruction</span><span class="o">=</span><span class="n">_enable_object_reconstruction</span><span class="p">,</span>
            <span class="n">metrics_export_port</span><span class="o">=</span><span class="n">_metrics_export_port</span><span class="p">,</span>
            <span class="n">tracing_startup_hook</span><span class="o">=</span><span class="n">_tracing_startup_hook</span><span class="p">)</span>
        <span class="c1"># Start the Ray processes. We set shutdown_at_exit=False because we</span>
        <span class="c1"># shutdown the node in the ray.shutdown call that happens in the atexit</span>
        <span class="c1"># handler. We still spawn a reaper process in case the atexit handler</span>
        <span class="c1"># isn&#39;t called.</span>
        <span class="n">_global_node</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">shutdown_at_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">spawn_reaper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">ray_params</span><span class="o">=</span><span class="n">ray_params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># In this case, we are connecting to an existing cluster.</span>
        <span class="k">if</span> <span class="n">num_cpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_gpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When connecting to an existing cluster, num_cpus &quot;</span>
                             <span class="s2">&quot;and num_gpus must not be provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                             <span class="s2">&quot;resources must not be provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">object_store_memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                             <span class="s2">&quot;object_store_memory must not be provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_system_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_system_config</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                             <span class="s2">&quot;_system_config must not be provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_enable_object_reconstruction</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                <span class="s2">&quot;_enable_object_reconstruction must not be provided.&quot;</span><span class="p">)</span>

        <span class="c1"># In this case, we only need to connect the node.</span>
        <span class="n">ray_params</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">RayParams</span><span class="p">(</span>
            <span class="n">node_ip_address</span><span class="o">=</span><span class="n">node_ip_address</span><span class="p">,</span>
            <span class="n">raylet_ip_address</span><span class="o">=</span><span class="n">raylet_ip_address</span><span class="p">,</span>
            <span class="n">redis_address</span><span class="o">=</span><span class="n">redis_address</span><span class="p">,</span>
            <span class="n">redis_password</span><span class="o">=</span><span class="n">_redis_password</span><span class="p">,</span>
            <span class="n">object_ref_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">temp_dir</span><span class="o">=</span><span class="n">_temp_dir</span><span class="p">,</span>
            <span class="n">_system_config</span><span class="o">=</span><span class="n">_system_config</span><span class="p">,</span>
            <span class="n">enable_object_reconstruction</span><span class="o">=</span><span class="n">_enable_object_reconstruction</span><span class="p">,</span>
            <span class="n">metrics_export_port</span><span class="o">=</span><span class="n">_metrics_export_port</span><span class="p">)</span>
        <span class="n">_global_node</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">ray_params</span><span class="p">,</span>
                                     <span class="n">head</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">shutdown_at_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">spawn_reaper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">connect_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">connect</span><span class="p">(</span><span class="n">_global_node</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">driver_mode</span><span class="p">,</span>
            <span class="n">log_to_driver</span><span class="o">=</span><span class="n">log_to_driver</span><span class="p">,</span>
            <span class="n">worker</span><span class="o">=</span><span class="n">global_worker</span><span class="p">,</span>
            <span class="n">driver_object_store_memory</span><span class="o">=</span><span class="n">_driver_object_store_memory</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">job_config</span> <span class="ow">and</span> <span class="n">job_config</span><span class="o">.</span><span class="n">code_search_path</span><span class="p">:</span>
        <span class="n">global_worker</span><span class="o">.</span><span class="n">set_load_code_from_local</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Because `ray.shutdown()` doesn&#39;t reset this flag, for multiple</span>
        <span class="c1"># sessions in one process, the 2nd `ray.init()` will reuse the</span>
        <span class="c1"># flag of last session. For example:</span>
        <span class="c1">#     ray.init(load_code_from_local=True)</span>
        <span class="c1">#     ray.shutdown()</span>
        <span class="c1">#     ray.init()</span>
        <span class="c1">#     # Here the flag `load_code_from_local` is still True if we</span>
        <span class="c1">#     # doesn&#39;t have this `else` branch.</span>
        <span class="c1">#     ray.shutdown()</span>
        <span class="n">global_worker</span><span class="o">.</span><span class="n">set_load_code_from_local</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">_post_init_hooks</span><span class="p">:</span>
        <span class="n">hook</span><span class="p">()</span>

    <span class="n">node_id</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_node_id</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_global_node</span><span class="o">.</span><span class="n">address_info</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node_id</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span></div>


<span class="c1"># Functions to run as callback after a successful ray init.</span>
<span class="n">_post_init_hooks</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="shutdown"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.shutdown">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">_exiting_interpreter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Disconnect the worker, and terminate processes started by ray.init().</span>

<span class="sd">    This will automatically run at the end when a Python process that uses Ray</span>
<span class="sd">    exits. It is ok to run this twice in a row. The primary use case for this</span>
<span class="sd">    function is to cleanup state between tests.</span>

<span class="sd">    Note that this will clear any remote function definitions, actor</span>
<span class="sd">    definitions, and existing actors, so if you wish to use any previously</span>
<span class="sd">    defined remote functions or actors after calling ray.shutdown(), then you</span>
<span class="sd">    need to redefine them. If they were defined in an imported module, then you</span>
<span class="sd">    will need to reload the module.</span>

<span class="sd">    Args:</span>
<span class="sd">        _exiting_interpreter (bool): True if this is called by the atexit hook</span>
<span class="sd">            and false otherwise. If we are exiting the interpreter, we will</span>
<span class="sd">            wait a little while to print any extra error messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_exiting_interpreter</span> <span class="ow">and</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="c1"># This is a duration to sleep before shutting down everything in order</span>
        <span class="c1"># to make sure that log messages finish printing.</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">disconnect</span><span class="p">(</span><span class="n">_exiting_interpreter</span><span class="p">)</span>

    <span class="c1"># disconnect internal kv</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">global_worker</span><span class="p">,</span> <span class="s2">&quot;gcs_client&quot;</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">gcs_client</span>
    <span class="n">_internal_kv_reset</span><span class="p">()</span>

    <span class="c1"># We need to destruct the core worker here because after this function,</span>
    <span class="c1"># we will tear down any processes spawned by ray.init() and the background</span>
    <span class="c1"># IO thread in the core worker doesn&#39;t currently handle that gracefully.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">global_worker</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
        <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span>
    <span class="c1"># We need to reset function actor manager to clear the context</span>
    <span class="n">global_worker</span><span class="o">.</span><span class="n">function_actor_manager</span> <span class="o">=</span> <span class="n">FunctionActorManager</span><span class="p">(</span><span class="n">global_worker</span><span class="p">)</span>
    <span class="c1"># Disconnect global state from GCS.</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="c1"># Shut down the Ray processes.</span>
    <span class="k">global</span> <span class="n">_global_node</span>
    <span class="k">if</span> <span class="n">_global_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_global_node</span><span class="o">.</span><span class="n">is_head</span><span class="p">():</span>
            <span class="n">_global_node</span><span class="o">.</span><span class="n">destroy_external_storage</span><span class="p">()</span>
        <span class="n">_global_node</span><span class="o">.</span><span class="n">kill_all_processes</span><span class="p">(</span><span class="n">check_alive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_graceful</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_global_node</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TODO(rkn): Instead of manually resetting some of the worker fields, we</span>
    <span class="c1"># should simply set &quot;global_worker&quot; to equal &quot;None&quot; or something like that.</span>
    <span class="n">global_worker</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>


<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">shutdown</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="c1"># TODO(edoakes): this should only be set in the driver.</span>
<div class="viewcode-block" id="sigterm_handler"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.sigterm_handler">[docs]</a><span class="k">def</span> <span class="nf">sigterm_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">signum</span><span class="p">)</span></div>


<span class="k">try</span><span class="p">:</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_sigterm_handler</span><span class="p">(</span><span class="n">sigterm_handler</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to set SIGTERM handler, processes might&quot;</span>
                   <span class="s2">&quot;not be cleaned up properly on exit.&quot;</span><span class="p">)</span>

<span class="c1"># Define a custom excepthook so that if the driver exits with an exception, we</span>
<span class="c1"># can push that exception to Redis.</span>
<span class="n">normal_excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>


<div class="viewcode-block" id="custom_excepthook"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.custom_excepthook">[docs]</a><span class="k">def</span> <span class="nf">custom_excepthook</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
    <span class="c1"># If this is a driver, push the exception to GCS worker table.</span>
    <span class="k">if</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">global_worker</span><span class="p">,</span>
                                                     <span class="s2">&quot;worker_id&quot;</span><span class="p">):</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">))</span>
        <span class="n">worker_id</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">worker_id</span>
        <span class="n">worker_type</span> <span class="o">=</span> <span class="n">gcs_utils</span><span class="o">.</span><span class="n">DRIVER</span>
        <span class="n">worker_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">}</span>

        <span class="n">ray</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_check_connected</span><span class="p">()</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">add_worker</span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">worker_type</span><span class="p">,</span> <span class="n">worker_info</span><span class="p">)</span>
    <span class="c1"># Call the normal excepthook.</span>
    <span class="n">normal_excepthook</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span></div>


<span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">custom_excepthook</span>


<div class="viewcode-block" id="print_to_stdstream"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.print_to_stdstream">[docs]</a><span class="k">def</span> <span class="nf">print_to_stdstream</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">print_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_err&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">print_worker_logs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">print_file</span><span class="p">)</span></div>


<span class="c1"># Start time of this process, used for relative time logs.</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">autoscaler_log_fyi_printed</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="filter_autoscaler_events"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.filter_autoscaler_events">[docs]</a><span class="k">def</span> <span class="nf">filter_autoscaler_events</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Given raw log lines from the monitor, return only autoscaler events.</span>

<span class="sd">    Autoscaler events are denoted by the &quot;:event_summary:&quot; magic token.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">autoscaler_log_fyi_printed</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">AUTOSCALER_EVENTS</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Print out autoscaler events only, ignoring other messages.</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">LOG_PREFIX_EVENT_SUMMARY</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">autoscaler_log_fyi_printed</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="s2">&quot;Tip: use `ray status` to view detailed &quot;</span>
                       <span class="s2">&quot;cluster status. To disable these &quot;</span>
                       <span class="s2">&quot;messages, set RAY_SCHEDULER_EVENTS=0.&quot;</span><span class="p">)</span>
                <span class="n">autoscaler_log_fyi_printed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># The event text immediately follows the &quot;:event_summary:&quot;</span>
            <span class="c1"># magic token.</span>
            <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">LOG_PREFIX_EVENT_SUMMARY</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="time_string"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.time_string">[docs]</a><span class="k">def</span> <span class="nf">time_string</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the relative time from the start of this job.</span>

<span class="sd">    For example, 15m30s.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">minutes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>
        <span class="n">hours</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">delta</span> <span class="o">-=</span> <span class="mi">3600</span>
    <span class="k">while</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">minutes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">delta</span> <span class="o">-=</span> <span class="mi">60</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hours</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">h&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minutes</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">output</span></div>


<span class="c1"># When we enter a breakpoint, worker logs are automatically disabled via this.</span>
<span class="n">_worker_logs_enabled</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="print_worker_logs"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.print_worker_logs">[docs]</a><span class="k">def</span> <span class="nf">print_worker_logs</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">print_file</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_worker_logs_enabled</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">prefix_for</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The PID prefix for this log line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;autoscaler&quot;</span><span class="p">,</span> <span class="s2">&quot;raylet&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;pid=&quot;</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actor_name&quot;</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;actor_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">res</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_name&quot;</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;task_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">res</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">color_for</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The color for this log line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raylet&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;autoscaler&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Error:&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;Warning:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span>

    <span class="k">def</span> <span class="nf">end_for</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;autoscaler&quot;</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s2">&quot;scheduler +</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_string</span><span class="p">())</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">filter_autoscaler_events</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">(</span><span class="si">{}{}</span><span class="s2">)</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">DIM</span><span class="p">,</span>
                                           <span class="n">color_for</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span>
                                           <span class="n">prefix_for</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">pid</span><span class="p">,</span>
                                           <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">print_file</span><span class="p">,</span>
                  <span class="n">end</span><span class="o">=</span><span class="n">end_for</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">(</span><span class="si">{}{}</span><span class="s2">, ip=</span><span class="si">{}</span><span class="s2">)</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">DIM</span><span class="p">,</span>
                                                  <span class="n">color_for</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span>
                                                  <span class="n">prefix_for</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">pid</span><span class="p">,</span>
                                                  <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">),</span>
                                                  <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">,</span>
                                                  <span class="n">line</span><span class="p">),</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">print_file</span><span class="p">,</span>
                  <span class="n">end</span><span class="o">=</span><span class="n">end_for</span><span class="p">(</span><span class="n">line</span><span class="p">))</span></div>


<div class="viewcode-block" id="listen_error_messages_raylet"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.listen_error_messages_raylet">[docs]</a><span class="k">def</span> <span class="nf">listen_error_messages_raylet</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">threads_stopped</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Listen to error messages in the background on the driver.</span>

<span class="sd">    This runs in a separate thread on the driver and pushes (error, time)</span>
<span class="sd">    tuples to the output queue.</span>

<span class="sd">    Args:</span>
<span class="sd">        worker: The worker class that this thread belongs to.</span>
<span class="sd">        threads_stopped (threading.Event): A threading event used to signal to</span>
<span class="sd">            the thread that it should exit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">error_message_pubsub_client</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">pubsub</span><span class="p">(</span>
        <span class="n">ignore_subscribe_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Exports that are published after the call to</span>
    <span class="c1"># error_message_pubsub_client.subscribe and before the call to</span>
    <span class="c1"># error_message_pubsub_client.listen will still be processed in the loop.</span>

    <span class="c1"># Really we should just subscribe to the errors for this specific job.</span>
    <span class="c1"># However, currently all errors seem to be published on the same channel.</span>
    <span class="n">error_pubsub_channel</span> <span class="o">=</span> <span class="n">gcs_utils</span><span class="o">.</span><span class="n">RAY_ERROR_PUBSUB_PATTERN</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">error_message_pubsub_client</span><span class="o">.</span><span class="n">psubscribe</span><span class="p">(</span><span class="n">error_pubsub_channel</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_internal_kv_initialized</span><span class="p">():</span>
            <span class="c1"># Get any autoscaler errors that occurred before the call to</span>
            <span class="c1"># subscribe.</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">_internal_kv_get</span><span class="p">(</span><span class="n">DEBUG_AUTOSCALING_ERROR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Exit if we received a signal that we should stop.</span>
            <span class="k">if</span> <span class="n">threads_stopped</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">error_message_pubsub_client</span><span class="o">.</span><span class="n">get_message</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">threads_stopped</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">pubsub_msg</span> <span class="o">=</span> <span class="n">gcs_utils</span><span class="o">.</span><span class="n">PubSubMessage</span><span class="o">.</span><span class="n">FromString</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
            <span class="n">error_data</span> <span class="o">=</span> <span class="n">gcs_utils</span><span class="o">.</span><span class="n">ErrorTableData</span><span class="o">.</span><span class="n">FromString</span><span class="p">(</span><span class="n">pubsub_msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">error_data</span><span class="o">.</span><span class="n">job_id</span>
            <span class="k">if</span> <span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">current_job_id</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
                    <span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
            <span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_data</span><span class="o">.</span><span class="n">error_message</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">error_data</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">TASK_PUSH_ERROR</span><span class="p">):</span>
                <span class="c1"># TODO(ekl) remove task push errors entirely now that we have</span>
                <span class="c1"># the separate unhandled exception handler.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">redis</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;listen_error_messages_raylet: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Close the pubsub client to avoid leaking file descriptors.</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">error_message_pubsub_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="listen_error_messages_from_gcs"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.listen_error_messages_from_gcs">[docs]</a><span class="k">def</span> <span class="nf">listen_error_messages_from_gcs</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">threads_stopped</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Listen to error messages in the background on the driver.</span>

<span class="sd">    This runs in a separate thread on the driver and pushes (error, time)</span>
<span class="sd">    tuples to be published.</span>

<span class="sd">    Args:</span>
<span class="sd">        worker: The worker class that this thread belongs to.</span>
<span class="sd">        threads_stopped (threading.Event): A threading event used to signal to</span>
<span class="sd">            the thread that it should exit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: we should just subscribe to the errors for this specific job.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">gcs_error_subscriber</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_internal_kv_initialized</span><span class="p">():</span>
            <span class="c1"># Get any autoscaler errors that occurred before the call to</span>
            <span class="c1"># subscribe.</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">_internal_kv_get</span><span class="p">(</span><span class="n">DEBUG_AUTOSCALING_ERROR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Exit if received a signal that the thread should stop.</span>
            <span class="k">if</span> <span class="n">threads_stopped</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">error_data</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">gcs_error_subscriber</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">error_data</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">current_job_id</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
                    <span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
            <span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_data</span><span class="o">.</span><span class="n">error_message</span>
            <span class="k">if</span> <span class="n">error_data</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">TASK_PUSH_ERROR</span><span class="p">:</span>
                <span class="c1"># TODO(ekl) remove task push errors entirely now that we have</span>
                <span class="c1"># the separate unhandled exception handler.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;listen_error_messages_from_gcs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_initialized"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.is_initialized">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">is_initialized</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check if ray.init has been called yet.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if ray.init has already been called and false otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">global_worker</span><span class="o">.</span><span class="n">connected</span></div>


<div class="viewcode-block" id="connect"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.connect">[docs]</a><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">WORKER_MODE</span><span class="p">,</span>
            <span class="n">log_to_driver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">worker</span><span class="o">=</span><span class="n">global_worker</span><span class="p">,</span>
            <span class="n">driver_object_store_memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">runtime_env_hash</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">worker_shim_pid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">startup_token</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ray_debugger_external</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Connect this worker to the raylet, to Plasma, and to Redis.</span>

<span class="sd">    Args:</span>
<span class="sd">        node (ray.node.Node): The node to connect.</span>
<span class="sd">        mode: The mode of the worker. One of SCRIPT_MODE, WORKER_MODE, and</span>
<span class="sd">            LOCAL_MODE.</span>
<span class="sd">        log_to_driver (bool): If true, then output from all of the worker</span>
<span class="sd">            processes on all nodes will be directed to the driver.</span>
<span class="sd">        worker: The ray.Worker instance.</span>
<span class="sd">        driver_object_store_memory: Deprecated.</span>
<span class="sd">        job_id: The ID of job. If it&#39;s None, then we will generate one.</span>
<span class="sd">        job_config (ray.job_config.JobConfig): The job configuration.</span>
<span class="sd">        runtime_env_hash (int): The hash of the runtime env for this worker.</span>
<span class="sd">        worker_shim_pid (int): The PID of the process for setup worker</span>
<span class="sd">            runtime env.</span>
<span class="sd">        startup_token (int): The startup token of the process assigned to</span>
<span class="sd">            it during startup as a command line argument.</span>
<span class="sd">        ray_debugger_host (bool): The host to bind a Ray debugger to on</span>
<span class="sd">            this worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Do some basic checking to make sure we didn&#39;t call ray.init twice.</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Perhaps you called ray.init twice by accident?&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">worker</span><span class="o">.</span><span class="n">connected</span><span class="p">,</span> <span class="n">error_message</span>
    <span class="k">assert</span> <span class="n">worker</span><span class="o">.</span><span class="n">cached_functions_to_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_message</span>

    <span class="c1"># Enable nice stack traces on SIGSEGV etc.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">faulthandler</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">():</span>
            <span class="n">faulthandler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">all_threads</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">io</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># ignore</span>

    <span class="c1"># Create a Redis client to primary.</span>
    <span class="c1"># The Redis client can safely be shared between threads. However,</span>
    <span class="c1"># that is not true of Redis pubsub clients. See the documentation at</span>
    <span class="c1"># https://github.com/andymccurdy/redis-py#thread-safety.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">redis_client</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">create_redis_client</span><span class="p">()</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">gcs_channel</span> <span class="o">=</span> <span class="n">gcs_utils</span><span class="o">.</span><span class="n">GcsChannel</span><span class="p">(</span><span class="n">redis_client</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">redis_client</span><span class="p">)</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span> <span class="o">=</span> <span class="n">gcs_utils</span><span class="o">.</span><span class="n">GcsClient</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_channel</span><span class="p">)</span>
    <span class="n">_initialize_internal_kv</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span><span class="p">)</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_initialize_global_state</span><span class="p">(</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">GcsClientOptions</span><span class="o">.</span><span class="n">from_redis_address</span><span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">redis_address</span><span class="p">,</span> <span class="n">redis_password</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">redis_password</span><span class="p">))</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">gcs_pubsub_enabled</span> <span class="o">=</span> <span class="n">gcs_pubsub_enabled</span><span class="p">()</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">gcs_publisher</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">gcs_pubsub_enabled</span><span class="p">:</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">gcs_publisher</span> <span class="o">=</span> <span class="n">GcsPublisher</span><span class="p">(</span>
            <span class="n">channel</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_channel</span><span class="o">.</span><span class="n">channel</span><span class="p">())</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">gcs_error_subscriber</span> <span class="o">=</span> <span class="n">GcsErrorSubscriber</span><span class="p">(</span>
            <span class="n">channel</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_channel</span><span class="o">.</span><span class="n">channel</span><span class="p">())</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">gcs_log_subscriber</span> <span class="o">=</span> <span class="n">GcsLogSubscriber</span><span class="p">(</span>
            <span class="n">channel</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_channel</span><span class="o">.</span><span class="n">channel</span><span class="p">())</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">gcs_function_key_subscriber</span> <span class="o">=</span> <span class="n">GcsFunctionKeySubscriber</span><span class="p">(</span>
            <span class="n">channel</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_channel</span><span class="o">.</span><span class="n">channel</span><span class="p">())</span>

    <span class="c1"># Initialize some fields.</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">WORKER_MODE</span><span class="p">,</span> <span class="n">RESTORE_WORKER_MODE</span><span class="p">,</span> <span class="n">SPILL_WORKER_MODE</span><span class="p">):</span>
        <span class="c1"># We should not specify the job_id if it&#39;s `WORKER_MODE`.</span>
        <span class="k">assert</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This is the code path of driver mode.</span>
        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">next_job_id</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SCRIPT_MODE</span> <span class="ow">and</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LOCAL_MODE</span> <span class="ow">and</span> <span class="n">setproctitle</span><span class="p">:</span>
        <span class="n">process_name</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">WORKER_PROCESS_TYPE_IDLE_WORKER</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">SPILL_WORKER_MODE</span><span class="p">:</span>
            <span class="n">process_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">WORKER_PROCESS_TYPE_SPILL_WORKER_IDLE</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">RESTORE_WORKER_MODE</span><span class="p">:</span>
            <span class="n">process_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ray_constants</span><span class="o">.</span><span class="n">WORKER_PROCESS_TYPE_RESTORE_WORKER_IDLE</span><span class="p">)</span>
        <span class="n">setproctitle</span><span class="o">.</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">process_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">JobID</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The type of given job id must be JobID.&quot;</span><span class="p">)</span>

    <span class="c1"># All workers start out as non-actors. A worker can be turned into an actor</span>
    <span class="c1"># after it is created.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

    <span class="c1"># For driver&#39;s check that the version information matches the version</span>
    <span class="c1"># information that the Ray cluster was started with.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">check_version_info</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">redis_client</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">WORKER_MODE</span><span class="p">:</span>
            <span class="n">traceback_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">publish_error_to_driver</span><span class="p">(</span>
                <span class="n">ray_constants</span><span class="o">.</span><span class="n">VERSION_MISMATCH_PUSH_ERROR</span><span class="p">,</span>
                <span class="n">traceback_str</span><span class="p">,</span>
                <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">redis_client</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">redis_client</span><span class="p">,</span>
                <span class="n">gcs_publisher</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_publisher</span><span class="p">)</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

    <span class="n">driver_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">log_stdout_file_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">log_stderr_file_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">interactive_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">__main__</span> <span class="k">as</span> <span class="nn">main</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">):</span>
            <span class="n">driver_name</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interactive_mode</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">driver_name</span> <span class="o">=</span> <span class="s2">&quot;INTERACTIVE MODE&quot;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid worker mode. Expected DRIVER, WORKER or LOCAL.&quot;</span><span class="p">)</span>

    <span class="n">redis_address</span><span class="p">,</span> <span class="n">redis_port</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">redis_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="c1"># As the synchronous and the asynchronous context of redis client is not</span>
    <span class="c1"># used in this gcs client. We would not open connection for it by setting</span>
    <span class="c1"># `enable_sync_conn` and `enable_async_conn` as false.</span>
    <span class="n">gcs_options</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">GcsClientOptions</span><span class="o">.</span><span class="n">from_redis_address</span><span class="p">(</span>
        <span class="n">node</span><span class="o">.</span><span class="n">redis_address</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">redis_password</span><span class="p">,</span>
        <span class="n">enable_sync_conn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">enable_async_conn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">enable_subscribe_conn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">job_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_config</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">job_config</span><span class="o">.</span><span class="n">JobConfig</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">validate_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

        <span class="c1"># The namespace field of job config may have already been set in code</span>
        <span class="c1"># paths such as the client.</span>
        <span class="n">job_config</span><span class="o">.</span><span class="n">set_ray_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

    <span class="c1"># Make sure breakpoint() in the user&#39;s code will</span>
    <span class="c1"># invoke the Ray debugger if we are in a worker or actor process</span>
    <span class="c1"># (but not on the driver).</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">WORKER_MODE</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONBREAKPOINT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ray.util.rpdb.set_trace&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Add hook to suppress worker logs during breakpoint.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONBREAKPOINT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ray.util.rpdb._driver_set_trace&quot;</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">ray_debugger_external</span> <span class="o">=</span> <span class="n">ray_debugger_external</span>

    <span class="c1"># If it&#39;s a driver and it&#39;s not coming from ray client, we&#39;ll prepare the</span>
    <span class="c1"># environment here. If it&#39;s ray client, the environment will be prepared</span>
    <span class="c1"># at the server side.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">client_job</span> <span class="ow">and</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">runtime_env</span><span class="p">):</span>
        <span class="n">scratch_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_runtime_env_dir_path</span><span class="p">()</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">job_config</span><span class="o">.</span><span class="n">runtime_env</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">upload_py_modules_if_needed</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">,</span>
                                                  <span class="n">scratch_dir</span><span class="p">,</span>
                                                  <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">upload_working_dir_if_needed</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">,</span>
                                                   <span class="n">scratch_dir</span><span class="p">,</span>
                                                   <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="c1"># Remove excludes, it isn&#39;t relevant after the upload step.</span>
        <span class="n">runtime_env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;excludes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">job_config</span><span class="o">.</span><span class="n">set_runtime_env</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">)</span>

    <span class="n">serialized_job_config</span> <span class="o">=</span> <span class="n">job_config</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">CoreWorker</span><span class="p">(</span>
        <span class="n">mode</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">plasma_store_socket_name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">raylet_socket_name</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span>
        <span class="n">gcs_options</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get_logs_dir_path</span><span class="p">(),</span> <span class="n">node</span><span class="o">.</span><span class="n">node_ip_address</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">node_manager_port</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">raylet_ip_address</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">),</span>
        <span class="n">driver_name</span><span class="p">,</span> <span class="n">log_stdout_file_path</span><span class="p">,</span> <span class="n">log_stderr_file_path</span><span class="p">,</span>
        <span class="n">serialized_job_config</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">metrics_agent_port</span><span class="p">,</span> <span class="n">runtime_env_hash</span><span class="p">,</span>
        <span class="n">worker_shim_pid</span><span class="p">,</span> <span class="n">startup_token</span><span class="p">)</span>

    <span class="c1"># Notify raylet that the core worker is ready.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">notify_raylet</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">driver_object_store_memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;`driver_object_store_memory` is deprecated&quot;</span>
                       <span class="s2">&quot; and will be removed in the future.&quot;</span><span class="p">)</span>

    <span class="c1"># Start the import thread</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">RESTORE_WORKER_MODE</span><span class="p">,</span> <span class="n">SPILL_WORKER_MODE</span><span class="p">):</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">import_thread</span> <span class="o">=</span> <span class="n">import_thread</span><span class="o">.</span><span class="n">ImportThread</span><span class="p">(</span>
            <span class="n">worker</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">threads_stopped</span><span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">import_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># If this is a driver running in SCRIPT_MODE, start a thread to print error</span>
    <span class="c1"># messages asynchronously in the background. Ideally the scheduler would</span>
    <span class="c1"># push messages to the driver&#39;s worker service, but we ran into bugs when</span>
    <span class="c1"># trying to properly shutdown the driver&#39;s worker service, so we are</span>
    <span class="c1"># temporarily using this implementation which constantly queries the</span>
    <span class="c1"># scheduler for new error messages.</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">listener_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">listen_error_messages_from_gcs</span>
            <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">gcs_pubsub_enabled</span> <span class="k">else</span> <span class="n">listen_error_messages_raylet</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ray_listen_error_messages&quot;</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">threads_stopped</span><span class="p">))</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">log_to_driver</span><span class="p">:</span>
            <span class="n">global_worker_stdstream_dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
                <span class="s2">&quot;ray_print_logs&quot;</span><span class="p">,</span> <span class="n">print_to_stdstream</span><span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">logger_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">print_logs</span><span class="p">,</span>
                                                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ray_print_logs&quot;</span><span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">logger_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">logger_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="c1"># Add the directory containing the script that is running to the Python</span>
        <span class="c1"># paths of the workers. Also add the current directory. Note that this</span>
        <span class="c1"># assumes that the directory structures on the machines in the clusters</span>
        <span class="c1"># are the same.</span>
        <span class="c1"># When using an interactive shell, there is no script directory.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">interactive_mode</span><span class="p">:</span>
            <span class="n">script_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">run_function_on_all_workers</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">worker_info</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">script_directory</span><span class="p">))</span>
        <span class="c1"># In client mode, if we use runtime envs with &quot;working_dir&quot;, then</span>
        <span class="c1"># it&#39;ll be handled automatically.  Otherwise, add the current dir.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">client_job</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">runtime_env_has_uris</span><span class="p">():</span>
            <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">run_function_on_all_workers</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">worker_info</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">current_directory</span><span class="p">))</span>
        <span class="c1"># TODO(rkn): Here we first export functions to run, then remote</span>
        <span class="c1"># functions. The order matters. For example, one of the functions to</span>
        <span class="c1"># run may set the Python path, which is needed to import a module used</span>
        <span class="c1"># to define a remote function. We may want to change the order to</span>
        <span class="c1"># simply be the order in which the exports were defined on the driver.</span>
        <span class="c1"># In addition, we will need to retain the ability to decide what the</span>
        <span class="c1"># first few exports are (mostly to set the Python path). Additionally,</span>
        <span class="c1"># note that the first exports to be defined on the driver will be the</span>
        <span class="c1"># ones defined in separate modules that are imported by the driver.</span>
        <span class="c1"># Export cached functions_to_run.</span>
        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">worker</span><span class="o">.</span><span class="n">cached_functions_to_run</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">run_function_on_all_workers</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">cached_functions_to_run</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Setup tracing here</span>
    <span class="n">tracing_hook_val</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span><span class="o">.</span><span class="n">internal_kv_get</span><span class="p">(</span>
        <span class="sa">b</span><span class="s2">&quot;tracing_startup_hook&quot;</span><span class="p">,</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">KV_NAMESPACE_TRACING</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tracing_hook_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tracing</span><span class="o">.</span><span class="n">tracing_helper</span><span class="o">.</span><span class="n">_global_is_tracing_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="s2">&quot;__traced__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">_setup_tracing</span> <span class="o">=</span> <span class="n">import_from_string</span><span class="p">(</span>
                <span class="n">tracing_hook_val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="n">_setup_tracing</span><span class="p">()</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">__traced__</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="disconnect"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.disconnect">[docs]</a><span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="n">exiting_interpreter</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Disconnect this worker from the raylet and object store.&quot;&quot;&quot;</span>
    <span class="c1"># Reset the list of cached remote functions and actors so that if more</span>
    <span class="c1"># remote functions or actors are defined and then connect is called again,</span>
    <span class="c1"># the remote functions will be exported. This is mostly relevant for the</span>
    <span class="c1"># tests.</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
        <span class="c1"># Shutdown all of the threads that we&#39;ve started. TODO(rkn): This</span>
        <span class="c1"># should be handled cleanly in the worker object&#39;s destructor and not</span>
        <span class="c1"># in this disconnect method.</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">threads_stopped</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">gcs_pubsub_enabled</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">gcs_function_key_subscriber</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">gcs_error_subscriber</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">gcs_log_subscriber</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;import_thread&quot;</span><span class="p">):</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">import_thread</span><span class="o">.</span><span class="n">join_import_thread</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;listener_thread&quot;</span><span class="p">):</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;logger_thread&quot;</span><span class="p">):</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">logger_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">threads_stopped</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">_session_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">global_worker_stdstream_dispatcher</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="s2">&quot;ray_print_logs&quot;</span><span class="p">)</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Disconnect the worker from the node.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">cached_functions_to_run</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">serialization_context_map</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ray_actor</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">ray_actor</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># This can occur during program termination</span>
    <span class="k">if</span> <span class="n">ray_actor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray_actor</span><span class="o">.</span><span class="n">ActorClassMethodMetadata</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span></div>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_changeproctitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">next_title</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_mode</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
        <span class="n">setproctitle</span><span class="o">.</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_mode</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
            <span class="n">setproctitle</span><span class="o">.</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">next_title</span><span class="p">)</span>


<div class="viewcode-block" id="show_in_dashboard"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.show_in_dashboard">[docs]</a><span class="nd">@DeveloperAPI</span>
<span class="k">def</span> <span class="nf">show_in_dashboard</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display message in dashboard.</span>

<span class="sd">    Display message for the current task or actor in the dashboard.</span>
<span class="sd">    For example, this can be used to display the status of a long-running</span>
<span class="sd">    computation.</span>

<span class="sd">    Args:</span>
<span class="sd">        message (str): Message to be displayed.</span>
<span class="sd">        key (str): The key name for the message. Multiple message under</span>
<span class="sd">            different keys will be displayed at the same time. Messages</span>
<span class="sd">            under the same key will be overridden.</span>
<span class="sd">        data_type (str): The type of message for rendering. One of the</span>
<span class="sd">            following: text, html.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="n">acceptable_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">acceptable_dtypes</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;dtype accepts only: </span><span class="si">{</span><span class="n">acceptable_dtypes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">message_wrapped</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">}</span>
    <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message_wrapped</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">set_webui_display</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">message_encoded</span><span class="p">)</span></div>


<span class="c1"># Global variable to make sure we only send out the warning once.</span>
<span class="n">blocking_get_inside_async_warned</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="get"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.get">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">object_refs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Get a remote object or a list of remote objects from the object store.</span>

<span class="sd">    This method blocks until the object corresponding to the object ref is</span>
<span class="sd">    available in the local object store. If this object is not in the local</span>
<span class="sd">    object store, it will be shipped from an object store that has it (once the</span>
<span class="sd">    object has been created). If object_refs is a list, then the objects</span>
<span class="sd">    corresponding to each object in the list will be returned.</span>

<span class="sd">    Ordering for an input list of object refs is preserved for each object</span>
<span class="sd">    returned. That is, if an object ref to A precedes an object ref to B in the</span>
<span class="sd">    input list, then A will precede B in the returned list.</span>

<span class="sd">    This method will issue a warning if it&#39;s running inside async context,</span>
<span class="sd">    you can use ``await object_ref`` instead of ``ray.get(object_ref)``. For</span>
<span class="sd">    a list of object refs, you can use ``await asyncio.gather(*object_refs)``.</span>

<span class="sd">    Args:</span>
<span class="sd">        object_refs: Object ref of the object to get or a list of object refs</span>
<span class="sd">            to get.</span>
<span class="sd">        timeout (Optional[float]): The maximum amount of time in seconds to</span>
<span class="sd">            wait before returning.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Python object or a list of Python objects.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GetTimeoutError: A GetTimeoutError is raised if a timeout is set and</span>
<span class="sd">            the get takes longer than timeout to return.</span>
<span class="sd">        Exception: An exception is raised if the task that created the object</span>
<span class="sd">            or that created one of the objects raised an exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span>
               <span class="s2">&quot;core_worker&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">current_actor_is_asyncio</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">blocking_get_inside_async_warned</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_get_inside_async_warned</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using blocking ray.get inside async actor. &quot;</span>
                           <span class="s2">&quot;This blocks the event loop. Please use `await` &quot;</span>
                           <span class="s2">&quot;on object ref with asyncio.gather if you want to &quot;</span>
                           <span class="s2">&quot;yield execution to the event loop instead.&quot;</span><span class="p">)</span>
            <span class="n">blocking_get_inside_async_warned</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="n">profiling</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s2">&quot;ray.get&quot;</span><span class="p">):</span>
        <span class="n">is_individual_id</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_individual_id</span><span class="p">:</span>
            <span class="n">object_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">object_refs</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;object_refs&#39; must either be an object ref &quot;</span>
                             <span class="s2">&quot;or a list of object refs.&quot;</span><span class="p">)</span>

        <span class="c1"># TODO(ujvl): Consider how to allow user to retrieve the ready objects.</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">debugger_breakpoint</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">get_objects</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span>
                                                         <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">RayError</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ObjectLostError</span><span class="p">):</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">dump_object_store_memory_usage</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">RayTaskError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">value</span><span class="o">.</span><span class="n">as_instanceof_cause</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">is_individual_id</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debugger_breakpoint</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
            <span class="n">rdb</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">connect_ray_pdb</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">patch_stdstreams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">quiet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">breakpoint_uuid</span><span class="o">=</span><span class="n">debugger_breakpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">debugger_breakpoint</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">debugger_external</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">ray_debugger_external</span><span class="p">)</span>
            <span class="n">rdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span></div>


<div class="viewcode-block" id="put"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.put">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_owner</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ray.actor.ActorHandle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Store an object in the object store.</span>

<span class="sd">    The object may not be evicted while a reference to the returned ID exists.</span>

<span class="sd">    Args:</span>
<span class="sd">        value: The Python object to be stored.</span>
<span class="sd">        _owner: The actor that should own this object. This allows creating</span>
<span class="sd">            objects with lifetimes decoupled from that of the creating process.</span>
<span class="sd">            Note that the owner actor must be passed a reference to the object</span>
<span class="sd">            prior to the object creator exiting, otherwise the reference will</span>
<span class="sd">            still be lost.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The object ref assigned to this value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_owner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">serialize_owner_address</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_owner</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ActorHandle</span><span class="p">):</span>
        <span class="c1"># Ensure `ray.state.state.global_state_accessor` is not None</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_check_connected</span><span class="p">()</span>
        <span class="n">owner_address</span> <span class="o">=</span> <span class="n">gcs_utils</span><span class="o">.</span><span class="n">ActorTableData</span><span class="o">.</span><span class="n">FromString</span><span class="p">(</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">global_state_accessor</span><span class="o">.</span><span class="n">get_actor_info</span><span class="p">(</span>
                <span class="n">_owner</span><span class="o">.</span><span class="n">_actor_id</span><span class="p">))</span><span class="o">.</span><span class="n">address</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">owner_address</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_owner</span><span class="si">}</span><span class="s2"> is not alive, it&#39;s worker_id is empty!&quot;</span><span class="p">)</span>
        <span class="n">serialize_owner_address</span> <span class="o">=</span> <span class="n">owner_address</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expect an `ray.actor.ActorHandle`, but got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">_owner</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">profiling</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s2">&quot;ray.put&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">object_ref</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">owner_address</span><span class="o">=</span><span class="n">serialize_owner_address</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectStoreFullError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Put failed since the value was either too large or the &quot;</span>
                <span class="s2">&quot;store was full of pinned objects.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">object_ref</span></div>


<span class="c1"># Global variable to make sure we only send out the warning once.</span>
<span class="n">blocking_wait_inside_async_warned</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="wait"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.wait">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">wait</span><span class="p">(</span>
    <span class="n">object_refs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">num_returns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fetch_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Return a list of IDs that are ready and a list of IDs that are not.</span>

<span class="sd">    If timeout is set, the function returns either when the requested number of</span>
<span class="sd">    IDs are ready or when the timeout is reached, whichever occurs first. If it</span>
<span class="sd">    is not set, the function simply waits until that number of objects is ready</span>
<span class="sd">    and returns that exact number of object refs.</span>

<span class="sd">    This method returns two lists. The first list consists of object refs that</span>
<span class="sd">    correspond to objects that are available in the object store. The second</span>
<span class="sd">    list corresponds to the rest of the object refs (which may or may not be</span>
<span class="sd">    ready).</span>

<span class="sd">    Ordering of the input list of object refs is preserved. That is, if A</span>
<span class="sd">    precedes B in the input list, and both are in the ready list, then A will</span>
<span class="sd">    precede B in the ready list. This also holds true if A and B are both in</span>
<span class="sd">    the remaining list.</span>

<span class="sd">    This method will issue a warning if it&#39;s running inside an async context.</span>
<span class="sd">    Instead of ``ray.wait(object_refs)``, you can use</span>
<span class="sd">    ``await asyncio.wait(object_refs)``.</span>

<span class="sd">    Args:</span>
<span class="sd">        object_refs (List[ObjectRef]): List of object refs for objects that may</span>
<span class="sd">            or may not be ready. Note that these IDs must be unique.</span>
<span class="sd">        num_returns (int): The number of object refs that should be returned.</span>
<span class="sd">        timeout (float): The maximum amount of time in seconds to wait before</span>
<span class="sd">            returning.</span>
<span class="sd">        fetch_local (bool): If True, wait for the object to be downloaded onto</span>
<span class="sd">            the local node before returning it as ready. If False, ray.wait()</span>
<span class="sd">            will not trigger fetching of objects to the local node and will</span>
<span class="sd">            return immediately once the object is available anywhere in the</span>
<span class="sd">            cluster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of object refs that are ready and a list of the remaining object</span>
<span class="sd">        IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span>
               <span class="s2">&quot;core_worker&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">current_actor_is_asyncio</span><span class="p">(</span>
               <span class="p">)</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">blocking_wait_inside_async_warned</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_wait_inside_async_warned</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using blocking ray.wait inside async method. &quot;</span>
                         <span class="s2">&quot;This blocks the event loop. Please use `await` &quot;</span>
                         <span class="s2">&quot;on object ref with asyncio.wait. &quot;</span><span class="p">)</span>
            <span class="n">blocking_wait_inside_async_warned</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="n">ObjectRef</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;wait() expected a list of ray.ObjectRef, got a single &quot;</span>
                        <span class="s2">&quot;ray.ObjectRef&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;wait() expected a list of ray.ObjectRef, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">object_refs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;timeout&#39; argument must be nonnegative. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Received </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">object_ref</span> <span class="ow">in</span> <span class="n">object_refs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_ref</span><span class="p">,</span> <span class="n">ObjectRef</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;wait() expected a list of ray.ObjectRef, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;got list containing </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">object_ref</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
    <span class="c1"># TODO(swang): Check main thread.</span>
    <span class="k">with</span> <span class="n">profiling</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s2">&quot;ray.wait&quot;</span><span class="p">):</span>

        <span class="c1"># TODO(rkn): This is a temporary workaround for</span>
        <span class="c1"># https://github.com/ray-project/ray/issues/997. However, it should be</span>
        <span class="c1"># fixed in Arrow instead of here.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_refs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_refs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">object_refs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wait requires a list of unique object refs.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_returns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid number of objects to return </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span>
                             <span class="n">num_returns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_returns</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_refs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_returns cannot be greater than the number &quot;</span>
                             <span class="s2">&quot;of objects provided to ray.wait.&quot;</span><span class="p">)</span>

        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
        <span class="n">timeout_milliseconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">ready_ids</span><span class="p">,</span> <span class="n">remaining_ids</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
            <span class="n">object_refs</span><span class="p">,</span>
            <span class="n">num_returns</span><span class="p">,</span>
            <span class="n">timeout_milliseconds</span><span class="p">,</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">current_task_id</span><span class="p">,</span>
            <span class="n">fetch_local</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ready_ids</span><span class="p">,</span> <span class="n">remaining_ids</span></div>


<div class="viewcode-block" id="get_actor"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.get_actor">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_actor</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ray.actor.ActorHandle&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get a handle to a named actor.</span>

<span class="sd">    Gets a handle to an actor with the given name. The actor must</span>
<span class="sd">    have been created with Actor.options(name=&quot;name&quot;).remote(). This</span>
<span class="sd">    works for both detached &amp; non-detached actors.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the actor.</span>
<span class="sd">        namespace: The namespace of the actor, or None to specify the current</span>
<span class="sd">            namespace.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ActorHandle to the actor.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError if the named actor does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please supply a non-empty value to get_actor&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">validate_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_named_actor_handle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="kill"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.kill">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">actor</span><span class="p">:</span> <span class="s2">&quot;ray.actor.ActorHandle&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">no_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Kill an actor forcefully.</span>

<span class="sd">    This will interrupt any running tasks on the actor, causing them to fail</span>
<span class="sd">    immediately. ``atexit`` handlers installed in the actor will not be run.</span>

<span class="sd">    If you want to kill the actor but let pending tasks finish,</span>
<span class="sd">    you can call ``actor.__ray_terminate__.remote()`` instead to queue a</span>
<span class="sd">    termination task. Any ``atexit`` handlers installed in the actor *will*</span>
<span class="sd">    be run in this case.</span>

<span class="sd">    If the actor is a detached actor, subsequent calls to get its handle via</span>
<span class="sd">    ray.get_actor will fail.</span>

<span class="sd">    Args:</span>
<span class="sd">        actor (ActorHandle): Handle to the actor to kill.</span>
<span class="sd">        no_restart (bool): Whether or not this actor should be restarted if</span>
<span class="sd">            it&#39;s a restartable actor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ActorHandle</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ray.kill() only supported for actors. &quot;</span>
                         <span class="s2">&quot;Got: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">actor</span><span class="p">)))</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">kill_actor</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">_ray_actor_id</span><span class="p">,</span> <span class="n">no_restart</span><span class="p">)</span></div>


<div class="viewcode-block" id="cancel"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.cancel">[docs]</a><span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span><span class="p">(</span><span class="n">auto_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="n">object_ref</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">,</span>
           <span class="o">*</span><span class="p">,</span>
           <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
           <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cancels a task according to the following conditions.</span>

<span class="sd">    If the specified task is pending execution, it will not be executed. If</span>
<span class="sd">    the task is currently executing, the behavior depends on the ``force``</span>
<span class="sd">    flag. When ``force=False``, a KeyboardInterrupt will be raised in Python</span>
<span class="sd">    and when ``force=True``, the executing task will immediately exit.</span>
<span class="sd">    If the task is already finished, nothing will happen.</span>

<span class="sd">    Only non-actor tasks can be canceled. Canceled tasks will not be</span>
<span class="sd">    retried (max_retries will not be respected).</span>

<span class="sd">    Calling ray.get on a canceled task will raise a TaskCancelledError or a</span>
<span class="sd">    WorkerCrashedError if ``force=True``.</span>

<span class="sd">    Args:</span>
<span class="sd">        object_ref (ObjectRef): ObjectRef returned by the task</span>
<span class="sd">            that should be canceled.</span>
<span class="sd">        force (boolean): Whether to force-kill a running task by killing</span>
<span class="sd">            the worker that is running the task.</span>
<span class="sd">        recursive (boolean): Whether to try to cancel tasks submitted by the</span>
<span class="sd">            task specified.</span>
<span class="sd">    Raises:</span>
<span class="sd">        TypeError: This is also raised for actor tasks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_ref</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;ray.cancel() only supported for non-actor object refs. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">object_ref</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">cancel_task</span><span class="p">(</span><span class="n">object_ref</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">recursive</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_mode</span><span class="p">(</span><span class="n">worker</span><span class="o">=</span><span class="n">global_worker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a wrapper around worker.mode.</span>

<span class="sd">    We use this wrapper so that in the remote decorator, we can call _mode()</span>
<span class="sd">    instead of worker.mode. The difference is that when we attempt to</span>
<span class="sd">    serialize remote functions, we don&#39;t attempt to serialize the worker</span>
<span class="sd">    object, which cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">.</span><span class="n">mode</span>


<div class="viewcode-block" id="make_decorator"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.make_decorator">[docs]</a><span class="k">def</span> <span class="nf">make_decorator</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">num_cpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">num_gpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">object_store_memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">resources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">accelerator_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">max_calls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">max_retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">max_restarts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">max_task_retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">runtime_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">placement_group</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
                   <span class="n">worker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">retry_exceptions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">concurrency_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">scheduling_strategy</span><span class="p">:</span> <span class="n">SchedulingStrategyT</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">is_cython</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">)):</span>
            <span class="c1"># Set the remote function default resources.</span>
            <span class="k">if</span> <span class="n">max_restarts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The keyword &#39;max_restarts&#39; is not &quot;</span>
                                 <span class="s2">&quot;allowed for remote functions.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_task_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The keyword &#39;max_task_retries&#39; is not &quot;</span>
                                 <span class="s2">&quot;allowed for remote functions.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_returns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_returns</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span>
                                            <span class="n">num_returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The keyword &#39;num_returns&#39; only accepts 0 or a&quot;</span>
                                 <span class="s2">&quot; positive integer&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_retries</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span>
                                            <span class="n">max_retries</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The keyword &#39;max_retries&#39; only accepts 0, -1 or a&quot;</span>
                    <span class="s2">&quot; positive integer&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_calls</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span>
                                          <span class="n">max_calls</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The keyword &#39;max_calls&#39; only accepts 0 or a positive&quot;</span>
                    <span class="s2">&quot; integer&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">remote_function</span><span class="o">.</span><span class="n">RemoteFunction</span><span class="p">(</span>
                <span class="n">Language</span><span class="o">.</span><span class="n">PYTHON</span><span class="p">,</span> <span class="n">function_or_class</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_cpus</span><span class="p">,</span> <span class="n">num_gpus</span><span class="p">,</span>
                <span class="n">memory</span><span class="p">,</span> <span class="n">object_store_memory</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">accelerator_type</span><span class="p">,</span>
                <span class="n">num_returns</span><span class="p">,</span> <span class="n">max_calls</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">,</span> <span class="n">retry_exceptions</span><span class="p">,</span>
                <span class="n">runtime_env</span><span class="p">,</span> <span class="n">placement_group</span><span class="p">,</span> <span class="n">scheduling_strategy</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num_returns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The keyword &#39;num_returns&#39; is not &quot;</span>
                                <span class="s2">&quot;allowed for actors.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The keyword &#39;max_retries&#39; is not &quot;</span>
                                <span class="s2">&quot;allowed for actors.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">retry_exceptions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The keyword &#39;retry_exceptions&#39; is not &quot;</span>
                                <span class="s2">&quot;allowed for actors.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The keyword &#39;max_calls&#39; is not &quot;</span>
                                <span class="s2">&quot;allowed for actors.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_restarts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_restarts</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                                             <span class="ow">or</span> <span class="n">max_restarts</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The keyword &#39;max_restarts&#39; only accepts -1, 0 or a&quot;</span>
                    <span class="s2">&quot; positive integer&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_task_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">max_task_retries</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">max_task_retries</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The keyword &#39;max_task_retries&#39; only accepts -1, 0 or a&quot;</span>
                    <span class="s2">&quot; positive integer&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">make_actor</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">,</span> <span class="n">num_cpus</span><span class="p">,</span> <span class="n">num_gpus</span><span class="p">,</span>
                                        <span class="n">memory</span><span class="p">,</span> <span class="n">object_store_memory</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span>
                                        <span class="n">accelerator_type</span><span class="p">,</span> <span class="n">max_restarts</span><span class="p">,</span>
                                        <span class="n">max_task_retries</span><span class="p">,</span> <span class="n">runtime_env</span><span class="p">,</span>
                                        <span class="n">concurrency_groups</span><span class="p">,</span> <span class="n">scheduling_strategy</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The @ray.remote decorator must be applied to &quot;</span>
                        <span class="s2">&quot;either a function or to a class.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="remote"><a class="viewcode-back" href="../../../../sky.skylet.ray_patches.html#sky.skylet.ray_patches.worker.remote">[docs]</a><span class="nd">@PublicAPI</span>
<span class="k">def</span> <span class="nf">remote</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines a remote function or an actor class.</span>

<span class="sd">    This can be used with no arguments to define a remote function or actor as</span>
<span class="sd">    follows:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        @ray.remote</span>
<span class="sd">        def f():</span>
<span class="sd">            return 1</span>

<span class="sd">        @ray.remote</span>
<span class="sd">        class Foo:</span>
<span class="sd">            def method(self):</span>
<span class="sd">                return 1</span>

<span class="sd">    It can also be used with specific keyword arguments as follows:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        @ray.remote(num_gpus=1, max_calls=1, num_returns=2)</span>
<span class="sd">        def f():</span>
<span class="sd">            return 1, 2</span>

<span class="sd">        @ray.remote(num_cpus=2, resources={&quot;CustomResource&quot;: 1})</span>
<span class="sd">        class Foo:</span>
<span class="sd">            def method(self):</span>
<span class="sd">                return 1</span>

<span class="sd">    Remote task and actor objects returned by @ray.remote can also be</span>
<span class="sd">    dynamically modified with the same arguments as above using</span>
<span class="sd">    ``.options()`` as follows:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        @ray.remote(num_gpus=1, max_calls=1, num_returns=2)</span>
<span class="sd">        def f():</span>
<span class="sd">            return 1, 2</span>
<span class="sd">        g = f.options(num_gpus=2)</span>

<span class="sd">        @ray.remote(num_cpus=2, resources={&quot;CustomResource&quot;: 1})</span>
<span class="sd">        class Foo:</span>
<span class="sd">            def method(self):</span>
<span class="sd">                return 1</span>
<span class="sd">        Bar = Foo.options(num_cpus=1, resources=None)</span>

<span class="sd">    Running remote actors will be terminated when the actor handle to them</span>
<span class="sd">    in Python is deleted, which will cause them to complete any outstanding</span>
<span class="sd">    work and then shut down. If you want to kill them immediately, you can</span>
<span class="sd">    also call ``ray.kill(actor)``.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_returns (int): This is only for *remote functions*. It specifies</span>
<span class="sd">            the number of object refs returned by</span>
<span class="sd">            the remote function invocation.</span>
<span class="sd">        num_cpus (float): The quantity of CPU cores to reserve</span>
<span class="sd">            for this task or for the lifetime of the actor.</span>
<span class="sd">        num_gpus (int): The quantity of GPUs to reserve</span>
<span class="sd">            for this task or for the lifetime of the actor.</span>
<span class="sd">        resources (Dict[str, float]): The quantity of various custom resources</span>
<span class="sd">            to reserve for this task or for the lifetime of the actor.</span>
<span class="sd">            This is a dictionary mapping strings (resource names) to floats.</span>
<span class="sd">        accelerator_type: If specified, requires that the task or actor run</span>
<span class="sd">            on a node with the specified type of accelerator.</span>
<span class="sd">            See `ray.accelerators` for accelerator types.</span>
<span class="sd">        max_calls (int): Only for *remote functions*. This specifies the</span>
<span class="sd">            maximum number of times that a given worker can execute</span>
<span class="sd">            the given remote function before it must exit</span>
<span class="sd">            (this can be used to address memory leaks in third-party</span>
<span class="sd">            libraries or to reclaim resources that cannot easily be</span>
<span class="sd">            released, e.g., GPU memory that was acquired by TensorFlow).</span>
<span class="sd">            By default this is infinite.</span>
<span class="sd">        max_restarts (int): Only for *actors*. This specifies the maximum</span>
<span class="sd">            number of times that the actor should be restarted when it dies</span>
<span class="sd">            unexpectedly. The minimum valid value is 0 (default),</span>
<span class="sd">            which indicates that the actor doesn&#39;t need to be restarted.</span>
<span class="sd">            A value of -1 indicates that an actor should be restarted</span>
<span class="sd">            indefinitely.</span>
<span class="sd">        max_task_retries (int): Only for *actors*. How many times to</span>
<span class="sd">            retry an actor task if the task fails due to a system error,</span>
<span class="sd">            e.g., the actor has died. If set to -1, the system will</span>
<span class="sd">            retry the failed task until the task succeeds, or the actor</span>
<span class="sd">            has reached its max_restarts limit. If set to `n &gt; 0`, the</span>
<span class="sd">            system will retry the failed task up to n times, after which the</span>
<span class="sd">            task will throw a `RayActorError` exception upon :obj:`ray.get`.</span>
<span class="sd">            Note that Python exceptions are not considered system errors</span>
<span class="sd">            and will not trigger retries.</span>
<span class="sd">        max_retries (int): Only for *remote functions*. This specifies</span>
<span class="sd">            the maximum number of times that the remote function</span>
<span class="sd">            should be rerun when the worker process executing it</span>
<span class="sd">            crashes unexpectedly. The minimum valid value is 0,</span>
<span class="sd">            the default is 4 (default), and a value of -1 indicates</span>
<span class="sd">            infinite retries.</span>
<span class="sd">        runtime_env (Dict[str, Any]): Specifies the runtime environment for</span>
<span class="sd">            this actor or task and its children. See</span>
<span class="sd">            :ref:`runtime-environments` for detailed documentation. This API is</span>
<span class="sd">            in beta and may change before becoming stable.</span>
<span class="sd">        retry_exceptions (bool): Only for *remote functions*. This specifies</span>
<span class="sd">            whether application-level errors should be retried</span>
<span class="sd">            up to max_retries times.</span>
<span class="sd">        scheduling_strategy (SchedulingStrategyT): Strategy about how to</span>
<span class="sd">            schedule a remote function or actor. Possible values are</span>
<span class="sd">            None: ray will figure out the scheduling strategy to use, it</span>
<span class="sd">            will either be the PlacementGroupSchedulingStrategy using parent&#39;s</span>
<span class="sd">            placement group if parent has one and has</span>
<span class="sd">            placement_group_capture_child_tasks set to true,</span>
<span class="sd">            or &quot;DEFAULT&quot;;</span>
<span class="sd">            &quot;DEFAULT&quot;: default hybrid scheduling;</span>
<span class="sd">            &quot;SPREAD&quot;: best effort spread scheduling;</span>
<span class="sd">            `PlacementGroupSchedulingStrategy`:</span>
<span class="sd">            placement group based scheduling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># This is the case where the decorator is just @ray.remote.</span>
        <span class="k">return</span> <span class="n">make_decorator</span><span class="p">(</span><span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">)(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Parse the keyword arguments from the decorator.</span>
    <span class="n">valid_kwargs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;num_returns&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_cpus&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_gpus&quot;</span><span class="p">,</span>
        <span class="s2">&quot;memory&quot;</span><span class="p">,</span>
        <span class="s2">&quot;object_store_memory&quot;</span><span class="p">,</span>
        <span class="s2">&quot;resources&quot;</span><span class="p">,</span>
        <span class="s2">&quot;accelerator_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_calls&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_restarts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_task_retries&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_retries&quot;</span><span class="p">,</span>
        <span class="s2">&quot;runtime_env&quot;</span><span class="p">,</span>
        <span class="s2">&quot;retry_exceptions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;placement_group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;concurrency_groups&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scheduling_strategy&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">error_string</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The @ray.remote decorator must be applied either &quot;</span>
                    <span class="s2">&quot;with no arguments and no parentheses, for example &quot;</span>
                    <span class="s2">&quot;&#39;@ray.remote&#39;, or it must be applied using some of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;the arguments in the list </span><span class="si">{</span><span class="n">valid_kwargs</span><span class="si">}</span><span class="s2">, for example &quot;</span>
                    <span class="s2">&quot;&#39;@ray.remote(num_returns=2, &quot;</span>
                    <span class="s2">&quot;resources={</span><span class="se">\&quot;</span><span class="s2">CustomResource</span><span class="se">\&quot;</span><span class="s2">: 1})&#39;.&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error_string</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">valid_kwargs</span><span class="p">,</span> <span class="n">error_string</span>

    <span class="n">num_cpus</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;num_cpus&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;num_cpus&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">num_gpus</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;num_gpus&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;num_gpus&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;resources&#39; keyword argument must be a &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;dictionary, but received type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="s2">&quot;CPU&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">,</span> <span class="s2">&quot;Use the &#39;num_cpus&#39; argument.&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;GPU&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">,</span> <span class="s2">&quot;Use the &#39;num_gpus&#39; argument.&quot;</span>

    <span class="n">accelerator_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;accelerator_type&quot;</span><span class="p">)</span>

    <span class="c1"># Handle other arguments.</span>
    <span class="n">num_returns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_returns&quot;</span><span class="p">)</span>
    <span class="n">max_calls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_calls&quot;</span><span class="p">)</span>
    <span class="n">max_restarts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_restarts&quot;</span><span class="p">)</span>
    <span class="n">max_task_retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_task_retries&quot;</span><span class="p">)</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
    <span class="n">object_store_memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;object_store_memory&quot;</span><span class="p">)</span>
    <span class="n">max_retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries&quot;</span><span class="p">)</span>
    <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;runtime_env&quot;</span><span class="p">)</span>
    <span class="n">placement_group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;placement_group&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
    <span class="n">retry_exceptions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retry_exceptions&quot;</span><span class="p">)</span>
    <span class="n">concurrency_groups</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concurrency_groups&quot;</span><span class="p">)</span>
    <span class="n">scheduling_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scheduling_strategy&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_decorator</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="n">num_returns</span><span class="p">,</span>
                          <span class="n">num_cpus</span><span class="o">=</span><span class="n">num_cpus</span><span class="p">,</span>
                          <span class="n">num_gpus</span><span class="o">=</span><span class="n">num_gpus</span><span class="p">,</span>
                          <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                          <span class="n">object_store_memory</span><span class="o">=</span><span class="n">object_store_memory</span><span class="p">,</span>
                          <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span>
                          <span class="n">accelerator_type</span><span class="o">=</span><span class="n">accelerator_type</span><span class="p">,</span>
                          <span class="n">max_calls</span><span class="o">=</span><span class="n">max_calls</span><span class="p">,</span>
                          <span class="n">max_restarts</span><span class="o">=</span><span class="n">max_restarts</span><span class="p">,</span>
                          <span class="n">max_task_retries</span><span class="o">=</span><span class="n">max_task_retries</span><span class="p">,</span>
                          <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
                          <span class="n">runtime_env</span><span class="o">=</span><span class="n">runtime_env</span><span class="p">,</span>
                          <span class="n">placement_group</span><span class="o">=</span><span class="n">placement_group</span><span class="p">,</span>
                          <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                          <span class="n">retry_exceptions</span><span class="o">=</span><span class="n">retry_exceptions</span><span class="p">,</span>
                          <span class="n">concurrency_groups</span><span class="o">=</span><span class="n">concurrency_groups</span> <span class="ow">or</span> <span class="p">[],</span>
                          <span class="n">scheduling_strategy</span><span class="o">=</span><span class="n">scheduling_strategy</span><span class="p">)</span></div>
</pre></div>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By the Sky authors<br/>
    
        &copy; Copyright 2022, Sky Team.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>