
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sky.cli &#8212; Sky 0.1 documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=84ace793992934648b4de8eed757e5a2" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.9d8b4a8b9bb19db25eeaddc40d639ba2.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<div class="col-12 col-md-3 bd-sidebar site-navigation " id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Sky 0.1 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../getting-started/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../getting-started/quickstart.html">
   Quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../getting-started/tutorial.html">
   Tutorial: DNN Training
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Use Cases
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../examples/auto-failover.html">
   Auto-failover Provisioning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../examples/iterative-dev-project.html">
   Iteratively Developing a Project
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../examples/launch-many-tasks-vm.html">
   Launch Multiple Tasks on a VM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../examples/grid-search.html">
   Grid Search
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../examples/distributed-jobs.html">
   Distributed Jobs on many VMs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/concretevitamin/sky-experiments/tree/master/prototype/examples">
   Additional Examples
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/interactive-nodes.html">
   Interactive Nodes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/iterative-development.html">
   Iterative Development
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/storage.html">
   Storage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/job-queue.html">
   Job Queue
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/cli.html">
   CLI Reference
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<!-- This is an invisible pixel that we watch to see if we've scrolled. -->
<div class="sbt-scroll-pixel-helper"></div>
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            <div class="topbar-left">
                
                <label class="nav-toggle-button" for="__navigation">
                    <div class="visually-hidden">Toggle navigation</div>
                    <i class="fas fa-bars"></i>
                </label>
                
            </div>
            
            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            
              <div>
                
  <h1>Source code for sky.cli</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The &#39;sky&#39; command line tool.</span>

<span class="sd">Example usage:</span>

<span class="sd">  # See available commands.</span>
<span class="sd">  &gt;&gt; sky</span>

<span class="sd">  # Run a task, described in a yaml file.</span>
<span class="sd">  # Provisioning, setup, file syncing are handled.</span>
<span class="sd">  &gt;&gt; sky launch task.yaml</span>
<span class="sd">  &gt;&gt; sky launch [-c cluster_name] task.yaml</span>

<span class="sd">  # Show the list of running clusters.</span>
<span class="sd">  &gt;&gt; sky status</span>

<span class="sd">  # Tear down a specific cluster.</span>
<span class="sd">  &gt;&gt; sky down cluster_name</span>

<span class="sd">  # Tear down all existing clusters.</span>
<span class="sd">  &gt;&gt; sky down -a</span>

<span class="sd">TODO:</span>
<span class="sd">- Add support for local Docker backend.  Currently this module is very coupled</span>
<span class="sd">  with CloudVmRayBackend, as seen by the many use of ray commands.</span>

<span class="sd">NOTE: the order of command definitions in this file corresponds to how they are</span>
<span class="sd">listed in &quot;sky --help&quot;.  Take care to put logically connected commands close to</span>
<span class="sd">each other.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">pendulum</span>

<span class="kn">import</span> <span class="nn">sky</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">backends</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">global_user_state</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">init</span> <span class="k">as</span> <span class="n">sky_init</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">sky_logging</span>
<span class="kn">from</span> <span class="nn">sky</span> <span class="kn">import</span> <span class="n">clouds</span>
<span class="kn">from</span> <span class="nn">sky.backends</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">backend_lib</span>
<span class="kn">from</span> <span class="nn">sky.backends</span> <span class="kn">import</span> <span class="n">backend_utils</span>
<span class="kn">from</span> <span class="nn">sky.backends</span> <span class="kn">import</span> <span class="n">cloud_vm_ray_backend</span>
<span class="kn">from</span> <span class="nn">sky.clouds</span> <span class="kn">import</span> <span class="n">service_catalog</span>
<span class="kn">from</span> <span class="nn">sky.skylet</span> <span class="kn">import</span> <span class="n">util_lib</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">sky_logging</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">_CLUSTER_FLAG_HELP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">A cluster name. If provided, either reuse an existing cluster with that name or</span>
<span class="s2">provision a new cluster with that name. Otherwise provision a new cluster with</span>
<span class="s2">an autogenerated name.&quot;&quot;&quot;</span>
<span class="n">_INTERACTIVE_NODE_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;cpunode&#39;</span><span class="p">,</span> <span class="s1">&#39;gpunode&#39;</span><span class="p">,</span> <span class="s1">&#39;tpunode&#39;</span><span class="p">)</span>
<span class="n">_INTERACTIVE_NODE_DEFAULT_RESOURCES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;cpunode&#39;</span><span class="p">:</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">accelerators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">use_spot</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="s1">&#39;gpunode&#39;</span><span class="p">:</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">accelerators</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;K80&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                             <span class="n">use_spot</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="s1">&#39;tpunode&#39;</span><span class="p">:</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="n">sky</span><span class="o">.</span><span class="n">GCP</span><span class="p">(),</span>
                             <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">accelerators</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tpu-v3-8&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                             <span class="n">accelerator_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tf_version&#39;</span><span class="p">:</span> <span class="s1">&#39;2.5.0&#39;</span><span class="p">},</span>
                             <span class="n">use_spot</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_truncate_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="n">max_length</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span>  <span class="c1"># Use &#39;…&#39;?</span>
    <span class="c1"># Truncate on word boundary.</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;=</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splits</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span>


<span class="k">def</span> <span class="nf">_parse_accelerator_options</span><span class="p">(</span><span class="n">accelerator_options</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Parses accelerator options: e.g., V100:8 into {&#39;V100&#39;: 8}.&quot;&quot;&quot;</span>
    <span class="n">accelerators</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">accelerator_options</span> <span class="o">=</span> <span class="n">accelerator_options</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accelerator_options</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">accelerator_type</span> <span class="o">=</span> <span class="n">accelerator_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">accelerators</span><span class="p">[</span><span class="n">accelerator_type</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">accelerator_options</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">accelerator_type</span> <span class="o">=</span> <span class="n">accelerator_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">accelerator_count</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">accelerator_options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">accelerators</span><span class="p">[</span><span class="n">accelerator_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">accelerator_count</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid accelerator option: </span><span class="si">{</span><span class="n">accelerator_options</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accelerators</span>


<span class="k">def</span> <span class="nf">_interactive_node_cli_command</span><span class="p">(</span><span class="n">cli_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Click command decorator for interactive node commands.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">cli_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">_INTERACTIVE_NODE_TYPES</span><span class="p">,</span> <span class="n">cli_func</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">cluster_option</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--cluster&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;-c&#39;</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                                  <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="n">_CLUSTER_FLAG_HELP</span><span class="p">)</span>
    <span class="n">port_forward_option</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
        <span class="s1">&#39;--port-forward&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-p&#39;</span><span class="p">,</span>
        <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Port to be forwarded. To forward multiple ports, &#39;</span>
              <span class="s1">&#39;use this option multiple times.&#39;</span><span class="p">))</span>
    <span class="n">screen_option</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--screen&#39;</span><span class="p">,</span>
                                 <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If true, attach using screen.&#39;</span><span class="p">)</span>
    <span class="n">tmux_option</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--tmux&#39;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If true, attach using tmux.&#39;</span><span class="p">)</span>
    <span class="n">cloud_option</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--cloud&#39;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cloud provider to use.&#39;</span><span class="p">)</span>
    <span class="n">instance_type_option</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--instance-type&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;-t&#39;</span><span class="p">,</span>
                                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Instance type to use.&#39;</span><span class="p">)</span>
    <span class="n">gpus</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--gpus&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Type and number of GPUs to use &#39;</span>
                              <span class="s1">&#39;(e.g., --gpus=V100:8 or --gpus=V100).&#39;</span><span class="p">))</span>
    <span class="n">tpus</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
        <span class="s1">&#39;--tpus&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Type and number of TPUs to use (e.g., --tpus=tpu-v3-8:4 or &#39;</span>
              <span class="s1">&#39;--tpus=tpu-v3-8).&#39;</span><span class="p">))</span>

    <span class="n">spot_option</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--spot&#39;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If true, use spot instances.&#39;</span><span class="p">)</span>

    <span class="n">click_decorators</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(),</span>
        <span class="n">cluster_option</span><span class="p">,</span>
        <span class="n">port_forward_option</span><span class="p">,</span>

        <span class="c1"># Resource options</span>
        <span class="o">*</span><span class="p">([</span><span class="n">cloud_option</span><span class="p">]</span> <span class="k">if</span> <span class="n">cli_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;tpunode&#39;</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="n">instance_type_option</span><span class="p">,</span>
        <span class="o">*</span><span class="p">([</span><span class="n">gpus</span><span class="p">]</span> <span class="k">if</span> <span class="n">cli_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;gpunode&#39;</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="o">*</span><span class="p">([</span><span class="n">tpus</span><span class="p">]</span> <span class="k">if</span> <span class="n">cli_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;tpunode&#39;</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="n">spot_option</span><span class="p">,</span>

        <span class="c1"># Attach options</span>
        <span class="n">screen_option</span><span class="p">,</span>
        <span class="n">tmux_option</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">decorator</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">res</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
                                 <span class="nb">reversed</span><span class="p">(</span><span class="n">click_decorators</span><span class="p">),</span> <span class="n">cli_func</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span> <span class="nf">_default_interactive_node_name</span><span class="p">(</span><span class="n">node_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a deterministic name to refer to the same node.&quot;&quot;&quot;</span>
    <span class="c1"># FIXME: this technically can collide in Azure/GCP with another</span>
    <span class="c1"># same-username user.  E.g., sky-gpunode-ubuntu.  Not a problem on AWS</span>
    <span class="c1"># which is the current cloud for interactive nodes.</span>
    <span class="k">assert</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">_INTERACTIVE_NODE_TYPES</span><span class="p">,</span> <span class="n">node_type</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;sky-</span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">def</span> <span class="nf">_infer_interactive_node_type</span><span class="p">(</span><span class="n">resources</span><span class="p">:</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine interactive node type from resources.&quot;&quot;&quot;</span>
    <span class="n">accelerators</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get_accelerators</span><span class="p">()</span>
    <span class="n">cloud</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">cloud</span>
    <span class="k">if</span> <span class="n">accelerators</span><span class="p">:</span>
        <span class="c1"># We only support homogenous accelerators for now.</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accelerators</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">resources</span>
        <span class="n">acc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">accelerators</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">is_gcp</span> <span class="o">=</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cloud</span><span class="o">.</span><span class="n">is_same_cloud</span><span class="p">(</span><span class="n">sky</span><span class="o">.</span><span class="n">GCP</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">is_gcp</span> <span class="ow">and</span> <span class="s1">&#39;tpu&#39;</span> <span class="ow">in</span> <span class="n">acc</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;tpunode&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;gpunode&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;cpunode&#39;</span>


<span class="k">def</span> <span class="nf">_check_interactive_node_resources_match</span><span class="p">(</span>
        <span class="n">node_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">resources</span><span class="p">:</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">,</span>
        <span class="n">launched_resources</span><span class="p">:</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">,</span>
        <span class="n">user_requested_resources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check matching resources when reusing an existing cluster.</span>

<span class="sd">    The only exception is when [cpu|tpu|gpu]node -c cluster_name is used with no</span>
<span class="sd">    additional arguments, then login succeeds.</span>

<span class="sd">    Args:</span>
<span class="sd">        node_type: Type of interactive node.</span>
<span class="sd">        resources: Resources to attach to VM.</span>
<span class="sd">        launched_resources: Existing launched resources associated with cluster.</span>
<span class="sd">        user_requested_resources: If true, user requested resources explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># In the case where the user specifies no cloud, we infer the cloud from</span>
    <span class="c1"># the launched resources before performing the check.</span>
    <span class="c1"># e.g. user launches sky gpunode --gpus V100 creates an AWS(p3.2xlarge)</span>
    <span class="c1"># but when the resource check will fail because is_same_resources expects</span>
    <span class="c1"># resources.cloud and handle.launched_resources to match.</span>
    <span class="k">if</span> <span class="n">resources</span><span class="o">.</span><span class="n">cloud</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">launched_resources</span><span class="o">.</span><span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">launched_resources</span>
        <span class="n">resources</span><span class="o">.</span><span class="n">cloud</span> <span class="o">=</span> <span class="n">launched_resources</span><span class="o">.</span><span class="n">cloud</span>

    <span class="c1"># TODO: Check for same number of launched_nodes if multi-node support is</span>
    <span class="c1"># added for gpu/cpu/tpunode.</span>
    <span class="n">inferred_node_type</span> <span class="o">=</span> <span class="n">_infer_interactive_node_type</span><span class="p">(</span><span class="n">launched_resources</span><span class="p">)</span>
    <span class="n">node_type_match</span> <span class="o">=</span> <span class="n">inferred_node_type</span> <span class="o">==</span> <span class="n">node_type</span>
    <span class="n">launched_resources_match</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">is_same_resources</span><span class="p">(</span><span class="n">launched_resources</span><span class="p">)</span>
    <span class="n">no_resource_requests</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">user_requested_resources</span>  <span class="c1"># e.g. sky gpunode</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node_type_match</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">no_resource_requests</span> <span class="ow">or</span> <span class="n">launched_resources_match</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
            <span class="s1">&#39;Resources cannot change for an existing cluster.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Existing: </span><span class="si">{</span><span class="n">inferred_node_type</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">launched_resources</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Requested: </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">resources</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="c1"># TODO: skip installing ray to speed up provisioning.</span>
<span class="k">def</span> <span class="nf">_create_and_ssh_into_node</span><span class="p">(</span>
    <span class="n">node_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resources</span><span class="p">:</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">,</span>
    <span class="n">cluster_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">backend_lib</span><span class="o">.</span><span class="n">Backend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">port_forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">session_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">user_requested_resources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates and attaches to an interactive node.</span>

<span class="sd">    Args:</span>
<span class="sd">        node_type: Type of the interactive node: { &#39;cpunode&#39;, &#39;gpunode&#39; }.</span>
<span class="sd">        resources: Resources to attach to VM.</span>
<span class="sd">        cluster_name: a cluster name to identify the interactive node.</span>
<span class="sd">        backend: the Backend to use (currently only CloudVmRayBackend).</span>
<span class="sd">        port_forward: List of ports to forward.</span>
<span class="sd">        session_manager: Attach session manager: { &#39;screen&#39;, &#39;tmux&#39; }.</span>
<span class="sd">        user_requested_resources: If true, user requested resources explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">_INTERACTIVE_NODE_TYPES</span><span class="p">,</span> <span class="n">node_type</span>
    <span class="k">assert</span> <span class="n">session_manager</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="s1">&#39;tmux&#39;</span><span class="p">),</span> <span class="n">session_manager</span>
    <span class="k">with</span> <span class="n">sky</span><span class="o">.</span><span class="n">Dag</span><span class="p">()</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
        <span class="c1"># TODO: Add conda environment replication</span>
        <span class="c1"># should be setup =</span>
        <span class="c1"># &#39;conda env export | grep -v &quot;^prefix: &quot; &gt; environment.yml&#39;</span>
        <span class="c1"># &amp;&amp; conda env create -f environment.yml</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
            <span class="n">node_type</span><span class="p">,</span>
            <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">setup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">run</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">set_resources</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">update_file_mounts</span><span class="p">(</span><span class="n">sky_init</span><span class="o">.</span><span class="n">get_cloud_credential_file_mounts</span><span class="p">())</span>

    <span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span> <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">backends</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="p">()</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Avoid reusing clusters with requested resource mismatches.</span>
        <span class="n">_check_interactive_node_resources_match</span><span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span>
                                                <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="p">,</span>
                                                <span class="n">user_requested_resources</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">handle</span><span class="o">.</span><span class="n">head_ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># head_ip would be None if previous provisioning failed.</span>

        <span class="c1"># This handles stopped interactive nodes where they are restarted by</span>
        <span class="c1"># skipping sky start and directly calling sky [cpu|tpu|gpu]node.</span>
        <span class="n">cluster_status</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_status_from_cluster_name</span><span class="p">(</span>
            <span class="n">cluster_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_status</span> <span class="o">==</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">ClusterStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">handle</span>
            <span class="n">to_provision</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_resources</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dag</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">dag</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">backend</span><span class="o">.</span><span class="n">register_info</span><span class="p">(</span><span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">)</span>
            <span class="n">to_provision</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">best_resources</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">provision</span><span class="p">(</span><span class="n">task</span><span class="p">,</span>
                                   <span class="n">to_provision</span><span class="o">=</span><span class="n">to_provision</span><span class="p">,</span>
                                   <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">stream_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">cluster_name</span><span class="o">=</span><span class="n">cluster_name</span><span class="p">)</span>

    <span class="c1"># Use ssh rather than &#39;ray attach&#39; to suppress ray messages, speed up</span>
    <span class="c1"># connection, and for allowing adding &#39;cd workdir&#39; in the future.</span>
    <span class="c1"># Disable check, since the returncode could be non-zero if the user Ctrl-D.</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">session_manager</span> <span class="o">==</span> <span class="s1">&#39;screen&#39;</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="s1">&#39;-R&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">session_manager</span> <span class="o">==</span> <span class="s1">&#39;tmux&#39;</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;attach&#39;</span><span class="p">,</span> <span class="s1">&#39;||&#39;</span><span class="p">,</span> <span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">]</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                                   <span class="n">commands</span><span class="p">,</span>
                                   <span class="n">port_forward</span><span class="o">=</span><span class="n">port_forward</span><span class="p">,</span>
                                   <span class="n">ssh_mode</span><span class="o">=</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">SshMode</span><span class="o">.</span><span class="n">LOGIN</span><span class="p">)</span>
    <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_cluster_name_from_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;To attach to it again:  &#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cluster_name</span> <span class="o">==</span> <span class="n">_default_interactive_node_name</span><span class="p">(</span><span class="n">node_type</span><span class="p">):</span>
        <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">option</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; -c </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sky </span><span class="si">{</span><span class="n">node_type</span><span class="si">}{</span><span class="n">option</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;To stop the node:</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sky stop </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;To tear down the node:</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sky down </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;To upload a folder:</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rsync -rP /local/path </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">:/remote/path&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;To download a folder:</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rsync -rP </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">:/remote/path /local/path&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_yaml</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Checks if entrypoint is a readable YAML file.&quot;&quot;&quot;</span>
    <span class="n">is_yaml</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># &#39;sky exec cluster ./my_script.sh&#39;</span>
                    <span class="n">is_yaml</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span><span class="p">:</span>
                <span class="n">is_yaml</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">is_yaml</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_yaml</span><span class="p">:</span>
        <span class="n">shell_splits</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shell_splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">shell_splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">)</span> <span class="ow">or</span>
                                       <span class="n">shell_splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yml&#39;</span><span class="p">)):</span>
            <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">entrypoint</span><span class="si">!r}</span><span class="s1"> looks like a yaml path but yaml.safe_load() &#39;</span>
                <span class="s1">&#39;failed to return a dict (check if it exists or it</span><span class="se">\&#39;</span><span class="s1">s valid).</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;It will be treated as a command to be run remotely. Continue?&#39;</span><span class="p">,</span>
                <span class="n">abort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">is_yaml</span>


<span class="k">class</span> <span class="nc">_NaturalOrderGroup</span><span class="p">(</span><span class="n">click</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lists commands in the order they are defined in this script.</span>

<span class="sd">    Reference: https://github.com/pallets/click/issues/513</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">list_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">_NaturalOrderGroup</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;entrypoint&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--cluster&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-c&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="n">_CLUSTER_FLAG_HELP</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--dryrun&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If True, do not actually run the job.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--detach-run&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-d&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If True, run setup first (blocking), &#39;</span>
              <span class="s1">&#39;then detach from the job</span><span class="se">\&#39;</span><span class="s1">s execution.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--docker&#39;</span><span class="p">,</span>
              <span class="s1">&#39;backend_name&#39;</span><span class="p">,</span>
              <span class="n">flag_value</span><span class="o">=</span><span class="n">backends</span><span class="o">.</span><span class="n">LocalDockerBackend</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If used, runs locally inside a docker container.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--workdir&#39;</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;If specified, sync this dir to the remote working directory, &#39;</span>
          <span class="s1">&#39;where the task will be invoked. &#39;</span>
          <span class="s1">&#39;Overrides the &quot;workdir&quot; config in the YAML if both are supplied.&#39;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--cloud&#39;</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The cloud to use. If specified, override the &quot;resources.cloud&quot;.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--gpus&#39;</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Type and number of GPUs to use. Example values: &#39;</span>
          <span class="s1">&#39;&quot;V100:8&quot;, &quot;V100&quot; (short for a count of 1), or &quot;V100:0.5&quot; &#39;</span>
          <span class="s1">&#39;(fractional counts are supported by the scheduling framework). &#39;</span>
          <span class="s1">&#39;If a new cluster is being launched by this command, this is the &#39;</span>
          <span class="s1">&#39;resources to provision. If an existing cluster is being reused, this&#39;</span>
          <span class="s1">&#39; is seen as the task demand, which must fit the cluster</span><span class="se">\&#39;</span><span class="s1">s total &#39;</span>
          <span class="s1">&#39;resources and is used for scheduling the task. &#39;</span>
          <span class="s1">&#39;Overrides the &quot;accelerators&quot; &#39;</span>
          <span class="s1">&#39;config in the YAML if both are supplied.&#39;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--use-spot/--no-use-spot&#39;</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Whether to request spot instances. If specified, override the &#39;</span>
          <span class="s1">&#39;&quot;resources.use_spot&quot;.&#39;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-n&#39;</span><span class="p">,</span>
              <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Task name. Overrides the &quot;name&quot; &#39;</span>
                    <span class="s1">&#39;config in the YAML if both are supplied.&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">dryrun</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
           <span class="n">detach_run</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">backend_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">workdir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
           <span class="n">cloud</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">gpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_spot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
           <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Launch a task from a YAML or command (rerun setup if cluster exists).</span>

<span class="sd">    If entrypoint points to a valid YAML file, it is read in as the task</span>
<span class="sd">    specification. Otherwise, it is interpreted as a bash command to be</span>
<span class="sd">    executed on the head node of the cluster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">backend_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">backend_name</span> <span class="o">=</span> <span class="n">backends</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="o">.</span><span class="n">NAME</span>
    <span class="n">entrypoint</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sky</span><span class="o">.</span><span class="n">Dag</span><span class="p">()</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_check_yaml</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">):</span>
            <span class="c1"># Treat entrypoint as a yaml.</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Task from YAML spec: &#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Task</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Treat entrypoint as a bash command.</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Task from command: &#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sky-cmd&#39;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_resources</span><span class="p">({</span><span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">()})</span>
        <span class="c1"># Override.</span>
        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">new_resources</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cloud</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Cloud </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">cloud</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> is not supported. &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Supported clouds: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">new_resources</span><span class="o">.</span><span class="n">cloud</span> <span class="o">=</span> <span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="p">[</span><span class="n">cloud</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">gpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_resources</span><span class="o">.</span><span class="n">accelerators</span> <span class="o">=</span> <span class="n">_parse_accelerator_options</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_spot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_resources</span><span class="o">.</span><span class="n">use_spot</span> <span class="o">=</span> <span class="n">use_spot</span>
        <span class="n">task</span><span class="o">.</span><span class="n">set_resources</span><span class="p">({</span><span class="n">new_resources</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">if</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running task on cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">backend_name</span> <span class="o">==</span> <span class="n">backends</span><span class="o">.</span><span class="n">LocalDockerBackend</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">backends</span><span class="o">.</span><span class="n">LocalDockerBackend</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">backend_name</span> <span class="o">==</span> <span class="n">backends</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">backends</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">backend_name</span><span class="si">}</span><span class="s1"> backend is not supported.&#39;</span><span class="p">)</span>

    <span class="n">sky</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span>
               <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">,</span>
               <span class="n">stream_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">cluster_name</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
               <span class="n">detach_run</span><span class="o">=</span><span class="n">detach_run</span><span class="p">,</span>
               <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;entrypoint&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--detach-run&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-d&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If True, run setup first (blocking), &#39;</span>
              <span class="s1">&#39;then detach from the job</span><span class="se">\&#39;</span><span class="s1">s execution.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--workdir&#39;</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;If specified, sync this dir to the remote working directory, &#39;</span>
          <span class="s1">&#39;where the task will be invoked. &#39;</span>
          <span class="s1">&#39;Overrides the &quot;workdir&quot; config in the YAML if both are supplied.&#39;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--gpus&#39;</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Task demands: Type and number of GPUs to use. Example values: &#39;</span>
          <span class="s1">&#39;&quot;V100:8&quot;, &quot;V100&quot; (short for a count of 1), or &quot;V100:0.5&quot; &#39;</span>
          <span class="s1">&#39;(fractional counts are supported by the scheduling framework). &#39;</span>
          <span class="s1">&#39;This is used for scheduling the task, so it must fit the &#39;</span>
          <span class="s1">&#39;cluster</span><span class="se">\&#39;</span><span class="s1">s total resources. Overrides the &quot;accelerators&quot; &#39;</span>
          <span class="s1">&#39;config in the YAML if both are supplied.&#39;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-n&#39;</span><span class="p">,</span>
              <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Task name. Overrides the &quot;name&quot; &#39;</span>
                    <span class="s1">&#39;config in the YAML if both are supplied.&#39;</span><span class="p">))</span>
<span class="c1"># pylint: disable=redefined-builtin</span>
<span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">detach_run</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
         <span class="n">workdir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">gpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Execute a task or a command on a cluster (skip setup).</span>

<span class="sd">    If entrypoint points to a valid YAML file, it is read in as the task</span>
<span class="sd">    specification. Otherwise, it is interpreted as a bash command to be</span>
<span class="sd">    executed on the head node of the cluster. The task will be submitted to</span>
<span class="sd">    the job queue of the cluster, except if the bash command is used without</span>
<span class="sd">    providing --gpus.</span>

<span class="sd">    \b</span>
<span class="sd">    Actions performed by this command only include:</span>
<span class="sd">    - workdir syncing (optional; specified in the YAML spec or via --workdir)</span>
<span class="sd">    - executing the task&#39;s run command (if entrypoint is a yaml; executed</span>
<span class="sd">      either on the cluster&#39;s head node or optionally on all nodes), or a</span>
<span class="sd">      bash command (only executed on the head node)</span>

<span class="sd">    `sky exec` is thus typically faster than `sky launch`, provided a cluster</span>
<span class="sd">    already exists.</span>

<span class="sd">    All setup steps (provisioning, setup commands, file mounts syncing) are</span>
<span class="sd">    skipped.  If any of those specifications changed, this command will not</span>
<span class="sd">    reflect those changes.  To ensure a cluster&#39;s setup is up to date, use `sky</span>
<span class="sd">    launch` instead.</span>

<span class="sd">    Typical workflow:</span>

<span class="sd">      # First command: set up the cluster once.</span>

<span class="sd">      &gt;&gt; sky launch -c mycluster app.yaml</span>

<span class="sd">    \b</span>
<span class="sd">      # Starting iterative development...</span>
<span class="sd">      # For example, modify local workdir code.</span>
<span class="sd">      # Future commands: simply execute the task on the launched cluster.</span>

<span class="sd">      &gt;&gt; sky exec mycluster app.yaml</span>

<span class="sd">      # Do &quot;sky launch&quot; again if anything other than Task.run is modified:</span>

<span class="sd">      &gt;&gt; sky launch -c mycluster app.yaml</span>

<span class="sd">    Advanced use cases:</span>

<span class="sd">      #  Pass in commands for execution</span>

<span class="sd">      &gt;&gt; sky exec mycluster -- echo Hello World</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entrypoint</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> not found.  &#39;</span>
                                 <span class="s1">&#39;Use `sky launch` to provision first.&#39;</span><span class="p">)</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">get_backend_from_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">sky</span><span class="o">.</span><span class="n">Dag</span><span class="p">()</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_check_yaml</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">):</span>
            <span class="c1"># Treat entrypoint as a yaml file</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Task from YAML spec: &#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Task</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Treat entrypoint as a bash command.</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Task from command: &#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sky-cmd&#39;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_resources</span><span class="p">({</span><span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">()})</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">backends</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="p">):</span>
                <span class="c1"># Run inline commands directly on head node if the resources are</span>
                <span class="c1"># not set. User should take the responsibility to not overload</span>
                <span class="c1"># the cluster.</span>
                <span class="k">if</span> <span class="n">gpus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">backend</span><span class="o">.</span><span class="n">sync_workdir</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                    <span class="n">backend</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span>
                        <span class="n">handle</span><span class="p">,</span>
                        <span class="n">entrypoint</span><span class="p">,</span>
                        <span class="n">stream_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">ssh_mode</span><span class="o">=</span><span class="n">backend_utils</span><span class="o">.</span><span class="n">SshMode</span><span class="o">.</span><span class="n">INTERACTIVE</span><span class="p">,</span>
                        <span class="n">under_remote_workdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span>

        <span class="c1"># Override.</span>
        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span>
        <span class="k">if</span> <span class="n">gpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">copied</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">resources</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">copied</span><span class="o">.</span><span class="n">accelerators</span> <span class="o">=</span> <span class="n">_parse_accelerator_options</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_resources</span><span class="p">({</span><span class="n">copied</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Executing task on cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
    <span class="n">sky</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">cluster_name</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> <span class="n">detach_run</span><span class="o">=</span><span class="n">detach_run</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_readable_time_duration</span><span class="p">(</span><span class="n">start_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">diff_for_humans</span><span class="p">()</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">diff</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show all information in full.&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="nb">all</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
    <span class="sd">&quot;&quot;&quot;Show launched clusters.&quot;&quot;&quot;</span>
    <span class="n">show_all</span> <span class="o">=</span> <span class="nb">all</span>
    <span class="n">clusters_status</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_clusters</span><span class="p">()</span>
    <span class="n">cluster_table</span> <span class="o">=</span> <span class="n">util_lib</span><span class="o">.</span><span class="n">create_table</span><span class="p">([</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LAUNCHED&#39;</span><span class="p">,</span>
        <span class="s1">&#39;RESOURCES&#39;</span><span class="p">,</span>
        <span class="s1">&#39;COMMAND&#39;</span><span class="p">,</span>
        <span class="s1">&#39;STATUS&#39;</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="k">for</span> <span class="n">cluster_status</span> <span class="ow">in</span> <span class="n">clusters_status</span><span class="p">:</span>
        <span class="n">launched_at</span> <span class="o">=</span> <span class="n">cluster_status</span><span class="p">[</span><span class="s1">&#39;launched_at&#39;</span><span class="p">]</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">cluster_status</span><span class="p">[</span><span class="s1">&#39;handle&#39;</span><span class="p">]</span>
        <span class="n">resources_str</span> <span class="o">=</span> <span class="s1">&#39;&lt;initializing&gt;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">backends</span><span class="o">.</span><span class="n">LocalDockerBackend</span><span class="o">.</span><span class="n">ResourceHandle</span><span class="p">):</span>
            <span class="n">resources_str</span> <span class="o">=</span> <span class="s1">&#39;docker&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">backends</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="o">.</span><span class="n">ResourceHandle</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">launched_resource_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">show_all</span><span class="p">:</span>
                    <span class="n">launched_resource_str</span> <span class="o">=</span> <span class="n">_truncate_long_string</span><span class="p">(</span>
                        <span class="n">launched_resource_str</span><span class="p">)</span>
                <span class="n">resources_str</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span><span class="si">}</span><span class="s1">x &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">launched_resource_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown handle type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="si">}</span><span class="s1"> encountered.&#39;</span><span class="p">)</span>
        <span class="n">cluster_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span>
            <span class="c1"># NAME</span>
            <span class="n">cluster_status</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="c1"># LAUNCHED</span>
            <span class="n">_readable_time_duration</span><span class="p">(</span><span class="n">launched_at</span><span class="p">),</span>
            <span class="c1"># RESOURCES</span>
            <span class="n">resources_str</span><span class="p">,</span>
            <span class="c1"># COMMAND</span>
            <span class="n">cluster_status</span><span class="p">[</span><span class="s1">&#39;last_use&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">show_all</span> <span class="k">else</span> <span class="n">_truncate_long_string</span><span class="p">(</span><span class="n">cluster_status</span><span class="p">[</span><span class="s1">&#39;last_use&#39;</span><span class="p">]),</span>
            <span class="c1"># STATUS</span>
            <span class="n">cluster_status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="p">])</span>
    <span class="k">if</span> <span class="n">clusters_status</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">cluster_table</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;No existing clusters.&#39;</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--all-users&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show all users</span><span class="se">\&#39;</span><span class="s1"> information in full.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--skip-finished&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-s&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show only pending/running jobs</span><span class="se">\&#39;</span><span class="s1"> information.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">queue</span><span class="p">(</span><span class="n">clusters</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">skip_finished</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">all_users</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the job queue for cluster(s).&quot;&quot;&quot;</span>
    <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Fetching and parsing job queue...&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
    <span class="n">all_jobs</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">skip_finished</span>

    <span class="n">codegen</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">JobLibCodeGen</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">all_users</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">codegen</span><span class="o">.</span><span class="n">show_jobs</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">all_jobs</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cluster_infos</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_clusters</span><span class="p">()</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cluster_infos</span><span class="p">]</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;handle&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cluster_infos</span><span class="p">]</span>

    <span class="n">unsupported_clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">handle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">handles</span><span class="p">):</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">get_backend_from_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">backends</span><span class="o">.</span><span class="n">LocalDockerBackend</span><span class="p">):</span>
            <span class="c1"># LocalDockerBackend does not support job queues</span>
            <span class="n">unsupported_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">_show_job_queue_on_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">unsupported_clusters</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Note: Job queues are not supported on clusters: &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unsupported_clusters</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_show_job_queue_on_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
                               <span class="n">backend</span><span class="p">:</span> <span class="n">backend_lib</span><span class="o">.</span><span class="n">Backend</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1"> was not found. Skipping.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Sky Job Queue of Cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">head_ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1"> has been stopped or not properly set up. &#39;</span>
            <span class="s1">&#39;Please re-launch it with `sky launch` to view the job queue.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">job_table</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">code</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job_table</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--sync-down&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-s&#39;</span><span class="p">,</span>
    <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Sync down the logs of the job (This is useful for distributed jobs to&#39;</span>
    <span class="s1">&#39;download separate log for each job from all the workers).&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logs</span><span class="p">(</span><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sync_down</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tail the log of a job.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Add an option for downloading logs.</span>
    <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> not found&#39;</span>
                                 <span class="s1">&#39; (see `sky status`).&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">backends</span><span class="o">.</span><span class="n">LocalDockerBackend</span><span class="o">.</span><span class="n">ResourceHandle</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Sky logs is not available with &#39;</span>
                               <span class="s1">&#39;LocalDockerBackend.&#39;</span><span class="p">)</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">get_backend_from_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sync_down</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Syncing down logs to local...&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">sync_down_logs</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">tail_logs</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cancel all jobs.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">all</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
    <span class="sd">&quot;&quot;&quot;Cancel job(s).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
            <span class="s1">&#39;sky cancel requires either a job id &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;(see `sky queue </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1"> -s`) or the --all flag.&#39;</span><span class="p">)</span>

    <span class="n">handle</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> not found&#39;</span>
                                 <span class="s1">&#39; (see `sky status`).&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cancelling all jobs on cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jobs_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">jobs</span><span class="p">))</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cancelling jobs (</span><span class="si">{</span><span class="n">jobs_str</span><span class="si">}</span><span class="s1">) on cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span>
                    <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="n">codegen</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">JobLibCodeGen</span><span class="p">()</span>
    <span class="n">codegen</span><span class="o">.</span><span class="n">cancel_jobs</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

    <span class="c1"># FIXME: Assumes a specific backend.</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">backends</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="p">()</span>
    <span class="n">backend</span><span class="o">.</span><span class="n">run_on_head</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">stream_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Tear down all existing clusters.&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stop</span><span class="p">(</span>
        <span class="n">clusters</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="nb">all</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stop cluster(s).</span>

<span class="sd">    CLUSTER is the name of the cluster to stop.  If both CLUSTER and --all are</span>
<span class="sd">    supplied, the latter takes precedence.</span>

<span class="sd">    Limitation: this currently only works for AWS/GCP non-spot clusters.</span>

<span class="sd">    Examples:</span>

<span class="sd">      \b</span>
<span class="sd">      # Stop a specific cluster.</span>
<span class="sd">      sky stop cluster_name</span>

<span class="sd">      \b</span>
<span class="sd">      # Stop multiple clusters.</span>
<span class="sd">      sky stop cluster1 cluster2</span>

<span class="sd">      \b</span>
<span class="sd">      # Stop all existing clusters.</span>
<span class="sd">      sky stop -a</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_terminate_or_stop_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">apply_to_all</span><span class="o">=</span><span class="nb">all</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">clusters</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Restart cluster(s).</span>

<span class="sd">    If a cluster is previously stopped (status == STOPPED) or failed in</span>
<span class="sd">    provisioning/a task&#39;s setup (status == INIT), this command will attempt to</span>
<span class="sd">    start the cluster.  (In the second case, any failed setup steps are not</span>
<span class="sd">    performed and only a request to start the machines is attempted.)</span>

<span class="sd">    If a cluster is already in an UP status, this command has no effect on it.</span>

<span class="sd">    Examples:</span>

<span class="sd">      \b</span>
<span class="sd">      # Restart a specific cluster.</span>
<span class="sd">      sky start cluster_name</span>

<span class="sd">      \b</span>
<span class="sd">      # Restart multiple clusters.</span>
<span class="sd">      sky start cluster1 cluster2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">to_start</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">clusters</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">all_clusters</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cluster_record</span> <span class="ow">in</span> <span class="n">all_clusters</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">cluster_record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">cluster_record</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">all_clusters</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_clusters</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">_filter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">all_clusters</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> was not found.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># A cluster may have one of the following states:</span>
            <span class="c1">#</span>
            <span class="c1">#  STOPPED - ok to restart</span>
            <span class="c1">#    (currently, only AWS/GCP non-spot clusters can be in this</span>
            <span class="c1">#    state)</span>
            <span class="c1">#</span>
            <span class="c1">#  UP - skipped, see below</span>
            <span class="c1">#</span>
            <span class="c1">#  INIT - ok to restart:</span>
            <span class="c1">#    1. It can be a failed-to-provision cluster, so it isn&#39;t up</span>
            <span class="c1">#      (Ex: gpunode --gpus=A100:8).  Running `sky start` enables</span>
            <span class="c1">#      retrying the provisioning - without setup steps being</span>
            <span class="c1">#      completed. (Arguably the original command that failed should</span>
            <span class="c1">#      be used instead; but using start isn&#39;t harmful - after it</span>
            <span class="c1">#      gets provisioned successfully the user can use the original</span>
            <span class="c1">#      command).</span>
            <span class="c1">#</span>
            <span class="c1">#    2. It can be an up cluster that failed one of the setup steps.</span>
            <span class="c1">#      This way &#39;sky start&#39; can change its status to UP, enabling</span>
            <span class="c1">#      &#39;sky ssh&#39; to debug things (otherwise `sky ssh` will fail an</span>
            <span class="c1">#      INIT state cluster due to head_ip not being cached).</span>
            <span class="c1">#</span>
            <span class="c1">#      This can be replicated by adding `exit 1` to Task.setup.</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">ClusterStatus</span><span class="o">.</span><span class="n">UP</span><span class="p">:</span>
                <span class="c1"># An UP cluster; skipping &#39;sky start&#39; because:</span>
                <span class="c1">#  1. For a really up cluster, this has no effects (ray up -y</span>
                <span class="c1">#    --no-restart) anyway.</span>
                <span class="c1">#  2. A cluster may show as UP but is manually stopped in the</span>
                <span class="c1">#    UI.  If Azure/GCP: ray autoscaler doesn&#39;t support reusing,</span>
                <span class="c1">#    so &#39;sky start existing&#39; will actually launch a new</span>
                <span class="c1">#    cluster with this name, leaving the original cluster</span>
                <span class="c1">#    zombied (remains as stopped in the cloud&#39;s UI).</span>
                <span class="c1">#</span>
                <span class="c1">#    This is dangerous and unwanted behavior!</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> already has status UP.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">assert</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">global_user_state</span><span class="o">.</span><span class="n">ClusterStatus</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span>
                <span class="n">global_user_state</span><span class="o">.</span><span class="n">ClusterStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">),</span> <span class="n">record</span>
            <span class="n">to_start</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;handle&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;handle&#39;</span><span class="p">]})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">to_start</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># FIXME: Assumes a specific backend.</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">cloud_vm_ray_backend</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">to_start</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;handle&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">sky</span><span class="o">.</span><span class="n">Dag</span><span class="p">():</span>
            <span class="n">dummy_task</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span><span class="o">.</span><span class="n">set_resources</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="p">)</span>
            <span class="n">dummy_task</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">launched_nodes</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting cluster </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">provision</span><span class="p">(</span><span class="n">dummy_task</span><span class="p">,</span>
                          <span class="n">to_provision</span><span class="o">=</span><span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="p">,</span>
                          <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">stream_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">cluster_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> started.&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Tear down all existing clusters.&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">down</span><span class="p">(</span>
        <span class="n">clusters</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="nb">all</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tear down cluster(s).</span>

<span class="sd">    CLUSTER is the name of the cluster to tear down.  If both CLUSTER and --all</span>
<span class="sd">    are supplied, the latter takes precedence.</span>

<span class="sd">    Accelerators (e.g., TPU) that are part of the cluster will be deleted too.</span>

<span class="sd">    Limitation: this does not work for stopped clusters for now.</span>

<span class="sd">    Examples:</span>

<span class="sd">      \b</span>
<span class="sd">      # Tear down a specific cluster.</span>
<span class="sd">      sky down cluster_name</span>

<span class="sd">      \b</span>
<span class="sd">      # Tear down multiple clusters.</span>
<span class="sd">      sky down cluster1 cluster2</span>

<span class="sd">      \b</span>
<span class="sd">      # Tear down all existing clusters.</span>
<span class="sd">      sky down -a</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># TODO(suquark,zongheng): try using aws cli to terminate stopped nodes:</span>
    <span class="c1"># aws ec2 describe-instances --query &#39;Reservations[].Instances[].InstanceId&#39; --filters &quot;Name=tag:ray-cluster-name,Values=&lt;cluster_name&gt;&quot; --output text  # pylint: disable=line-too-long</span>
    <span class="c1"># Tricky cases to test:</span>
    <span class="c1">#   - Does the above only query the default region? Test on a stopped</span>
    <span class="c1">#     cluster in a non-default region.</span>
    <span class="c1">#   - Is it possible for Ray to launch a same-name cluster on two regions?</span>
    <span class="c1">#     If so, what happens with the above call?</span>
    <span class="c1"># Tracked by Issue #240.</span>
    <span class="k">for</span> <span class="n">cluster_name</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">cluster_status</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_status_from_cluster_name</span><span class="p">(</span>
            <span class="n">cluster_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_status</span> <span class="o">==</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">ClusterStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Cannot terminate cluster </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">!r}</span><span class="s1"> because it &#39;</span>
                <span class="s1">&#39;is STOPPED. To fix: manually terminate in the cloud</span><span class="se">\&#39;</span><span class="s1">s &#39;</span>
                <span class="s1">&#39;UI. (This limitation will be addressed in the future.)&#39;</span><span class="p">,</span>
                <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">_terminate_or_stop_clusters</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">apply_to_all</span><span class="o">=</span><span class="nb">all</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_terminate_or_stop_clusters</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">apply_to_all</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
                                <span class="n">terminate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Terminates or stops a cluster (or all clusters).&quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span> <span class="k">if</span> <span class="n">terminate</span> <span class="k">else</span> <span class="s1">&#39;stop&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span> <span class="ow">and</span> <span class="n">apply_to_all</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;sky </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s1"> requires either a cluster name (see `sky status`) &#39;</span>
            <span class="s1">&#39;or --all.&#39;</span><span class="p">)</span>

    <span class="n">to_down</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_handle_from_cluster_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">to_down</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;handle&#39;</span><span class="p">:</span> <span class="n">handle</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> not found.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apply_to_all</span><span class="p">:</span>
        <span class="n">to_down</span> <span class="o">=</span> <span class="n">global_user_state</span><span class="o">.</span><span class="n">get_clusters</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Both --all and cluster(s) specified for sky </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s1">. &#39;</span>
                  <span class="s1">&#39;Letting --all take effect.&#39;</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">to_down</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No existing clusters found (see `sky status`).&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">to_down</span><span class="p">:</span>  <span class="c1"># TODO: parallelize.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;handle&#39;</span><span class="p">]</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">backend_utils</span><span class="o">.</span><span class="n">get_backend_from_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">backends</span><span class="o">.</span><span class="n">CloudVmRayBackend</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">launched_resources</span><span class="o">.</span><span class="n">use_spot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">terminate</span><span class="p">):</span>
            <span class="c1"># TODO(suquark): enable GCP+spot to be stopped in the future.</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Stopping cluster </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">... skipped, because spot instances &#39;</span>
                <span class="s1">&#39;may lose attached volumes. &#39;</span><span class="p">,</span>
                <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;  To terminate the cluster, run: &#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sky down </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">teardown</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="n">terminate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">terminate</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Terminating cluster </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">...done.&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stopping cluster </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">...done.&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;  To restart the cluster, run: &#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sky start </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="nd">@_interactive_node_cli_command</span>
<span class="k">def</span> <span class="nf">gpunode</span><span class="p">(</span><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port_forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="n">cloud</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">instance_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">gpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">spot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">screen</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
            <span class="n">tmux</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Launch or attach to an interactive GPU node.</span>

<span class="sd">    Example:</span>

<span class="sd">      \b</span>
<span class="sd">      # Launch a default gpunode.</span>
<span class="sd">      $ sky gpunode</span>

<span class="sd">      \b</span>
<span class="sd">      # Do work, then log out.  The node is kept running.</span>

<span class="sd">      \b</span>
<span class="sd">      # Attach back to the same node and do more work.</span>
<span class="sd">      $ sky gpunode</span>

<span class="sd">      \b</span>
<span class="sd">      # Alternatively, create multiple interactive nodes by specifying names</span>
<span class="sd">      # via --cluster (-c).</span>
<span class="sd">      $ sky gpunode -c node0</span>
<span class="sd">      $ sky gpunode -c node1</span>

<span class="sd">      \b</span>
<span class="sd">      # Port forward.</span>
<span class="sd">      sky gpunode --port-forward 8080 --port-forward 4650 -c cluster_name</span>
<span class="sd">      sky gpunode -p 8080 -p 4650 -c cluster_name</span>

<span class="sd">      \b</span>
<span class="sd">      # Sync current working directory to ~/workdir on the node.</span>
<span class="sd">      rsync -r . cluster_name:~/workdir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Factor out the shared logic below for [gpu|cpu|tpu]node.</span>
    <span class="k">if</span> <span class="n">screen</span> <span class="ow">and</span> <span class="n">tmux</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Cannot use both screen and tmux.&#39;</span><span class="p">)</span>

    <span class="n">session_manager</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">screen</span> <span class="ow">or</span> <span class="n">tmux</span><span class="p">:</span>
        <span class="n">session_manager</span> <span class="o">=</span> <span class="s1">&#39;tmux&#39;</span> <span class="k">if</span> <span class="n">tmux</span> <span class="k">else</span> <span class="s1">&#39;screen&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">cluster</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_default_interactive_node_name</span><span class="p">(</span><span class="s1">&#39;gpunode&#39;</span><span class="p">)</span>

    <span class="n">user_requested_resources</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cloud</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">instance_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                                    <span class="n">gpus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">default_resources</span> <span class="o">=</span> <span class="n">_INTERACTIVE_NODE_DEFAULT_RESOURCES</span><span class="p">[</span><span class="s1">&#39;gpunode&#39;</span><span class="p">]</span>
    <span class="n">cloud_provider</span> <span class="o">=</span> <span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cloud</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Cloud </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">cloud</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> is not supported. &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Supported clouds: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="n">_parse_accelerator_options</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">instance_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use this request if both gpus and instance_type are not specified.</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">accelerators</span>
        <span class="n">instance_type</span> <span class="o">=</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">instance_type</span>
    <span class="k">if</span> <span class="n">spot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spot</span> <span class="o">=</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">use_spot</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="n">cloud_provider</span><span class="p">,</span>
                              <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">,</span>
                              <span class="n">accelerators</span><span class="o">=</span><span class="n">gpus</span><span class="p">,</span>
                              <span class="n">use_spot</span><span class="o">=</span><span class="n">spot</span><span class="p">)</span>

    <span class="n">_create_and_ssh_into_node</span><span class="p">(</span>
        <span class="s1">&#39;gpunode&#39;</span><span class="p">,</span>
        <span class="n">resources</span><span class="p">,</span>
        <span class="n">cluster_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">port_forward</span><span class="o">=</span><span class="n">port_forward</span><span class="p">,</span>
        <span class="n">session_manager</span><span class="o">=</span><span class="n">session_manager</span><span class="p">,</span>
        <span class="n">user_requested_resources</span><span class="o">=</span><span class="n">user_requested_resources</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@_interactive_node_cli_command</span>
<span class="k">def</span> <span class="nf">cpunode</span><span class="p">(</span><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port_forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="n">cloud</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">instance_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">spot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">screen</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">tmux</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Launch or attach to an interactive CPU node.</span>

<span class="sd">    Example:</span>

<span class="sd">      \b</span>
<span class="sd">      # Launch a default cpunode.</span>
<span class="sd">      $ sky cpunode</span>

<span class="sd">      \b</span>
<span class="sd">      # Do work, then log out.  The node is kept running.</span>

<span class="sd">      \b</span>
<span class="sd">      # Attach back to the same node and do more work.</span>
<span class="sd">      $ sky cpunode</span>

<span class="sd">      \b</span>
<span class="sd">      # Alternatively, create multiple interactive nodes by specifying names</span>
<span class="sd">      # via --cluster (-c).</span>
<span class="sd">      $ sky cpunode -c node0</span>
<span class="sd">      $ sky cpunode -c node1</span>

<span class="sd">      \b</span>
<span class="sd">      # Port forward.</span>
<span class="sd">      sky cpunode --port-forward 8080 --port-forward 4650 -c cluster_name</span>
<span class="sd">      sky cpunode -p 8080 -p 4650 -c cluster_name</span>

<span class="sd">      \b</span>
<span class="sd">      # Sync current working directory to ~/workdir on the node.</span>
<span class="sd">      rsync -r . cluster_name:~/workdir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">screen</span> <span class="ow">and</span> <span class="n">tmux</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Cannot use both screen and tmux.&#39;</span><span class="p">)</span>

    <span class="n">session_manager</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">screen</span> <span class="ow">or</span> <span class="n">tmux</span><span class="p">:</span>
        <span class="n">session_manager</span> <span class="o">=</span> <span class="s1">&#39;tmux&#39;</span> <span class="k">if</span> <span class="n">tmux</span> <span class="k">else</span> <span class="s1">&#39;screen&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">cluster</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_default_interactive_node_name</span><span class="p">(</span><span class="s1">&#39;cpunode&#39;</span><span class="p">)</span>

    <span class="n">user_requested_resources</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cloud</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">instance_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                                    <span class="n">spot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">default_resources</span> <span class="o">=</span> <span class="n">_INTERACTIVE_NODE_DEFAULT_RESOURCES</span><span class="p">[</span><span class="s1">&#39;cpunode&#39;</span><span class="p">]</span>
    <span class="n">cloud_provider</span> <span class="o">=</span> <span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cloud</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Cloud </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">cloud</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> is not supported. &#39;</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s1">&#39;Supported clouds: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">clouds</span><span class="o">.</span><span class="n">CLOUD_REGISTRY</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">instance_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">instance_type</span> <span class="o">=</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">instance_type</span>
    <span class="k">if</span> <span class="n">spot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spot</span> <span class="o">=</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">use_spot</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="n">cloud_provider</span><span class="p">,</span>
                              <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">,</span>
                              <span class="n">use_spot</span><span class="o">=</span><span class="n">spot</span><span class="p">)</span>

    <span class="n">_create_and_ssh_into_node</span><span class="p">(</span>
        <span class="s1">&#39;cpunode&#39;</span><span class="p">,</span>
        <span class="n">resources</span><span class="p">,</span>
        <span class="n">cluster_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">port_forward</span><span class="o">=</span><span class="n">port_forward</span><span class="p">,</span>
        <span class="n">session_manager</span><span class="o">=</span><span class="n">session_manager</span><span class="p">,</span>
        <span class="n">user_requested_resources</span><span class="o">=</span><span class="n">user_requested_resources</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@_interactive_node_cli_command</span>
<span class="k">def</span> <span class="nf">tpunode</span><span class="p">(</span><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port_forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="n">instance_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">tpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">spot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">screen</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">tmux</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Launch or attach to an interactive TPU node.</span>

<span class="sd">    Example:</span>

<span class="sd">      \b</span>
<span class="sd">      # Launch a default tpunode.</span>
<span class="sd">      $ sky tpunode</span>

<span class="sd">      \b</span>
<span class="sd">      # Do work, then log out.  The node is kept running.</span>

<span class="sd">      \b</span>
<span class="sd">      # Attach back to the same node and do more work.</span>
<span class="sd">      $ sky tpunode</span>

<span class="sd">      \b</span>
<span class="sd">      # Alternatively, create multiple interactive nodes by specifying names</span>
<span class="sd">      # via --cluster (-c).</span>
<span class="sd">      $ sky tpunode -c node0</span>
<span class="sd">      $ sky tpunode -c node1</span>

<span class="sd">      \b</span>
<span class="sd">      # Port forward.</span>
<span class="sd">      sky tpunode --port-forward 8080 --port-forward 4650 -c cluster_name</span>
<span class="sd">      sky tpunode -p 8080 -p 4650 -c cluster_name</span>

<span class="sd">      \b</span>
<span class="sd">      # Sync current working directory to ~/workdir on the node.</span>
<span class="sd">      rsync -r . cluster_name:~/workdir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">screen</span> <span class="ow">and</span> <span class="n">tmux</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Cannot use both screen and tmux.&#39;</span><span class="p">)</span>

    <span class="n">session_manager</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">screen</span> <span class="ow">or</span> <span class="n">tmux</span><span class="p">:</span>
        <span class="n">session_manager</span> <span class="o">=</span> <span class="s1">&#39;tmux&#39;</span> <span class="k">if</span> <span class="n">tmux</span> <span class="k">else</span> <span class="s1">&#39;screen&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">cluster</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_default_interactive_node_name</span><span class="p">(</span><span class="s1">&#39;tpunode&#39;</span><span class="p">)</span>

    <span class="n">user_requested_resources</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instance_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tpus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                                    <span class="n">spot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">default_resources</span> <span class="o">=</span> <span class="n">_INTERACTIVE_NODE_DEFAULT_RESOURCES</span><span class="p">[</span><span class="s1">&#39;tpunode&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">instance_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">instance_type</span> <span class="o">=</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">instance_type</span>
    <span class="k">if</span> <span class="n">tpus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tpus</span> <span class="o">=</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">accelerators</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tpus</span> <span class="o">=</span> <span class="n">_parse_accelerator_options</span><span class="p">(</span><span class="n">tpus</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spot</span> <span class="o">=</span> <span class="n">default_resources</span><span class="o">.</span><span class="n">use_spot</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">Resources</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="n">sky</span><span class="o">.</span><span class="n">GCP</span><span class="p">(),</span>
                              <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">,</span>
                              <span class="n">accelerators</span><span class="o">=</span><span class="n">tpus</span><span class="p">,</span>
                              <span class="n">use_spot</span><span class="o">=</span><span class="n">spot</span><span class="p">)</span>

    <span class="n">_create_and_ssh_into_node</span><span class="p">(</span>
        <span class="s1">&#39;tpunode&#39;</span><span class="p">,</span>
        <span class="n">resources</span><span class="p">,</span>
        <span class="n">cluster_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">port_forward</span><span class="o">=</span><span class="n">port_forward</span><span class="p">,</span>
        <span class="n">session_manager</span><span class="o">=</span><span class="n">session_manager</span><span class="p">,</span>
        <span class="n">user_requested_resources</span><span class="o">=</span><span class="n">user_requested_resources</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Determines a set of clouds that Sky will use.</span>

<span class="sd">    It checks access credentials for AWS, Azure and GCP. Sky tasks will only</span>
<span class="sd">    run in clouds that you have access to. After configuring access for a</span>
<span class="sd">    cloud, rerun `sky init` to reflect the changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sky_init</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>


<div class="viewcode-block" id="show_gpus"><a class="viewcode-back" href="../../sky.html#sky.cli.show_gpus">[docs]</a><span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;gpu_name&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">,</span>
              <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
              <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show details of all GPU/TPU/accelerator offerings.&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_gpus</span><span class="p">(</span><span class="n">gpu_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">all</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
    <span class="sd">&quot;&quot;&quot;List GPU/TPU/accelerators supported by Sky.</span>

<span class="sd">    To show what cloud offers a GPU/TPU type, use `sky show-gpus &lt;gpu&gt;`.</span>

<span class="sd">    To show all GPUs, including less common ones and their detailed</span>
<span class="sd">    information, use `sky show-gpus --all`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">show_all</span> <span class="o">=</span> <span class="nb">all</span>
    <span class="k">if</span> <span class="n">show_all</span> <span class="ow">and</span> <span class="n">gpu_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;--all is only allowed without a GPU name.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_list_to_str</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_output</span><span class="p">():</span>
        <span class="n">gpu_table</span> <span class="o">=</span> <span class="n">util_lib</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;NVIDIA_GPU&#39;</span><span class="p">,</span> <span class="s1">&#39;AVAILABLE_QUANTITIES&#39;</span><span class="p">])</span>
        <span class="n">tpu_table</span> <span class="o">=</span> <span class="n">util_lib</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;GOOGLE_TPU&#39;</span><span class="p">,</span> <span class="s1">&#39;AVAILABLE_QUANTITIES&#39;</span><span class="p">])</span>
        <span class="n">other_table</span> <span class="o">=</span> <span class="n">util_lib</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;OTHER_GPU&#39;</span><span class="p">,</span> <span class="s1">&#39;AVAILABLE_QUANTITIES&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">gpu_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">service_catalog</span><span class="o">.</span><span class="n">list_accelerator_counts</span><span class="p">(</span><span class="n">gpus_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># NVIDIA GPUs</span>
            <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">service_catalog</span><span class="o">.</span><span class="n">get_common_gpus</span><span class="p">():</span>
                <span class="n">gpu_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">gpu</span><span class="p">,</span> <span class="n">_list_to_str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">gpu</span><span class="p">))])</span>
            <span class="k">yield from</span> <span class="n">gpu_table</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>

            <span class="c1"># Google TPUs</span>
            <span class="k">for</span> <span class="n">tpu</span> <span class="ow">in</span> <span class="n">service_catalog</span><span class="o">.</span><span class="n">get_tpus</span><span class="p">():</span>
                <span class="n">tpu_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">tpu</span><span class="p">,</span> <span class="n">_list_to_str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tpu</span><span class="p">))])</span>
            <span class="k">yield from</span> <span class="n">tpu_table</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>

            <span class="c1"># Other GPUs</span>
            <span class="k">if</span> <span class="n">show_all</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">other_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">gpu</span><span class="p">,</span> <span class="n">_list_to_str</span><span class="p">(</span><span class="n">qty</span><span class="p">)])</span>
                <span class="k">yield from</span> <span class="n">other_table</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c1"># Show detailed accelerator information</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">service_catalog</span><span class="o">.</span><span class="n">list_accelerators</span><span class="p">(</span><span class="n">gpus_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                   <span class="n">name_filter</span><span class="o">=</span><span class="n">gpu_name</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">accelerator_table</span> <span class="o">=</span> <span class="n">util_lib</span><span class="o">.</span><span class="n">create_table</span><span class="p">([</span>
                <span class="s1">&#39;GPU&#39;</span><span class="p">,</span>
                <span class="s1">&#39;QTY&#39;</span><span class="p">,</span>
                <span class="s1">&#39;CLOUD&#39;</span><span class="p">,</span>
                <span class="s1">&#39;INSTANCE_TYPE&#39;</span><span class="p">,</span>
                <span class="s1">&#39;HOST_MEMORY&#39;</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">instance_type_str</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">instance_type</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">instance_type</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;(*)&#39;</span>
                <span class="n">mem_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">memory</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">GB&#39;</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">memory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;(*)&#39;</span>
                <span class="n">accelerator_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">accelerator_name</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">accelerator_count</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span>
                    <span class="n">instance_type_str</span><span class="p">,</span> <span class="n">mem_str</span>
                <span class="p">])</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">gpu_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="k">yield from</span> <span class="n">accelerator_table</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">show_all</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo_via_pager</span><span class="p">(</span><span class="n">_output</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">_output</span><span class="p">():</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">()</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../sky.html#sky.cli.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">cli</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By the Sky authors<br/>
    
        &copy; Copyright 2022, Sky Team.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>