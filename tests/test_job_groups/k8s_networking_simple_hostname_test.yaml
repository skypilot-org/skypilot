# Simple hostname networking test
# Tests that BOTH hostname formats work:
# 1. Simple hostname: {job_name}-{node_idx}.{job_group_name}
# 2. Environment variable: {job_name}-{node_idx}.${SKYPILOT_JOBGROUP_NAME}
---
name: simple-hostname-test
placement: SAME_INFRA
execution: parallel
---
name: api-server
resources:
  cpus: 2
  infra: kubernetes
run: |
  echo "API Server starting on $(hostname)"
  echo "JobGroup name: ${SKYPILOT_JOBGROUP_NAME}"

  # Start HTTP server on port 9000
  python3 -m http.server 9000 &
  SERVER_PID=$!

  # Keep running
  for i in {1..12}; do
    echo "API Server heartbeat $i"
    sleep 5
  done

  kill $SERVER_PID 2>/dev/null || true
  echo "API Server done"
---
name: api-client
resources:
  cpus: 2
  infra: kubernetes
run: |
  echo "API Client starting"
  echo "JobGroup name: ${SKYPILOT_JOBGROUP_NAME}"

  sleep 10

  # Test 1: Using SIMPLE HOSTNAME (hardcoded job group name)
  echo "=== Test 1: Simple hostname format ==="
  SIMPLE_HOST="api-server-0.simple-hostname-test"
  echo "Testing simple hostname: $SIMPLE_HOST"

  getent hosts $SIMPLE_HOST && echo "DNS resolution: SUCCESS" || echo "DNS resolution: FAILED"
  echo "Hosts file entries for api-server:"
  cat /etc/hosts | grep -i api-server || echo "No api-server in /etc/hosts"

  SIMPLE_CONNECTED=false
  for i in {1..5}; do
    if curl -s --connect-timeout 5 http://$SIMPLE_HOST:9000/ > /dev/null 2>&1; then
      echo "Test 1 PASSED: Connected using simple hostname on attempt $i"
      SIMPLE_CONNECTED=true
      break
    fi
    echo "Attempt $i: waiting..."
    sleep 2
  done

  if [ "$SIMPLE_CONNECTED" = "false" ]; then
    echo "Test 1 FAILED: Could not connect using simple hostname"
  fi

  # Test 2: Using ENVIRONMENT VARIABLE
  echo ""
  echo "=== Test 2: Environment variable format ==="
  ENV_HOST="api-server-0.${SKYPILOT_JOBGROUP_NAME}"
  echo "Testing env var hostname: $ENV_HOST"

  getent hosts $ENV_HOST && echo "DNS resolution: SUCCESS" || echo "DNS resolution: FAILED"

  ENV_CONNECTED=false
  for i in {1..5}; do
    if curl -s --connect-timeout 5 http://$ENV_HOST:9000/ > /dev/null 2>&1; then
      echo "Test 2 PASSED: Connected using env var hostname on attempt $i"
      ENV_CONNECTED=true
      break
    fi
    echo "Attempt $i: waiting..."
    sleep 2
  done

  if [ "$ENV_CONNECTED" = "false" ]; then
    echo "Test 2 FAILED: Could not connect using env var hostname"
  fi

  # Test 3: Verify both resolve to the same IP
  echo ""
  echo "=== Test 3: IP verification ==="
  SIMPLE_IP=$(getent hosts $SIMPLE_HOST 2>/dev/null | awk '{print $1}')
  ENV_IP=$(getent hosts $ENV_HOST 2>/dev/null | awk '{print $1}')
  echo "Simple hostname IP: $SIMPLE_IP"
  echo "Env var hostname IP: $ENV_IP"

  if [ "$SIMPLE_IP" = "$ENV_IP" ] && [ -n "$SIMPLE_IP" ]; then
    echo "Test 3 PASSED: Both hostnames resolve to same IP ($SIMPLE_IP)"
  else
    echo "Test 3 WARNING: IPs differ or empty (simple=$SIMPLE_IP, env=$ENV_IP)"
  fi

  # Final summary
  echo ""
  echo "=== Summary ==="
  echo "Simple hostname connected: $SIMPLE_CONNECTED"
  echo "Env var hostname connected: $ENV_CONNECTED"

  if [ "$SIMPLE_CONNECTED" = "true" ] && [ "$ENV_CONNECTED" = "true" ]; then
    echo "SUCCESS: All networking tests passed"
    exit 0
  else
    echo "FAILED: Some networking tests failed"
    exit 1
  fi
