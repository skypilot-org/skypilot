---
name: k8s-network-test
placement: SAME_INFRA
execution: parallel
---
name: server
resources:
  cpus: 2
  infra: kubernetes
run: |
  echo "Server starting on $(hostname)"
  echo "JobGroup: ${SKYPILOT_JOBGROUP_NAME}"

  # Start a simple HTTP server
  python3 -m http.server 8080 &
  SERVER_PID=$!

  # Keep running for client to connect
  sleep 60

  # Cleanup
  kill $SERVER_PID 2>/dev/null || true
  echo "Server done"
---
name: client
resources:
  cpus: 2
  infra: kubernetes
run: |
  echo "Client starting on $(hostname)"
  echo "JobGroup: ${SKYPILOT_JOBGROUP_NAME}"

  # Wait for server to start
  sleep 10

  # Test DNS resolution
  echo "Testing DNS resolution..."
  SERVER_HOST="server-0.${SKYPILOT_JOBGROUP_NAME}"
  echo "Server host: $SERVER_HOST"

  # Try to resolve the hostname
  getent hosts $SERVER_HOST || echo "DNS lookup failed, checking /etc/hosts"
  cat /etc/hosts | grep -i server || echo "No server entry in /etc/hosts"

  # Try to connect to server
  echo "Attempting connection to server..."
  for i in {1..10}; do
    if curl -s --connect-timeout 5 http://$SERVER_HOST:8080/ > /dev/null 2>&1; then
      echo "SUCCESS: Connected to server on attempt $i"
      exit 0
    fi
    echo "Attempt $i failed, retrying..."
    sleep 3
  done

  echo "FAILED: Could not connect to server"
  exit 1
