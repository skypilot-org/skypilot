# RL Experiment Architecture Test (CPU-only, scaled down)
# Tests the heterogeneous workload pattern from the JobGroup design document
# with trainer, data-processor, replay-buffer, and env-worker components

---
name: rl-cpu-test
placement: SAME_INFRA
execution: parallel
---
name: trainer
resources:
  cpus: 2
  memory: 4+
  infra: kubernetes
run: |
  echo "Trainer starting"
  echo "JobGroup: ${SKYPILOT_JOBGROUP_NAME}"
  echo "Replay buffer: replay-buffer-0.${SKYPILOT_JOBGROUP_NAME}"

  # Try connecting to replay buffer
  sleep 10
  if getent hosts "replay-buffer-0.${SKYPILOT_JOBGROUP_NAME}" > /dev/null 2>&1; then
    echo "SUCCESS: Can resolve replay-buffer hostname"
  else
    echo "WARNING: Cannot resolve replay-buffer hostname"
  fi

  # Simulate training
  for i in {1..5}; do
    echo "Training iteration $i"
    sleep 3
  done
  echo "Trainer done"
---
name: data-processor
resources:
  cpus: 2
  memory: 4+
  infra: kubernetes
run: |
  echo "Data processor starting"
  echo "JobGroup: ${SKYPILOT_JOBGROUP_NAME}"
  echo "Output to: replay-buffer-0.${SKYPILOT_JOBGROUP_NAME}"

  # Simulate data processing
  for i in {1..4}; do
    echo "Processing batch $i"
    sleep 3
  done
  echo "Data processor done"
---
name: replay-buffer
resources:
  cpus: 2
  memory: 8+
  infra: kubernetes
run: |
  echo "Replay buffer starting on $(hostname)"
  echo "JobGroup: ${SKYPILOT_JOBGROUP_NAME}"

  # Start a simple TCP listener to simulate Redis
  python3 -m http.server 6379 &
  SERVER_PID=$!

  # Keep running longer than other jobs
  for i in {1..8}; do
    echo "Replay buffer heartbeat $i"
    sleep 3
  done

  kill $SERVER_PID 2>/dev/null || true
  echo "Replay buffer done"
---
name: env-worker
resources:
  cpus: 2
  memory: 4+
  infra: kubernetes
run: |
  echo "Env worker starting"
  echo "JobGroup: ${SKYPILOT_JOBGROUP_NAME}"
  echo "Trainer addr: trainer-0.${SKYPILOT_JOBGROUP_NAME}"

  # Try connecting to trainer
  sleep 10
  if getent hosts "trainer-0.${SKYPILOT_JOBGROUP_NAME}" > /dev/null 2>&1; then
    echo "SUCCESS: Can resolve trainer hostname"
  else
    echo "WARNING: Cannot resolve trainer hostname"
  fi

  # Simulate environment execution
  for i in {1..5}; do
    echo "Environment step $i"
    sleep 3
  done
  echo "Env worker done"
