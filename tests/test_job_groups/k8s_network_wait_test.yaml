# Network wait script verification test
# Tests that jobs wait for DNS resolution before starting
---
name: k8s-network-wait-test
placement: SAME_INFRA
execution: parallel
---
name: slow-starter
resources:
  cpus: 2
  infra: kubernetes
setup: |
  # Simulate slow setup
  echo "Slow starter setup beginning..."
  sleep 30
  echo "Slow starter setup complete"
run: |
  echo "Slow starter running on $(hostname)"
  echo "JobGroup: ${SKYPILOT_JOBGROUP_NAME}"
  echo "Starting HTTP server on port 8080..."
  python3 -m http.server 8080 &
  SERVER_PID=$!
  echo "Server started with PID $SERVER_PID"

  # Keep running
  for i in {1..12}; do
    echo "Slow starter heartbeat $i"
    sleep 5
  done

  kill $SERVER_PID 2>/dev/null || true
  echo "Slow starter done"
---
name: fast-waiter
resources:
  cpus: 2
  infra: kubernetes
run: |
  echo "Fast waiter starting on $(hostname)"
  echo "JobGroup: ${SKYPILOT_JOBGROUP_NAME}"
  echo "Checking if slow-starter is reachable..."

  # The network wait script should have already waited for DNS
  # before this run command starts
  SERVER_HOST="slow-starter-0.${SKYPILOT_JOBGROUP_NAME}"
  echo "Target server: $SERVER_HOST"

  # Check DNS resolution
  echo "DNS resolution check:"
  getent hosts $SERVER_HOST || echo "DNS lookup via getent failed"
  cat /etc/hosts | grep -i slow-starter || echo "No slow-starter in /etc/hosts"

  # Try to connect to server
  echo "Attempting HTTP connection..."
  for i in {1..20}; do
    if curl -s --connect-timeout 5 http://$SERVER_HOST:8080/ > /dev/null 2>&1; then
      echo "SUCCESS: Connected to slow-starter on attempt $i"
      echo "Fast waiter completed successfully"
      exit 0
    fi
    echo "Attempt $i: Server not ready yet, waiting..."
    sleep 3
  done

  echo "FAILED: Could not connect to slow-starter after 20 attempts"
  exit 1
