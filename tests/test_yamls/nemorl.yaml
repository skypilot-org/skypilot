# Runs the DPO example from NeMo RL repository

resources:
  instance_type: g6.4xlarge
  infra: aws/ap-northeast-1
  network_tier: best

num_nodes: 2

setup: |
  sudo apt update
  # Install libibverbs-dev for InfiniBand support
  sudo apt install -y git libibverbs-dev python3-dev

  # Set up NeMo RL
  git clone https://github.com/NVIDIA-NeMo/RL nemo-rl
  cd nemo-rl
  git checkout ee8f5aa75a7c8ab070a460f49b5fcf226c5b3018
  git submodule update --init --recursive
  uv venv
  # Build flash-attn and warm the uv cache before first run
  bash tools/build-flash-attn-in-uv-cache.sh
  cd ..

run: |
  set -e
  sudo chmod 777 -R /var/tmp
  cd nemo-rl
  head_ip=`echo "$SKYPILOT_NODE_IPS" | head -n1`
  num_nodes=`echo "$SKYPILOT_NODE_IPS" | wc -l`
  if [ "$SKYPILOT_NODE_RANK" == "0" ]; then
    ps aux | grep ray | grep 6379 &> /dev/null || uv run ray start --head --disable-usage-stats --port 6379
    sleep 5
    uv run ray status
    uv run python examples/run_dpo.py  \
      policy.model_name="Qwen/Qwen3-0.6B" \
      policy.tokenizer.name="Qwen/Qwen3-0.6B" \
      cluster.gpus_per_node=${SKYPILOT_NUM_GPUS_PER_NODE} \
      cluster.num_nodes=${SKYPILOT_NUM_NODES} \
      dpo.val_global_batch_size=1 \
      dpo.max_num_steps=1 \
      checkpointing.checkpoint_dir='results/dpo_qwen3_0.6b'
  else
    sleep 5
    ps aux | grep ray | grep 6379 &> /dev/null || uv run ray start --address $head_ip:6379 --disable-usage-stats
    # Add sleep to after `ray start` to give ray enough time to daemonize
    sleep 5
  fi
