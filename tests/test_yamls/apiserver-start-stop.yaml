resources:
    cpus: 4+
    memory: 8+

workdir: .

setup: |
  set -e
  sudo apt update
  uv pip install --system --prerelease allow azure-cli
  uv pip install --system -e '.[all]'

run: |
  set -euo pipefail
  set -x
  for i in {1..20}; do
    sky api start &
    sky api stop &
    sky api start &
    sky api stop &
    wait
    # We now either in a clean stopped state or in a clean running state
    sky api start
    # Thus the following command should always succeed
    sky api status
    if sky api status | grep -q "PENDING"; then
      echo "Found request pending"
      exit 1
    fi
    sky launch --dryrun -y
    sky api stop
  done
