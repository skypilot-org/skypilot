#!/usr/bin/env python3
"""
Schema-based test data generator for SkyPilot scale testing.

This module dynamically extracts table schemas from SkyPilot source code
and generates realistic test data without requiring existing entries.
"""

import json
import pickle
import random
import sqlite3
import time
from typing import Any, Dict, List, Optional, Tuple
import uuid

import sqlalchemy
from sqlalchemy import Float
from sqlalchemy import Integer
from sqlalchemy import LargeBinary
from sqlalchemy import Text

from sky import global_user_state


class SchemaBasedGenerator:
    """Generates test data based on database table schemas."""

    def __init__(self):
        """Initialize the generator with table schemas."""
        self.cluster_schema = self._get_table_schema(
            global_user_state.cluster_table)

    def _get_table_schema(
            self, table: sqlalchemy.Table) -> List[Tuple[str, type, Any]]:
        """Extract schema information from SQLAlchemy table."""
        schema = []
        for column in table.columns:
            col_name = column.name
            col_type = type(column.type)
            default_value = column.server_default.arg if column.server_default else None
            is_primary_key = column.primary_key
            autoincrement = getattr(column, 'autoincrement', False)
            # Convert autoincrement to boolean
            autoincrement = autoincrement is True

            schema.append((col_name, col_type, default_value, is_primary_key,
                           autoincrement))

        return schema

    def generate_cluster_data(self, count: int) -> List[Dict[str, Any]]:
        """Generate test data for clusters table using real cluster template."""
        clusters = []

        # Template based on real cluster
        template = {
            'name': '',  # Will be overridden
            'launched_at': 0,
            'handle': bytes.fromhex(
                '80049521180000000000008C21736B792E6261636B656E64732E636C6F75645F766D5F7261795F6261636B656E64948C18436C6F7564566D5261795265736F7572636548616E646C659493942981947D94288C085F76657273696F6E944B0C8C0C636C75737465725F6E616D65948C11736B792D623564342D72736F6E65636861948C15636C75737465725F6E616D655F6F6E5F636C6F7564948C1A736B792D623564342D72736F6E656368612D3561353862613564948C0D5F636C75737465725F79616D6C948C267E2F2E736B792F67656E6572617465642F736B792D623564342D72736F6E656368612E796D6C948C1C737461626C655F696E7465726E616C5F65787465726E616C5F697073945D948C0A31302E302E35372E383694680E8694618C10737461626C655F7373685F706F727473945D944B16618C136361636865645F636C75737465725F696E666F948C14736B792E70726F766973696F6E2E636F6D6D6F6E948C0B436C7573746572496E666F9493942981947D94288C09696E7374616E636573947D948C1F736B792D623564342D72736F6E656368612D35613538626135642D68656164945D9468138C0C496E7374616E6365496E666F9493942981947D94288C0B696E7374616E63655F696494681A8C0B696E7465726E616C5F697094680E8C0B65787465726E616C5F6970944E8C0474616773947D94288C09636F6D706F6E656E74948C1F736B792D623564342D72736F6E656368612D35613538626135642D68656164948C06706172656E74948C08736B7970696C6F74948C107261792D636C75737465722D6E616D65948C1A736B792D623564342D72736F6E656368612D3561353862613564948C0D7261792D6E6F64652D74797065948C0468656164948C10736B7970696C6F742D636C7573746572948C1A736B792D623564342D72736F6E656368612D3561353862613564948C15736B7970696C6F742D636C75737465722D6E616D65948C1A736B792D623564342D72736F6E656368612D3561353862613564948C12736B7970696C6F742D686561642D6E6F6465948C0131948C11736B7970696C6F742D7373682D6A756D70948C10736B792D7373682D6A756D702D706F64948C0D736B7970696C6F742D75736572948C0872736F6E6563686194758C087373685F706F7274944B16756261738C10686561645F696E7374616E63655F696494681A8C0D70726F76696465725F6E616D65948C0A6B756265726E65746573948C0F70726F76696465725F636F6E666967947D94288C0474797065948C0865787465726E616C948C066D6F64756C65948C18736B792E70726F766973696F6E2E6B756265726E65746573948C06726567696F6E948C0A6B756265726E65746573948C096E616D657370616365948C0764656661756C74948C07636F6E74657874948C156E65626975732D6D6B38732D726F68616E2D70726F948C09706F72745F6D6F6465948C0C6C6F616462616C616E636572948C0F6E6574776F726B696E675F6D6F6465948C0B706F7274666F7277617264948C107573655F696E7465726E616C5F69707394888C0774696D656F7574944B0A8C0E7373685F6A756D705F696D616765948C3975732D646F636B65722E706B672E6465762F736B792D6465762D3436352F736B7970696C6F746B38732F736B7970696C6F743A6C6174657374948C19736B7970696C6F745F73797374656D5F6E616D657370616365948C0F736B7970696C6F742D73797374656D948C14667573655F6465766963655F726571756972656494898C1A6175746F7363616C65725F736572766963655F6163636F756E74947D94288C0A61706956657273696F6E948C027631948C046B696E64948C0E536572766963654163636F756E74948C086D65746164617461947D94288C066C6162656C73947D948C06706172656E74948C08736B7970696C6F7494738C046E616D65948C18736B7970696C6F742D736572766963652D6163636F756E749475758C0F6175746F7363616C65725F726F6C65947D94288C046B696E64948C04526F6C65948C0A61706956657273696F6E948C1C726261632E617574686F72697A6174696F6E2E6B38732E696F2F7631948C086D65746164617461947D94288C066C6162656C73947D948C06706172656E74948C08736B7970696C6F7494738C046E616D65948C1D736B7970696C6F742D736572766963652D6163636F756E742D726F6C6594758C0572756C6573945D947D94288C0961706947726F757073945D948C012A94618C097265736F7572636573945D946873618C057665726273945D946873617561758C176175746F7363616C65725F726F6C655F62696E64696E67947D94288C0A61706956657273696F6E948C1C726261632E617574686F72697A6174696F6E2E6B38732E696F2F7631948C046B696E64948C0B526F6C6542696E64696E67948C086D65746164617461947D94288C066C6162656C73947D948C06706172656E74948C08736B7970696C6F7494738C046E616D65948C25736B7970696C6F742D736572766963652D6163636F756E742D726F6C652D62696E64696E6794758C087375626A65637473945D947D94288C046B696E64948C0E536572766963654163636F756E74948C046E616D65948C18736B7970696C6F742D736572766963652D6163636F756E749475618C07726F6C65526566947D94288C046B696E64948C04526F6C65948C046E616D65948C1D736B7970696C6F742D736572766963652D6163636F756E742D726F6C65948C0861706947726F7570948C19726261632E617574686F72697A6174696F6E2E6B38732E696F9475758C1F6175746F7363616C65725F736B7970696C6F745F73797374656D5F726F6C65947D94288C046B696E64948C04526F6C65948C0A61706956657273696F6E948C1C726261632E617574686F72697A6174696F6E2E6B38732E696F2F7631948C086D65746164617461947D94288C096E616D657370616365948C0F736B7970696C6F742D73797374656D948C066C6162656C73947D948C06706172656E74948C08736B7970696C6F7494738C046E616D65948C24736B7970696C6F742D73797374656D2D736572766963652D6163636F756E742D726F6C6594758C0572756C6573945D947D94288C0961706947726F757073945D946873618C097265736F7572636573945D946873618C057665726273945D946873617561758C276175746F7363616C65725F736B7970696C6F745F73797374656D5F726F6C655F62696E64696E67947D94288C0A61706956657273696F6E948C1C726261632E617574686F72697A6174696F6E2E6B38732E696F2F7631948C046B696E64948C0B526F6C6542696E64696E67948C086D65746164617461947D94288C096E616D657370616365948C0F736B7970696C6F742D73797374656D948C066C6162656C73947D948C06706172656E74948C08736B7970696C6F7494738C046E616D65948C2C736B7970696C6F742D73797374656D2D736572766963652D6163636F756E742D726F6C652D62696E64696E6794758C087375626A65637473945D947D94288C046B696E64948C0E536572766963654163636F756E74948C046E616D65948C18736B7970696C6F742D736572766963652D6163636F756E749475618C07726F6C65526566947D94288C046B696E64948C04526F6C65948C046E616D65948C24736B7970696C6F742D73797374656D2D736572766963652D6163636F756E742D726F6C65948C0861706947726F7570948C19726261632E617574686F72697A6174696F6E2E6B38732E696F9475758C176175746F7363616C65725F696E67726573735F726F6C65947D94288C046B696E64948C04526F6C65948C0A61706956657273696F6E948C1C726261632E617574686F72697A6174696F6E2E6B38732E696F2F7631948C086D65746164617461947D94288C096E616D657370616365948C0D696E67726573732D6E67696E78948C046E616D65948C25736B7970696C6F742D736572766963652D6163636F756E742D696E67726573732D726F6C65948C066C6162656C73947D948C06706172656E74948C08736B7970696C6F749473758C0572756C6573945D94287D94288C0961706947726F757073945D948C0094618C097265736F7572636573945D948C08736572766963657394618C057665726273945D94288C046C697374948C03676574948C0577617463689465757D94288C0961706947726F757073945D948C19726261632E617574686F72697A6174696F6E2E6B38732E696F94618C097265736F7572636573945D94288C05726F6C6573948C0C726F6C6562696E64696E677394658C057665726273945D94288C03676574948C046C697374948C057761746368948C05706174636894657565758C1F6175746F7363616C65725F696E67726573735F726F6C655F62696E64696E67947D94288C0A61706956657273696F6E948C1C726261632E617574686F72697A6174696F6E2E6B38732E696F2F7631948C046B696E64948C0B526F6C6542696E64696E67948C086D65746164617461947D94288C096E616D657370616365948C0D696E67726573732D6E67696E78948C046E616D65948C2D736B7970696C6F742D736572766963652D6163636F756E742D696E67726573732D726F6C652D62696E64696E67948C066C6162656C73947D948C06706172656E74948C08736B7970696C6F749473758C087375626A65637473945D947D94288C046B696E64948C0E536572766963654163636F756E74948C046E616D65948C18736B7970696C6F742D736572766963652D6163636F756E749475618C07726F6C65526566947D94288C046B696E64948C04526F6C65948C046E616D65948C25736B7970696C6F742D736572766963652D6163636F756E742D696E67726573732D726F6C65948C0861706947726F7570948C19726261632E617574686F72697A6174696F6E2E6B38732E696F9475758C176175746F7363616C65725F636C75737465725F726F6C65947D94288C046B696E64948C0B436C7573746572526F6C65948C0A61706956657273696F6E948C1C726261632E617574686F72697A6174696F6E2E6B38732E696F2F7631948C086D65746164617461947D94288C066C6162656C73947D948C06706172656E74948C08736B7970696C6F7494738C046E616D65948C25736B7970696C6F742D736572766963652D6163636F756E742D636C75737465722D726F6C6594758C0572756C6573945D94287D94288C0961706947726F757073945D9468E2618C097265736F7572636573945D948C056E6F64657394618C057665726273945D94288C03676574948C046C697374948C0577617463689465757D94288C0961706947726F757073945D9468E2618C097265736F7572636573945D948C0A6E616D6573706163657394618C057665726273945D94288C03676574948C046C697374948C057761746368948C066372656174659465757D94288C0961706947726F757073945D948C19726261632E617574686F72697A6174696F6E2E6B38732E696F94618C097265736F7572636573945D94288C0C636C7573746572726F6C6573948C13636C7573746572726F6C6562696E64696E677394658C057665726273945D94288C03676574948C046C697374948C057761746368948C06637265617465948C06757064617465948C057061746368948C0664656C6574659465757D94288C0961706947726F757073945D948C0B6E6F64652E6B38732E696F94618C097265736F7572636573945D948C0E72756E74696D65636C617373657394618C057665726273945D94288C03676574948C046C697374948C0577617463689465757D94288C0961706947726F757073945D948C116E6574776F726B696E672E6B38732E696F94618C097265736F7572636573945D948C0E696E6772657373636C617373657394618C057665726273945D94288C03676574948C046C697374948C05776174636894657565758C1F6175746F7363616C65725F636C75737465725F726F6C655F62696E64696E67947D94288C0A61706956657273696F6E948C1C726261632E617574686F72697A6174696F6E2E6B38732E696F2F7631948C046B696E64948C12436C7573746572526F6C6542696E64696E67948C086D65746164617461947D94288C066C6162656C73947D948C06706172656E74948C08736B7970696C6F7494738C046E616D65948C2D736B7970696C6F742D736572766963652D6163636F756E742D636C75737465722D726F6C652D62696E64696E6794758C087375626A65637473945D947D94288C046B696E64948C0E536572766963654163636F756E74948C046E616D65948C18736B7970696C6F742D736572766963652D6163636F756E749475618C07726F6C65526566947D94288C046B696E64948C0B436C7573746572526F6C65948C046E616D65948C25736B7970696C6F742D736572766963652D6163636F756E742D636C75737465722D726F6C65948C0861706947726F7570948C19726261632E617574686F72697A6174696F6E2E6B38732E696F9475758C087365727669636573945D94287D94288C0A61706956657273696F6E948C027631948C046B696E64948C0753657276696365948C086D65746164617461947D94288C066C6162656C73947D94288C06706172656E74948C08736B7970696C6F74948C10736B7970696C6F742D636C7573746572948C1A736B792D623564342D72736F6E656368612D3561353862613564948C0D736B7970696C6F742D75736572948C0872736F6E6563686194758C046E616D65948C23736B792D623564342D72736F6E656368612D35613538626135642D686561642D73736894758C0473706563947D94288C0873656C6563746F72947D948C09636F6D706F6E656E74948C1F736B792D623564342D72736F6E656368612D35613538626135642D6865616494738C05706F727473945D947D94288C0870726F746F636F6C948C03544350948C04706F7274944B168C0A746172676574506F7274944B16756175757D94288C0A61706956657273696F6E948C027631948C046B696E64948C0753657276696365948C086D65746164617461947D94288C066C6162656C73947D94288C06706172656E74948C08736B7970696C6F74948C10736B7970696C6F742D636C7573746572948C1A736B792D623564342D72736F6E656368612D3561353862613564948C0D736B7970696C6F742D75736572948C0872736F6E6563686194758C046E616D65948C1F736B792D623564342D72736F6E656368612D35613538626135642D6865616494758C0473706563947D94288C09636C75737465724950948C044E6F6E65948C0873656C6563746F72947D948C09636F6D706F6E656E74948C1F736B792D623564342D72736F6E656368612D35613538626135642D686561649473757565758C0B646F636B65725F75736572944E8C087373685F75736572948C03736B79948C12637573746F6D5F7261795F6F7074696F6E73947D94288C136F626A6563742D73746F72652D6D656D6F7279944A0065CD1D8C086E756D2D63707573948C0132947575628C0E6C61756E636865645F6E6F646573944B018C126C61756E636865645F7265736F7572636573948C0D736B792E7265736F7572636573948C095265736F75726365739493942981947D942868054B1C8C065F636C6F7564948C15736B792E636C6F7564732E6B756265726E65746573948C0A4B756265726E657465739493942981947D94628C075F726567696F6E948C156E65626975732D6D6B38732D726F68616E2D70726F948C055F7A6F6E65944E8C0E5F696E7374616E63655F74797065948C09324350552D2D324742948C135F7573655F73706F745F73706563696669656494898C095F7573655F73706F7494898C0D5F6A6F625F7265636F76657279944E8C0A5F6469736B5F73697A65944D00018C095F696D6167655F6964944E8C115F69735F696D6167655F6D616E61676564944E8C0A5F6469736B5F74696572944E8C0D5F6E6574776F726B5F74696572944E8C065F706F727473944E8C075F6C6162656C73944E8C145F646F636B65725F6C6F67696E5F636F6E666967944E8C1B5F646F636B65725F757365726E616D655F666F725F72756E706F64944E8C0E5F72657175697265735F66757365944E8C195F636C75737465725F636F6E6669675F6F7665727269646573944E8C0C5F6361636865645F72657072944E8C1A5F6E6F5F6D697373696E675F616363656C5F7761726E696E6773944E8C095F7072696F72697479944E8C055F63707573944E8C075F6D656D6F7279944E8C0D5F616363656C657261746F7273944E8C115F616363656C657261746F725F61726773944E8C105F6175746F73746F705F636F6E666967944E8C085F766F6C756D6573944E75628C0B646F636B65725F75736572944E8C0F69735F677270635F656E61626C656494888C11736B796C65745F7373685F74756E6E656C944E75622E'
            ),
            'last_use': 'sky launch --infra k8s -y',
            'status': 'UP',
            'autostop': -1,
            'to_down': 0,
            'metadata': '{}',
            'owner': '["managed-k8s"]',
            'cluster_hash': '',  # Will be overridden
            'storage_mounts_metadata': None,
            'cluster_ever_up': 1,
            'status_updated_at': 0,
            'config_hash': 'ea105adc25426c186b66673232dc59f994d57d694be98337a1711e47649bf975',
            'user_hash': '5a58ba5d',
            'workspace': 'default',
            'last_creation_yaml': '''name: sky-cmd

resources:
  infra: kubernetes
  disk_size: 256

num_nodes: 1

file_mounts: {}

volumes: {}
''',
            'last_creation_command': 'sky launch --infra k8s -y',
            'is_managed': 0,
            'provision_log_path': '',
            'skylet_ssh_tunnel_metadata': None
        }

        current_time = time.time()

        for i in range(count):
            cluster = template.copy()

            # Modify unique fields
            cluster['name'] = f"test-cluster-{i+1:04d}-{uuid.uuid4().hex[:8]}"
            cluster['cluster_hash'] = str(uuid.uuid4())
            cluster['launched_at'] = int(
                current_time - random.uniform(0, 7 * 24 * 3600))  # Last 7 days
            cluster['status_updated_at'] = int(
                current_time - random.uniform(0, 24 * 3600))  # Last day
            cluster['provision_log_path'] = f'/tmp/test_provision_{i+1}.log'

            clusters.append(cluster)

        return clusters
