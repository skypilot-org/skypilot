name: SkravlekÃ¥kÃ¥ - Format Police ğŸš¨

on:
  push:
    branches:
      - master
      - "releases/**"
  pull_request:
    branches:
      - master
      - "releases/**"
  merge_group:

jobs:
  format:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8"]

    steps:
      - name: ğŸš€ Check out the repo
        uses: actions/checkout@v3

      - name: ğŸ“¦ Install the latest version of uv (because we're cool)
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          python-version: ${{ matrix.python-version }}

      - name: ğŸ”§ Set up Python environment & install dependencies
        run: |
          echo "Creating a fancy fresh Python environment... ğŸ› ï¸"
          uv venv --seed ~/test-env
          source ~/test-env/bin/activate
          
          echo "Installing the strictest formatters known to mankind... â³"
          uv pip install yapf==0.32.0 toml==0.10.2 black==22.10.0 isort==5.12.0
          echo "Done! The repo is now under formatting surveillance. ğŸ‘€"

      - name: ğŸ” Running YAPF (Because spacing matters!)
        run: |
          source ~/test-env/bin/activate
          echo "Checking code with YAPF... ğŸ¤–"
          yapf --diff --recursive ./ --exclude 'sky/skylet/ray_patches/**' --exclude 'sky/skylet/providers/ibm/**'
          echo "YAPF is done. If it yelled at you, go fix your spacing! ğŸ“"

      - name: ğŸ¨ Running Black (Strict mode: ON)
        run: |
          source ~/test-env/bin/activate
          echo "BLACK is coming... and itâ€™s UNFORGIVING. ğŸ–¤"
          black --diff --check sky/skylet/providers/ibm/
          echo "Black is done. Your code is either perfect or crying. ğŸ’€"

      - name: ğŸ“ Running isort for Black-formatted files
        run: |
          source ~/test-env/bin/activate
          echo "Sorting imports like a pro for Black-formatted files... ğŸ“‚"
          isort --diff --check --profile black -l 88 -m 3 sky/skylet/providers/ibm/
          echo "Imports are now beautifully aligned. Zen achieved. âœ¨"

      - name: ğŸ“ Running isort for YAPF-formatted files
        run: |
          source ~/test-env/bin/activate
          echo "Sorting imports for YAPF-formatted files... âš–ï¸"
          isort --diff --check ./ --sg 'sky/skylet/ray_patches/**' --sg 'sky/skylet/providers/ibm/**'
          echo "Imports have been disciplined. Your repo thanks you. ğŸ™Œ"

      - name: âœ… All checks complete!
        run: |
          echo "ğŸ‰ Formatting and sorting are done! If there were issues, go fix 'em! ğŸ› ï¸"
          echo "Otherwise, you just passed the SkravlekÃ¥kÃ¥ Format Police. Congrats! ğŸš”ğŸ˜†"
